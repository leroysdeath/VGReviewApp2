function e(e){if("undefined"!=typeof window)try{return W[e]}catch(t){return}if("undefined"!=typeof process&&J)return J[e]}function t(e,t){if(!t||!t.trim())return e;const r=(e=>E(e)?.05:.08)(t);return e.filter(e=>{const n=((e,t)=>{if(!t||!t.trim())return 1;const r=t.toLowerCase().trim(),n=(e.name||"").toLowerCase(),i=(e.developer||"").toLowerCase(),s=(e.publisher||"").toLowerCase(),a=(e.summary||"").toLowerCase(),o=Array.isArray(e.genres)?e.genres.join(" ").toLowerCase():"";let l=0,c=0;c+=100;const u=B(r,e.name||"");if(u>.8)l+=100*u;else if(n===r)l+=100;else if(n.includes(r)||r.includes(n)){const e=Math.min(r.length,n.length)/Math.max(r.length,n.length);l+=100*e}else u>.3&&(l+=100*u*.7);if(c+=80,e.alternative_names&&Array.isArray(e.alternative_names)){let t=0;for(const n of e.alternative_names){const e=B(r,n.name||"");t=Math.max(t,e)}t>.3&&(l+=80*t)}c+=60;const d=r.split(/\s+/),h=n.split(/\s+/);let m=0;return d.forEach(e=>{h.some(t=>!(!t.includes(e)&&!e.includes(t))||B(e,t)>.6)&&m++}),d.length>0&&(l+=m/d.length*60),c+=30,d.forEach(e=>{(i.includes(e)||s.includes(e))&&(l+=30/d.length)}),c+=20,d.forEach(e=>{a.includes(e)&&(l+=20/d.length)}),c+=10,d.forEach(e=>{o.includes(e)&&(l+=10/d.length)}),l/300})(e,t);return n>=r})}function r(e){return e.filter(e=>7!==e.category)}function n(e){return e.filter(e=>{var t;if(3===e.category){const r=(null==(t=e.name)?void 0:t.toLowerCase())||"";return!(r.includes("collector")||r.includes("bundle")||r.includes("collection")||r.includes("anthology")||r.includes("compilation")||r.includes("all-stars")||r.includes("complete edition")||r.includes("ultimate edition")||r.includes("definitive edition"))}return!0})}function i(e){return e.filter(e=>!e.name||!/-e\s*-\s*.+/i.test(e.name))}function s(e){return["","I","II","III","IV","V","VI","VII","VIII","IX","X"][e]||e.toString()}function a(e){const t=new Set,r=[];for(const n of e)t.has(n.id)||(t.add(n.id),r.push(n));return r}function o(){return Xe||(Xe=new Ye),Xe}function l(e,t,r){return 0===t||0===e?0:.5*Math.max(0,(e-1)/9)+Math.log10(t+1)/Math.log10(100)*.35+.15*(r>0?Math.log10(r+1)/Math.log10(1e4):0)}function c(e="unified_score",t=40){return I(this,null,function*(){try{const{data:r,error:n}=yield ee.rpc("get_games_with_review_stats",{sort_by:e,result_limit:t});return n?u(0,t):r||[]}catch(r){return u(0,t)}})}function u(e,t){return I(this,null,function*(){try{const{data:e,error:r}=yield ee.from("rating").select("game_id, rating");if(r)throw r;if(!e||0===e.length)return[];const n=new Map;e.forEach(e=>{const t=n.get(e.game_id)||{count:0,total:0,views:0};t.count++,t.total+=e.rating,n.set(e.game_id,t)});const i=Array.from(n.keys());if(0===i.length)return[];const{data:s,error:a}=yield ee.from("game").select("\n        id,\n        igdb_id,\n        name,\n        description,\n        summary,\n        release_date,\n        cover_url,\n        platforms,\n        category,\n        greenlight_flag,\n        redlight_flag\n      ").in("id",i).not("redlight_flag","eq",!0);if(a)throw a;return s&&0!==s.length?s.map(e=>{const t=n.get(e.id);if(!t)return null;const r=t.count,i=t.total/t.count,s=t.views||0;return b(w({},e),{user_rating_count:r,avg_user_rating:i,unified_score:l(i,r,s)})}).filter(e=>null!==e).sort((e,t)=>t.unified_score-e.unified_score).slice(0,t):[]}catch(e){return[]}})}function d(e,t){if(!e||!t)return 0;const r=e.toLowerCase().trim(),n=t.toLowerCase().trim();if(r===n)return 1e3;const i=r.replace(/^(the|a|an)\s+/i,"").trim(),s=n.replace(/^(the|a|an)\s+/i,"").trim();if(i===s)return 950;const a=["dlc","expansion","pack","edition","remaster","remake","enhanced","special","deluxe","definitive","goty","collection","bundle","mod","patch","update"].some(e=>r.includes(e));if(r.startsWith(n)){let e=900;return a&&(e=750),e}if(i.startsWith(s)){let e=850;return a&&(e=700),e}if(n.includes(r))return 800;if(r.includes(n))return n.length/r.length*700;const o=n.split(/\s+/).filter(e=>e.length>0),l=r.split(/\s+/).filter(e=>e.length>0);if(0===o.length||0===l.length)return 0;let c=0,u=0;o.forEach(e=>{l.some(t=>t===e)?c++:l.some(t=>t.includes(e)||e.includes(t))&&u++});const d=(c+.5*u)/o.length;return.8>d?.5>d?.3>d?0:200*d:400*d:600*d}function h(e){return I(this,null,function*(){try{const{data:t,error:r}=yield ee.rpc("search_games_optimized",{search_term:e.trim(),include_franchise_games:!0,limit_count:200,include_fan_content:!1});if(r){const{data:t}=yield ee.rpc("search_games_secure",{search_query:e.trim(),limit_count:150});return t||[]}return(t||[]).map(e=>b(w({},e),{t:"optimized",i:e.search_rank||0}))}catch(t){return[]}})}var m=Object.defineProperty,f=Object.defineProperties,y=Object.getOwnPropertyDescriptors,g=Object.getOwnPropertySymbols,_={}.hasOwnProperty,v={}.propertyIsEnumerable,p=(e,t,r)=>t in e?m(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,w=(e,t)=>{for(var r in t||(t={}))_.call(t,r)&&p(e,r,t[r]);if(g)for(var r of g(t))v.call(t,r)&&p(e,r,t[r]);return e},b=(e,t)=>f(e,y(t)),D=(e,t,r)=>p(e,"symbol"!=typeof t?t+"":t,r),I=(e,t,r)=>new Promise((n,i)=>{var s=e=>{try{o(r.next(e))}catch(t){i(t)}},a=e=>{try{o(r.throw(e))}catch(t){i(t)}},o=e=>e.done?n(e.value):Promise.resolve(e.value).then(s,a);o((r=r.apply(e,t)).next())});import{s as S,b as C,c as T,d as E,f as k,h as P,i as A,r as R,j as M,p as x,k as G,l as $,n as U,o as N,q as B,t as q,v as F,w as O,x as L,y as V,z}from"./app-utils-8pD5NX-P.js";import{_ as H}from"./app-components-DqcxH7V0.js";import{c as j}from"./vendor-supabase-DDjLwgak.js";const W={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_APP_ENV:"production",VITE_APP_URL:"www.gamevault.to",VITE_AUTO_CLEANUP_INTERVAL:"300000",VITE_BROWSER_CACHE_TTL:"300",VITE_CACHE_DEBUG:"false",VITE_CACHE_ENABLED:"true",VITE_CLEANUP_EXPIRED_ON_STARTUP:"true",VITE_DEFAULT_CACHE_TTL:"3600",VITE_ENABLE_CACHE_WARMUP:"true",VITE_ENABLE_PREFETCHING:"true",VITE_GAME_CACHE_TTL:"604800",VITE_LOG_CACHE_HITS:"true",VITE_MAX_BROWSER_CACHE_ITEMS:"100",VITE_MAX_DATABASE_CACHE_SIZE:"10000",VITE_SEARCH_CACHE_TTL:"1800",VITE_SUPABASE_ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxdWZtbW5ndXVteWhia2hnd2RjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MzU3MDUsImV4cCI6MjA2ODIxMTcwNX0.iP9jJM26Xa3-YeeB2YdYnqMK5JZyYcFY5_KXuLAZw-s",VITE_SUPABASE_URL:"https://cqufmmnguumyhbkhgwdc.supabase.co"};var J={};const Q={VITE_SUPABASE_URL:e("VITE_SUPABASE_URL")||"",VITE_SUPABASE_ANON_KEY:e("VITE_SUPABASE_ANON_KEY")||"",VITE_IGDB_CLIENT_ID:e("VITE_IGDB_CLIENT_ID"),VITE_IGDB_ACCESS_TOKEN:e("VITE_IGDB_ACCESS_TOKEN")},{VITE_SUPABASE_URL:Y,VITE_SUPABASE_ANON_KEY:X}=Q,Z=Y,K=X;if(!Z||!K)throw new Error("Missing Supabase environment variables");const ee=j(Z,K,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0,storageKey:"vgreviewapp-auth-token"},global:{headers:{"X-Client-Info":"vgreviewapp-web"}},realtime:{params:{eventsPerSecond:10}}}),te=Object.freeze(Object.defineProperty({__proto__:null,supabase:ee},Symbol.toStringTag,{value:"Module"})),re=e=>"object"==typeof e&&null!==e&&"number"==typeof e.id&&"string"==typeof e.provider_id&&"string"==typeof e.email,ne=new class{constructor(){D(this,"profileCache",new Map),D(this,"userCache",new Map),D(this,"CACHE_TTL",3e5),D(this,"cacheTimestamps",new Map),"undefined"!=typeof window&&setInterval(()=>this.cleanupCache(),6e4)}cleanupCache(){const e=Date.now();for(const[t,r]of this.profileCache.entries())e-r.timestamp>this.CACHE_TTL&&this.profileCache.delete(t);for(const[t,r]of this.userCache.entries())e-r.timestamp>this.CACHE_TTL&&this.userCache.delete(t);for(const[t,r]of this.cacheTimestamps.entries())e-r>this.CACHE_TTL&&this.cacheTimestamps.delete(t)}getCachedProfile(e){const t=this.profileCache.get(e);return t?Date.now()-t.timestamp>this.CACHE_TTL?(this.profileCache.delete(e),null):t.data:null}setCachedProfile(e,t){this.profileCache.set(e,{data:t,timestamp:Date.now(),userId:e})}updateCachedProfile(e,t){const r=this.profileCache.get(e);r&&(r.data=w(w({},r.data),t),r.timestamp=Date.now())}getCurrentAuthUser(){return I(this,null,function*(){try{const{data:{user:e},error:t}=yield ee.auth.getUser();return t?{success:!1,error:`Authentication error: ${t.message}`}:e?{success:!0,data:{id:e.id,email:e.email||void 0}}:{success:!1,error:"User not authenticated"}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to get auth user"}}})}getOrCreateUser(e){return I(this,null,function*(){try{if(!(null==e?void 0:e.user))return{success:!1,error:"No session provided"};const t=e.user,r=`user:${t.id}`,n=this.userCache.get(r);if(n&&Date.now()-n.timestamp<this.CACHE_TTL)return n.data;const i=yield this.tryDatabaseFunction(t);if(i.success)return this.userCache.set(r,{data:i,timestamp:Date.now()}),i;const s=yield this.performManualUserOperation(t);return s.success&&this.userCache.set(r,{data:s,timestamp:Date.now()}),s}catch(t){return{success:!1,error:t instanceof Error?t.message:"User operation failed"}}})}tryDatabaseFunction(e){return I(this,null,function*(){var t,r;try{const n=ee.rpc("get_or_create_user",{auth_id:e.id,user_email:e.email||"",user_name:(null==(t=e.user_metadata)?void 0:t.name)||(null==(r=e.user_metadata)?void 0:r.username)||"User",user_provider:"supabase"}),i=new Promise(e=>{setTimeout(()=>e({data:null,error:{message:"RPC timeout"}}),1500)}),{data:s,error:a}=yield Promise.race([n,i]);return!a&&s?{success:!0,userId:s}:{success:!1,error:(null==a?void 0:a.message)||"Database function not available"}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Database function error"}}})}performManualUserOperation(e){return I(this,null,function*(){var t,r;try{const n=yield this.lookupExistingUser(e.id);if(n.success)return n;const i=yield this.createNewUser(e);if(i.success)return i;if((null==(t=i.error)?void 0:t.includes("23505"))||(null==(r=i.error)?void 0:r.includes("unique"))){const t=yield this.lookupExistingUser(e.id);if(t.success)return t}return{success:!1,error:i.error||"Failed to create user record"}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Unknown error in user operation"}}})}lookupExistingUser(e){return I(this,null,function*(){try{const{data:t,error:r}=yield ee.from("user").select("id").eq("provider_id",e).single();return!r&&t?{success:!0,userId:t.id}:{success:!1,error:(null==r?void 0:r.message)||"User not found"}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Lookup error"}}})}createNewUser(e){return I(this,null,function*(){var t,r,n;try{const i={provider_id:e.id,email:e.email||null,name:(null==(t=e.user_metadata)?void 0:t.name)||(null==(r=e.user_metadata)?void 0:r.username)||"User",provider:"supabase",username:(null==(n=e.user_metadata)?void 0:n.username)||`user_${Date.now()}`,bio:"",location:"",website:""},{data:s,error:a}=yield ee.from("user").insert([i]).select("id").single();return!a&&s?{success:!0,userId:s.id}:{success:!1,error:(null==a?void 0:a.message)||"Failed to create user"}}catch(i){return{success:!1,error:i instanceof Error?i.message:"User creation error"}}})}getUser(e){return I(this,null,function*(){try{const{data:t,error:r}=yield ee.from("user").select("*").eq("id",e).single();return r?{success:!1,error:r.message}:{success:!0,data:t}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get user"}}})}getUserByUsername(e){return I(this,null,function*(){try{const{data:t,error:r}=yield ee.from("user").select("*").eq("username",e).single();return r?{success:!1,error:r.message}:{success:!0,data:t}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get user by username"}}})}getUserByProviderId(e){return I(this,null,function*(){try{const{data:t,error:r}=yield ee.from("user").select("*").eq("provider_id",e).single();return r?{success:!1,error:r.message}:{success:!0,data:t}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get user by provider ID"}}})}getUserProfile(e){return I(this,null,function*(){try{const t=this.getCachedProfile(e);if(t)return{success:!0,data:t};if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e))return{success:!1,error:"Invalid provider ID format"};const{data:r,error:n}=yield ee.from("user").select("*").eq("provider_id",e).single();return n?"PGRST116"===n.code?{success:!1,error:"User profile not found"}:{success:!1,error:`Database error: ${n.message}`}:r?re(r)?(this.setCachedProfile(e,r),{success:!0,data:r}):{success:!1,error:"Invalid user data structure"}:{success:!1,error:"User profile not found"}}catch(t){return{success:!1,error:t instanceof Error?`Unexpected error: ${t.message}`:"Failed to get user profile"}}})}getUserProfileById(e){return I(this,null,function*(){try{const t=`user_id_${e}`,r=this.profileCache.get(t);if(r)return{success:!0,data:r};const{data:n,error:i}=yield ee.from("user").select("*").eq("id",e).single();return i?"PGRST116"===i.code?{success:!1,error:"User profile not found"}:{success:!1,error:`Database error: ${i.message}`}:n?re(n)?(this.profileCache.set(t,n),n.provider_id&&this.setCachedProfile(n.provider_id,n),{success:!0,data:n}):{success:!1,error:"Invalid user data structure"}:{success:!1,error:"User profile not found"}}catch(t){return{success:!1,error:t instanceof Error?`Unexpected error: ${t.message}`:"Failed to get user profile"}}})}ensureUserProfileExists(e,t,r){return I(this,null,function*(){try{if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e))return{success:!1,error:`Invalid provider ID format. Expected UUID but got: ${e}`};const n=yield this.getUserProfile(e);if(n.success&&n.data)return n;let i=r||(null==t?void 0:t.split("@")[0])||"user";i=i.toLowerCase().replace(/\s+/g,"_");let s=i;for(;;){const{data:e}=yield ee.from("user").select("id").eq("username",s).maybeSingle();if(!e)break;s=`${i}_${Math.floor(1e3*Math.random())}`}const a={provider_id:e,email:t||null,provider:"supabase",username:S(s),name:S(r||(null==t?void 0:t.split("@")[0])||"User"),display_name:"",bio:"",location:"",website:"",avatar_url:null,platform:null},{data:o,error:l}=yield ee.from("user").insert([a]).select("*").single();return l?{success:!1,error:`Failed to create user profile: ${l.message}`}:o?(this.setCachedProfile(e,o),{success:!0,data:o}):{success:!1,error:"User profile creation returned no data"}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Failed to ensure user profile exists"}}})}updateUserProfile(e,t){return I(this,null,function*(){try{const r={};void 0!==t.name&&(r.name=S(t.name)),void 0!==t.username&&(r.username=S(t.username)),void 0!==t.display_name&&(r.display_name=C(t.display_name)),void 0!==t.bio&&(r.bio=C(t.bio)),void 0!==t.location&&(r.location=C(t.location)),void 0!==t.website&&(r.website=T(t.website)),void 0!==t.avatar_url&&(r.avatar_url=T(t.avatar_url)),void 0!==t.platform&&(r.platform=C(t.platform)),r.updated_at=(new Date).toISOString();const{data:n,error:i}=yield ee.from("user").update(r).eq("id",e).select("*").single();return i?{success:!1,error:`Failed to update profile: ${i.message}`}:n?(n.provider_id&&this.updateCachedProfile(n.provider_id,n),{success:!0,data:n}):{success:!1,error:"User profile update returned no data"}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Failed to update user profile"}}})}checkUsernameAvailability(e,t){return I(this,null,function*(){try{if(!e||0===e.trim().length)return{success:!1,error:"Username cannot be empty"};const r=S(e.trim());if(3>r.length)return{success:!1,error:"Username must be at least 3 characters long"};let n=ee.from("user").select("id").eq("username",r);t&&(n=n.neq("id",t));const{data:i,error:s}=yield n.maybeSingle();return s?{success:!1,error:`Database error: ${s.message}`}:{success:!0,data:{available:!i}}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Failed to check username availability"}}})}getCurrentUserProfile(e=!1){return I(this,null,function*(){try{const t=yield this.getCurrentAuthUser();if(!t.success||!t.data)return{success:!1,error:t.error||"No authenticated user"};const r=t.data.id;e&&this.profileCache.delete(r);const n=yield this.getUserProfile(r);if(!n.success||!n.data){const e=yield this.ensureUserProfileExists(r,t.data.email);return e.success&&e.data?e:{success:!1,error:n.error||"Failed to get current user profile"}}return n}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get current user profile"}}})}clearCache(){this.profileCache.clear(),this.userCache.clear(),this.cacheTimestamps.clear()}clearProfileCache(e){e?this.profileCache.delete(e):this.profileCache.clear()}},ie=e=>I(void 0,null,function*(){try{const{data:t,error:r}=yield ee.from("rating").select("rating").eq("user_id",e).eq("is_published",!0);if(r)return{success:!1,error:`Failed to fetch ratings: ${r.message}`};const n=Array.from({length:10},(e,t)=>({rating:t+1,count:0,percentage:0}));let i=0,s=0;return t&&t.length>0&&(t.forEach(e=>{const t=Math.floor(e.rating);1>t||t>10||(n[t-1].count++,i++,s+=e.rating)}),n.forEach(e=>{e.percentage=i>0?e.count/i*100:0})),{success:!0,data:{distribution:n,totalRatings:i,averageRating:i>0?s/i:0}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get rating distribution"}}}),se=(...e)=>ne.checkUsernameAvailability(...e),ae=new class{signUp(e,t,r){return I(this,null,function*(){try{const n=()=>{const e=window.location.origin;return e.includes("localhost")||e.includes("127.0.0.1"),`${e}/auth/callback`},{data:i,error:s}=yield ee.auth.signUp({email:e,password:t,options:{data:{username:r,name:r},emailRedirectTo:n()}});return s?{user:null,error:s}:(i.user&&(yield ne.getOrCreateDatabaseUser(i.user)).success,{user:i.user,error:null})}catch(n){return{user:null,error:n}}})}signIn(e,t){return I(this,null,function*(){try{const{data:r,error:n}=yield ee.auth.signInWithPassword({email:e,password:t});return{user:r.user,error:n}}catch(r){return{user:null,error:r}}})}signOut(){return I(this,null,function*(){try{const{error:e}=yield ee.auth.signOut();return{error:e}}catch(e){return{error:e}}})}getCurrentUser(){return I(this,null,function*(){try{const{data:{user:e}}=yield ee.auth.getUser();return e}catch(e){return null}})}getCurrentSession(){return I(this,null,function*(){try{const{data:{session:e}}=yield ee.auth.getSession();return e}catch(e){return null}})}updateProfile(e){return I(this,null,function*(){var t,r;try{const{data:{user:n}}=yield ee.auth.getUser();if(!n)return{error:"No user found"};const{error:i}=yield ee.auth.updateUser({data:{username:e.username,avatar_url:e.avatar,name:e.username||(null==(t=n.user_metadata)?void 0:t.username)}});if(i)return{error:i};const{error:s}=yield ee.from("user").update({name:e.username||(null==(r=n.user_metadata)?void 0:r.username),avatar_url:e.avatar,updated_at:(new Date).toISOString()}).eq("provider_id",n.id);return{error:s}}catch(n){return{error:n}}})}resetPassword(e,t){return I(this,null,function*(){try{let r;r=t||`${window.location.origin}/reset-password`;const{error:n}=yield ee.auth.resetPasswordForEmail(e,{redirectTo:r});return{error:n}}catch(r){return{error:r}}})}updatePassword(e){return I(this,null,function*(){try{const{error:t}=yield ee.auth.updateUser({password:e});return{error:t}}catch(t){return{error:t}}})}signInWithProvider(e){return I(this,null,function*(){try{const{error:t}=yield ee.auth.signInWithOAuth({provider:e,options:{redirectTo:`${window.location.origin}/auth/callback`}});return{error:t}}catch(t){return{error:t}}})}onAuthStateChange(e){return ee.auth.onAuthStateChange(e)}createUserProfile(e,t){return I(this,null,function*(){var r;try{const{error:n}=yield ee.from("user").insert({provider:"supabase",provider_id:e.id,email:e.email||"",name:t,avatar_url:null==(r=e.user_metadata)?void 0:r.avatar_url,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()})}catch(n){}})}getUserProfile(e){return I(this,null,function*(){try{const{data:t,error:r}=yield ee.from("user").select("*").eq("provider_id",e).single();return{data:t,error:r}}catch(t){return{data:null,error:t}}})}deleteAccount(){return I(this,null,function*(){try{const{data:{user:e}}=yield ee.auth.getUser();if(!e)return{error:"No user found"};yield ee.from("user").delete().eq("provider_id",e.id);const{error:t}=yield ee.auth.signOut();return{error:t}}catch(e){return{error:e}}})}checkUsernameAvailability(e){return I(this,null,function*(){try{if(!e||3>e.length)return{available:!1};const{count:t,error:r}=yield ee.from("user").select("id",{count:"exact",head:!0}).eq("username",e.toLowerCase());return r?{available:!1,error:r}:{available:0===t}}catch(t){return{available:!1,error:t}}})}},oe=new class{constructor(){D(this,"_endpoint",null),D(this,"useDatabase",!1)}get endpoint(){return null===this.o&&(this.o=this.detectEndpoint()),this.o}detectEndpoint(){if("undefined"==typeof window)return"/.netlify/functions/igdb-search";try{return window.location.port,window.location.hostname,"/.netlify/functions/igdb-search"}catch(e){return"/.netlify/functions/igdb-search"}}searchWithFlagshipFallback(e,t){return I(this,null,function*(){const r=yield this.performBasicSearch(e,t),n=E(e);if(r.length>=Math.min(3,t)||!n)return r;const i=k(n),s=[];for(const e of i.slice(0,2))s.push(this.performBasicSearch(e,3).catch(e=>[]));const a=(yield Promise.all(s)).flat(),o=new Set(r.map(e=>e.id)),l=a.filter(e=>!o.has(e.id));return[...r,...l].slice(0,t)})}performBasicSearch(e,t){return I(this,null,function*(){var r,n,i;try{const r=yield fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({searchTerm:e.trim(),limit:t})});if(!r.ok){if(404===r.status||500===r.status)return this.searchDatabase(e,t);throw new Error(`IGDB API error: ${r.status}`)}const n=yield r.json();return n.success?n.games||[]:this.searchDatabase(e,t)}catch(s){return(null==(r=null==s?void 0:s.message)?void 0:r.includes("fetch"))||(null==(n=null==s?void 0:s.message)?void 0:n.includes("NetworkError"))||null==(i=null==s?void 0:s.message)||i.includes("Failed to fetch"),this.searchDatabase(e,t)}})}searchGames(e,s=30){return I(this,null,function*(){var a;try{if(!e.trim())return[];let a=e;e.toLowerCase().includes("pokemon")&&(a=e.replace(/pokemon/gi,"Pok\xe9mon"));const l=yield this.performBasicSearch(a,s);e.toLowerCase().includes("zelda")&&l.find(e=>{var t,r;return(null==(t=e.name)?void 0:t.toLowerCase().includes("breath of the wild"))&&!(null==(r=e.name)?void 0:r.toLowerCase().includes("bundle"))});const c=l.map(e=>{var t,r,n,i,s,a,o,l,c,u,d,h,m,f,y,g;return{id:e.id,name:e.name,allNames:[e.name,...(null==(t=e.alternative_names)?void 0:t.map(e=>e.name))||[]].filter(Boolean),developer:(null==(i=null==(n=null==(r=e.involved_companies)?void 0:r.find(e=>e.developer))?void 0:n.company)?void 0:i.name)||(null==(o=null==(a=null==(s=e.involved_companies)?void 0:s[0])?void 0:a.company)?void 0:o.name),publisher:(null==(u=null==(c=null==(l=e.involved_companies)?void 0:l.find(e=>e.publisher))?void 0:c.company)?void 0:u.name)||(null==(m=null==(h=null==(d=e.involved_companies)?void 0:d[0])?void 0:h.company)?void 0:m.name),summary:e.summary,description:e.summary,category:e.category,genres:(null==(f=e.genres)?void 0:f.map(e=>e.name))||[],franchise:null==(y=e.franchise)?void 0:y.name,collection:null==(g=e.collection)?void 0:g.name}});e.toLowerCase().includes("final fantasy"),e.toLowerCase().includes("mega man")||e.toLowerCase().includes("megaman");const u=P(c);A(c).filtered>0&&(e.toLowerCase().includes("final fantasy"),e.toLowerCase().includes("mega man")||e.toLowerCase().includes("megaman"));let d=u.map(e=>l.find(t=>t.id===e.id));e.toLowerCase().includes("zelda")&&d.find(e=>{var t,r;return(null==(t=e.name)?void 0:t.toLowerCase().includes("breath of the wild"))&&!(null==(r=e.name)?void 0:r.toLowerCase().includes("bundle"))}),d=r(d),d=i(d),d=t(d,e),e.toLowerCase().includes("zelda")&&d.find(e=>{var t,r;return(null==(t=e.name)?void 0:t.toLowerCase().includes("breath of the wild"))&&!(null==(r=e.name)?void 0:r.toLowerCase().includes("bundle"))});const h=E(a);let m=!1;if(h){const t=d.some(e=>0===e.category&&!e.name.toLowerCase().includes("olympic")&&!e.name.toLowerCase().includes("party"));m=3>d.filter(t=>0===t.category&&!t.name.toLowerCase().includes("olympic")&&(!t.name.toLowerCase().includes("party")||e.toLowerCase().includes("party"))).length||d.length<Math.min(5,s)&&!t}if(m){const s=k(h),a=[];for(const e of s.slice(0,2))a.push(this.performBasicSearch(e,15).catch(e=>[]));const o=(yield Promise.all(a)).flat(),l=o.map(e=>{var t,r,n,i,s,a,o,l,c,u,d,h,m,f,y,g;return{id:e.id,name:e.name,allNames:[e.name,...(null==(t=e.alternative_names)?void 0:t.map(e=>e.name))||[]].filter(Boolean),developer:(null==(i=null==(n=null==(r=e.involved_companies)?void 0:r.find(e=>e.developer))?void 0:n.company)?void 0:i.name)||(null==(o=null==(a=null==(s=e.involved_companies)?void 0:s[0])?void 0:a.company)?void 0:o.name),publisher:(null==(u=null==(c=null==(l=e.involved_companies)?void 0:l.find(e=>e.publisher))?void 0:c.company)?void 0:u.name)||(null==(m=null==(h=null==(d=e.involved_companies)?void 0:d[0])?void 0:h.company)?void 0:m.name),summary:e.summary,description:e.summary,category:e.category,genres:(null==(f=e.genres)?void 0:f.map(e=>e.name))||[],franchise:null==(y=e.franchise)?void 0:y.name,collection:null==(g=e.collection)?void 0:g.name}});let c=P(l).map(e=>o.find(t=>t.id===e.id));c=r(c),c=n(c),c=i(c),c=t(c,e);const u=new Set(d.map(e=>e.id)),m=c.filter(e=>!u.has(e.id));d=[...m,...d]}d.length>1&&(d=R(d,e)),d=M(d,e),d=x(d),d=G(d,e);const{applyGameTypeBoost:f,applyOlympicPartyPenalty:y}=yield H(()=>I(this,null,function*(){const{applyGameTypeBoost:e,applyOlympicPartyPenalty:t}=yield import("./app-utils-8pD5NX-P.js").then(e=>e.I);return{applyGameTypeBoost:e,applyOlympicPartyPenalty:t}}),__vite__mapDeps([0,1,2,3,4,5,6,7,8]));d=f(d,e),d=y(d,e);const{applyAdvancedPlatformBoosts:g}=yield H(()=>I(this,null,function*(){const{applyAdvancedPlatformBoosts:e}=yield import("./app-utils-8pD5NX-P.js").then(e=>e.J);return{applyAdvancedPlatformBoosts:e}}),__vite__mapDeps([0,1,2,3,4,5,6,7,8]));d=g(d,e);const{applyQualityMetrics:_}=yield H(()=>I(this,null,function*(){const{applyQualityMetrics:e}=yield import("./app-utils-8pD5NX-P.js").then(e=>e.K);return{applyQualityMetrics:e}}),__vite__mapDeps([0,1,2,3,4,5,6,7,8]));if(d=_(d,e),d.length>1){const e=d.map(e=>{var t,r,n,i,s,a,o,l,c,u,d,h,m;return b(w({},e),{genres:(null==(t=e.genres)?void 0:t.map(e=>e.name))||[],developer:(null==(i=null==(n=null==(r=e.involved_companies)?void 0:r.find(e=>e.developer))?void 0:n.company)?void 0:i.name)||(null==(o=null==(a=null==(s=e.involved_companies)?void 0:s[0])?void 0:a.company)?void 0:o.name),publisher:(null==(u=null==(c=null==(l=e.involved_companies)?void 0:l.find(e=>e.publisher))?void 0:c.company)?void 0:u.name)||(null==(m=null==(h=null==(d=e.involved_companies)?void 0:d[0])?void 0:h.company)?void 0:m.name),igdb_rating:e.rating})}),t=$(e);d=t.map(e=>{const t=d.find(t=>t.id===e.id);return t?w(w({},t),e):e}),d.slice(0,5).forEach((e,t)=>{var r,n,i,s,a,o,l,c,u,d,h,m,f;const y=b(w({},e),{genres:(null==(r=e.genres)?void 0:r.map(e=>e.name))||[],developer:(null==(s=null==(i=null==(n=e.involved_companies)?void 0:n.find(e=>e.developer))?void 0:i.company)?void 0:s.name)||(null==(l=null==(o=null==(a=e.involved_companies)?void 0:a[0])?void 0:o.company)?void 0:l.name),publisher:(null==(d=null==(u=null==(c=e.involved_companies)?void 0:c.find(e=>e.publisher))?void 0:u.company)?void 0:d.name)||(null==(f=null==(m=null==(h=e.involved_companies)?void 0:h[0])?void 0:m.company)?void 0:f.name),igdb_rating:e.rating}),g=U(y),_=e.l,v=e.u,p=e.h;let D=`Priority: ${g.score}`;_&&(D+=`, Fuzzy: ${_.toFixed(2)}`),v&&(D+=`, Iconic: +${Math.round(v)}`),p&&(D+=" \ud83c\udfc6")})}if(d.length<s&&d.length>0)try{const r=t(yield this.fetchRelatedGames(d,s-d.length),e);d=[...d,...r]}catch(o){}return d}catch(o){if((null==(a=null==o?void 0:o.message)?void 0:a.includes("500"))||500===(null==o?void 0:o.status))return[];throw o}})}searchWithSequels(e,o=8){return I(this,null,function*(){try{if(!e.trim())return[];const l=yield this.searchGames(e,Math.ceil(o/2));if(0===l.length)return[];const c=yield function(e,o){return I(this,null,function*(){try{const l=new Set,c=new Set;o.forEach(e=>{e.franchises&&e.franchises.forEach(e=>{l.add(e.id),c.add(e.name.toLowerCase())})});const u=N(e),d=(e=>{const t=[],r=e.toLowerCase().trim();for(let n=1;10>=n;n++)t.push(`${r} ${n}`),t.push(`${r} ${s(n)}`);return["world","bros","super","mega","ultra","x","zero","advanced","dx","collection","legacy","anniversary","remastered","remake","hd","deluxe","special"].forEach(e=>{t.push(`${r} ${e}`),t.push(`${e} ${r}`),t.push(`super ${r}`)}),r.includes("mario")&&t.push("super mario world","super mario bros","new super mario bros"),(r.includes("mega man")||r.includes("megaman"))&&t.push("mega man x","megaman x","rockman","mega man zero"),r.includes("zelda")&&t.push("legend of zelda","ocarina of time","breath of the wild","tears of the kingdom"),t})(e),h=[...new Set([...u,...d])],m=[],f="/.netlify/functions/igdb-search";for(const e of h.slice(0,3))m.push(fetch(f,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({searchTerm:e,limit:15})}).then(e=>e.json()).then(e=>e.success&&e.games||[]).catch(()=>[]));if(l.size>0){const e=Array.from(c).join(" ");m.push(fetch(f,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({searchTerm:e,limit:10})}).then(e=>e.json()).then(e=>e.success&&e.games||[]).catch(()=>[]))}const y=a((yield Promise.all(m)).flat()),g=new Set(o.map(e=>e.id)),_=y.filter(t=>!g.has(t.id)&&((e,t,r)=>{const n=e.name.toLowerCase(),i=t.toLowerCase();if(e.franchises&&e.franchises.some(e=>r.has(e.name.toLowerCase())))return!0;const s=i.split(/\s+/).some(e=>n.includes(e)),a=[/\d+/,/\b(ii|iii|iv|v|vi|vii|viii|ix|x)\b/i,/\b(world|bros|super|mega|ultra|zero|x)\b/i,/\b(collection|legacy|remastered|hd|dx)\b/i].some(e=>e.test(n));return s&&a})(t,e,c)),v=_.map(e=>{var t,r,n,i,s,a,o,l,c,u,d,h,m,f,y,g;return{id:e.id,name:e.name,allNames:[e.name,...(null==(t=e.alternative_names)?void 0:t.map(e=>e.name))||[]].filter(Boolean),developer:(null==(i=null==(n=null==(r=e.involved_companies)?void 0:r.find(e=>e.developer))?void 0:n.company)?void 0:i.name)||(null==(o=null==(a=null==(s=e.involved_companies)?void 0:s[0])?void 0:a.company)?void 0:o.name),publisher:(null==(u=null==(c=null==(l=e.involved_companies)?void 0:l.find(e=>e.publisher))?void 0:c.company)?void 0:u.name)||(null==(m=null==(h=null==(d=e.involved_companies)?void 0:d[0])?void 0:h.company)?void 0:m.name),summary:e.summary,description:e.summary,category:e.category,genres:(null==(f=e.genres)?void 0:f.map(e=>e.name))||[],franchise:null==(y=e.franchise)?void 0:y.name,collection:null==(g=e.collection)?void 0:g.name}});return t(i(n(r(P(v).map(e=>_.find(t=>t.id===e.id))))),e)}catch(l){return[]}})}(e,l),u=a([...l,...c]),d=R(u,e),{applyGameTypeBoost:h,applyOlympicPartyPenalty:m}=yield H(()=>I(this,null,function*(){const{applyGameTypeBoost:e,applyOlympicPartyPenalty:t}=yield import("./app-utils-8pD5NX-P.js").then(e=>e.I);return{applyGameTypeBoost:e,applyOlympicPartyPenalty:t}}),__vite__mapDeps([0,1,2,3,4,5,6,7,8]));let f=h(d,e);f=m(f,e);const{applyAdvancedPlatformBoosts:y}=yield H(()=>I(this,null,function*(){const{applyAdvancedPlatformBoosts:e}=yield import("./app-utils-8pD5NX-P.js").then(e=>e.J);return{applyAdvancedPlatformBoosts:e}}),__vite__mapDeps([0,1,2,3,4,5,6,7,8]));f=y(f,e);const{applyQualityMetrics:g}=yield H(()=>I(this,null,function*(){const{applyQualityMetrics:e}=yield import("./app-utils-8pD5NX-P.js").then(e=>e.K);return{applyQualityMetrics:e}}),__vite__mapDeps([0,1,2,3,4,5,6,7,8]));f=g(f,e);const _=f.map(e=>{var t,r,n,i,s,a,o,l,c,u,d,h,m;return b(w({},e),{genres:(null==(t=e.genres)?void 0:t.map(e=>e.name))||[],developer:(null==(i=null==(n=null==(r=e.involved_companies)?void 0:r.find(e=>e.developer))?void 0:n.company)?void 0:i.name)||(null==(o=null==(a=null==(s=e.involved_companies)?void 0:s[0])?void 0:a.company)?void 0:o.name),publisher:(null==(u=null==(c=null==(l=e.involved_companies)?void 0:l.find(e=>e.publisher))?void 0:c.company)?void 0:u.name)||(null==(m=null==(h=null==(d=e.involved_companies)?void 0:d[0])?void 0:h.company)?void 0:m.name),igdb_rating:e.rating})});return $(_).slice(0,o).map(e=>f.find(t=>t.id===e.id)||e)}catch(l){return this.searchGames(e,o)}})}getGameById(e){return I(this,null,function*(){var t;try{const r=yield fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"getById",gameId:e})});if(!r.ok)throw new Error(`IGDB API error: ${r.status}`);const n=yield r.json();if(!n.success)throw new Error(n.error||"IGDB API error");return(null==(t=n.games)?void 0:t[0])||null}catch(r){throw r}})}fetchRelatedGames(e,t){return I(this,null,function*(){try{const s=new Set;e.forEach(e=>{var t,r,n;null==(t=e.dlcs)||t.forEach(e=>s.add(e)),null==(r=e.expansions)||r.forEach(e=>s.add(e)),null==(n=e.similar_games)||n.slice(0,3).forEach(e=>s.add(e))});const a=new Set(e.map(e=>e.id)),o=Array.from(s).filter(e=>!a.has(e));if(0===o.length)return[];const l=`fields name, summary, first_release_date, rating, category, cover.url, genres.name, platforms.name, involved_companies.company.name, alternative_names.name, collection.name, franchise.name, franchises.name, dlcs, expansions, similar_games; where id = (${o.slice(0,Math.min(t,10)).join(",")});`,c=yield fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({isBulkRequest:!0,endpoint:"games",requestBody:l})});if(!c.ok)throw new Error(`Related games fetch error: ${c.status}`);const u=yield c.json();if(!u.success)throw new Error(u.error||"Related games fetch error");const d=u.games||[],h=d.map(e=>{var t,r,n,i,s,a,o,l,c,u,d,h,m,f,y,g;return{id:e.id,name:e.name,allNames:[e.name,...(null==(t=e.alternative_names)?void 0:t.map(e=>e.name))||[]].filter(Boolean),developer:(null==(i=null==(n=null==(r=e.involved_companies)?void 0:r.find(e=>e.developer))?void 0:n.company)?void 0:i.name)||(null==(o=null==(a=null==(s=e.involved_companies)?void 0:s[0])?void 0:a.company)?void 0:o.name),publisher:(null==(u=null==(c=null==(l=e.involved_companies)?void 0:l.find(e=>e.publisher))?void 0:c.company)?void 0:u.name)||(null==(m=null==(h=null==(d=e.involved_companies)?void 0:d[0])?void 0:h.company)?void 0:m.name),summary:e.summary,description:e.summary,category:e.category,genres:(null==(f=e.genres)?void 0:f.map(e=>e.name))||[],franchise:null==(y=e.franchise)?void 0:y.name,collection:null==(g=e.collection)?void 0:g.name}});let m=P(h).map(e=>d.find(t=>t.id===e.id));return m=r(m),m=n(m),m=i(m),m=m.slice(0,t),m}catch(s){return[]}})}transformGameForFilter(e){var t,r,n,i,s,a,o,l,c,u,d,h,m,f,y,g;const _=[e.name,...(null==(t=e.alternative_names)?void 0:t.map(e=>e.name))||[]].filter(Boolean);return{id:e.id,name:e.name,allNames:_,developer:(null==(i=null==(n=null==(r=e.involved_companies)?void 0:r.find(e=>e.developer))?void 0:n.company)?void 0:i.name)||(null==(o=null==(a=null==(s=e.involved_companies)?void 0:s[0])?void 0:a.company)?void 0:o.name),publisher:(null==(u=null==(c=null==(l=e.involved_companies)?void 0:l.find(e=>e.publisher))?void 0:c.company)?void 0:u.name)||(null==(m=null==(h=null==(d=e.involved_companies)?void 0:d[0])?void 0:h.company)?void 0:m.name),summary:e.summary,description:e.summary,category:e.category,genres:(null==(f=e.genres)?void 0:f.map(e=>e.name))||[],franchise:null==(y=e.franchise)?void 0:y.name,collection:null==(g=e.collection)?void 0:g.name}}transformGame(e){var t,r,n,i,s,a,o,l,c,u,d,h,m,f,y,g;return{id:0,igdb_id:e.id,name:e.name,summary:e.summary,description:e.storyline||e.summary,first_release_date:e.first_release_date?new Date(1e3*e.first_release_date):void 0,release_date:e.first_release_date?new Date(1e3*e.first_release_date).toISOString():void 0,rating:e.rating,igdb_rating:e.rating,category:e.category,cover:e.cover,cover_url:(null==(t=e.cover)?void 0:t.url)?this.transformImageUrl(e.cover.url):void 0,screenshots:(null==(r=e.screenshots)?void 0:r.map(e=>this.transformImageUrl(e.url)))||[],genres:(null==(n=e.genres)?void 0:n.map(e=>e.name))||[],genre:null==(s=null==(i=e.genres)?void 0:i[0])?void 0:s.name,platforms:(null==(a=e.platforms)?void 0:a.map(e=>e.name))||[],developer:null==(c=null==(l=null==(o=e.involved_companies)?void 0:o.find(e=>e.developer))?void 0:l.company)?void 0:c.name,publisher:null==(h=null==(d=null==(u=e.involved_companies)?void 0:u.find(e=>e.publisher))?void 0:d.company)?void 0:h.name,alternative_names:(null==(m=e.alternative_names)?void 0:m.map(e=>e.name))||[],collection:null==(f=e.collection)?void 0:f.name,franchise:null==(y=e.franchise)?void 0:y.name,franchises:(null==(g=e.franchises)?void 0:g.map(e=>e.name))||[],dlcs:e.dlcs||[],expansions:e.expansions||[],similar_games:e.similar_games||[]}}transformImageUrl(e){return e?e.replace("t_thumb","t_cover_big").replace("//","https://"):""}testConnection(){return I(this,null,function*(){try{const e=yield fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({searchTerm:"test",limit:1})}),t=yield e.json();return e.ok&&t.success}catch(e){return!1}})}searchDatabase(e,t){return I(this,null,function*(){try{const{data:r,error:n}=yield ee.rpc("search_games_secure",{search_query:e.trim(),limit_count:Math.min(t,100)});return n?[]:r&&0!==r.length?r.map(e=>{var t;return w({id:e.igdb_id||e.id,name:e.name||"Unknown Game",slug:e.slug,summary:e.description||e.summary,cover:e.cover_url?{url:e.cover_url,image_id:null==(t=e.cover_url.split("/").pop())?void 0:t.split(".")[0]}:void 0,first_release_date:e.release_date?Math.floor(new Date(e.release_date).getTime()/1e3):void 0,category:e.category||0,genres:e.genres||[],platforms:e.platforms||[],involved_companies:e.developer||e.publisher?[{company:{name:e.developer||e.publisher}}]:void 0},e)}):[]}catch(r){return[]}})}},le=()=>I(void 0,null,function*(){try{const{data:{user:e},error:t}=yield ee.auth.getUser();if(t)return null;if(!e)return null;const{data:r,error:n}=yield ee.from("user").select("id, provider_id, name, email").eq("provider_id",e.id).single();return n?(n.code,null):(null==r?void 0:r.id)||null}catch(e){return null}}),ce=e=>I(void 0,null,function*(){try{if(void 0===e.igdb_id||null===e.igdb_id||isNaN(e.igdb_id)||0>=e.igdb_id)return{success:!1,error:"Game data missing valid IGDB ID"};if(e.id>0){const{data:t,error:r}=yield ee.from("game").select("id, name").eq("id",e.id).single();if(!r&&t)return{success:!0,data:{gameId:t.id}}}const{data:t,error:r}=yield ee.from("game").select("id, name, igdb_id").eq("igdb_id",e.igdb_id).maybeSingle();if(!r&&t)return{success:!0,data:{gameId:t.id}};let n=null;if(e.releaseDate&&("number"==typeof e.releaseDate?n=new Date(1e3*e.releaseDate).toISOString().split("T")[0]:"string"==typeof e.releaseDate&&(n=e.releaseDate)),!e.name||0===e.name.trim().length)return{success:!1,error:"Game name is required"};const i=F(e.name.trim()),{data:s}=yield ee.from("game").select("id").eq("slug",i).maybeSingle(),a=s?F(e.name.trim(),e.igdb_id):i,o={igdb_id:e.igdb_id,game_id:`igdb_${e.igdb_id}`,name:e.name.trim(),slug:a,cover_url:e.cover_url||null,genres:e.genre?[e.genre]:null,release_date:n},{data:l,error:c}=yield ee.from("game").insert(o).select("id, name").single();if(c){if("23505"===c.code){const{data:t}=yield ee.from("game").select("id, name").eq("igdb_id",e.igdb_id).maybeSingle();if(t)return{success:!0,data:{gameId:t.id}}}return{success:!1,error:`Failed to add game to database: ${c.message}`}}return{success:!0,data:{gameId:l.id}}}catch(t){return Error,{success:!1,error:t instanceof Error?`Unexpected error: ${t.message}`:"Failed to ensure game exists due to unexpected error"}}}),ue=(e,t,r,n,i,s)=>I(void 0,null,function*(){var a;try{const l=yield le();if(!l)return{success:!1,error:"User not authenticated or not found in database"};const{data:c,error:u}=yield ee.from("game").select("id, name, slug").eq("igdb_id",e).single();if(u&&"PGRST116"!==u.code)return{success:!1,error:`Game lookup failed: ${u.message}`};let d,h,m;if(c)d=c.id,h=c.slug||F(c.name),m=c.name;else try{const t=yield oe.getGameById(e);if(!t)return{success:!1,error:"Game not found. Please select a valid game from the search results."};const r=oe.transformGame(t),n=yield ce({id:0,igdb_id:r.igdb_id,name:r.name,cover_url:r.cover_url,genre:null==(a=r.genres)?void 0:a[0],releaseDate:r.release_date});if(!n.success||!n.data)return{success:!1,error:n.error||"Failed to add game to database"};d=n.data.gameId;const{data:i}=yield ee.from("game").select("slug, name").eq("id",d).single();h=(null==i?void 0:i.slug)||F(r.name),m=(null==i?void 0:i.name)||r.name}catch(o){return{success:!1,error:"Failed to fetch game data. Please try again."}}const{data:f,error:y}=yield ee.from("platform").select("id").eq("name",i).single();if(y||!f)return{success:!1,error:`Platform "${i}" not found in database`};const g=f.id,{data:_,error:v}=yield ee.from("rating").select("id").eq("user_id",l).eq("game_id",d).single();if(v&&"PGRST116"!==v.code)return{success:!1,error:`Error checking existing review: ${v.message}`};if(_)return{success:!1,error:"You have already reviewed this game"};const p={user_id:l,game_id:d,igdb_id:e,slug:h,rating:t,review:r?q(r):null,post_date_time:(new Date).toISOString(),is_recommended:n,platform_id:g,playtime_hours:s||null},{data:w,error:b}=yield ee.from("rating").insert(p).select("\n        *,\n        user!fk_rating_user(*),\n        game(*)\n      ").single();return b?{success:!1,error:`Failed to insert review: ${b.message} (Code: ${b.code})`}:{success:!0,data:{id:w.id,userId:w.user_id,gameId:w.game_id,rating:w.rating,review:w.review,postDateTime:w.post_date_time,playtimeHours:w.playtime_hours,isRecommended:w.is_recommended,likeCount:0,commentCount:0,user:w.user?{id:w.user.id,name:w.user.username||w.user.name,avatar_url:w.user.avatar_url}:void 0,game:w.game?{id:w.game.id,name:w.game.name,cover_url:w.game.cover_url}:void 0}}}catch(l){return Error,{success:!1,error:l instanceof Error?`Unexpected error: ${l.message}`:"Failed to create review due to unexpected error"}}}),de=e=>I(void 0,null,function*(){try{if(!(yield le()))return{success:!1,error:"User not authenticated"};const{data:t,error:r}=yield ee.from("game").select("id").eq("igdb_id",e).single();return r&&"PGRST116"!==r.code?{success:!1,error:`Failed to find game: ${r.message}`}:t?yield he(t.id):{success:!0,data:null}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get user review"}}}),he=e=>I(void 0,null,function*(){try{const t=yield le();if(!t)return{success:!1,error:"User not authenticated"};const{data:r,error:n}=yield ee.from("rating").select("\n        *,\n        user!fk_rating_user(*),\n        game(*)\n      ").eq("user_id",t).eq("game_id",e).single();return n&&"PGRST116"!==n.code?{success:!1,error:`Failed to fetch review: ${n.message}`}:r?{success:!0,data:{id:r.id,userId:r.user_id,gameId:r.game_id,rating:r.rating,review:r.review,postDateTime:r.post_date_time,playtimeHours:r.playtime_hours,isRecommended:r.is_recommended,likeCount:0,commentCount:0,user:r.user?{id:r.user.id,name:r.user.username||r.user.name,avatar_url:r.user.avatar_url}:void 0,game:r.game?{id:r.game.id,name:r.game.name,cover_url:r.game.cover_url}:void 0}}:{success:!0,data:null}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get user review"}}}),me=(e,t,r,n,i,s,a)=>I(void 0,null,function*(){try{const t=yield le();if(!t)return{success:!1,error:"User not authenticated"};const{data:o,error:l}=yield ee.from("rating").select("id, user_id").eq("id",e).eq("user_id",t).single();if(l||!o)return{success:!1,error:"Review not found or you do not have permission to edit it"};let c;if(s){const{data:e,error:t}=yield ee.from("platform").select("id").eq("name",s).single();if(t||!e)return{success:!1,error:`Platform "${s}" not found in database`};c=e.id}const u={rating:r,review:n?q(n):null,is_recommended:i,updated_at:(new Date).toISOString(),playtime_hours:a||null};void 0!==c&&(u.platform_id=c);const{data:d,error:h}=yield ee.from("rating").update(u).eq("id",e).select("\n        *,\n        user!fk_rating_user(*),\n        game(*)\n      ").single();return h?{success:!1,error:`Failed to update review: ${h.message} (Code: ${h.code})`}:{success:!0,data:{id:d.id,userId:d.user_id,gameId:d.game_id,rating:d.rating,review:d.review,postDateTime:d.post_date_time,playtimeHours:d.playtime_hours,isRecommended:d.is_recommended,likeCount:0,commentCount:0,user:d.user?{id:d.user.id,name:d.user.username||d.user.name,avatar_url:d.user.avatar_url}:void 0,game:d.game?{id:d.game.id,name:d.game.name,cover_url:d.game.cover_url}:void 0}}}catch(t){return{success:!1,error:t instanceof Error?`Unexpected error: ${t.message}`:"Failed to update review due to unexpected error"}}}),fe=e=>I(void 0,null,function*(){try{if(!e||isNaN(e))return{success:!1,error:"Invalid review ID"};const{data:t,error:r}=yield ee.from("rating").select("\n        *,\n        user!fk_rating_user(*),\n        game(*)\n      ").eq("id",e).single();if(r)throw r;if(!t)return{success:!1,error:"Review not found"};const n=t.like_count||0,i=t.comment_count||0;return{success:!0,data:{id:t.id,userId:t.user_id,gameId:t.game_id,rating:t.rating,review:t.review,postDateTime:t.post_date_time,playtimeHours:t.playtime_hours,isRecommended:t.is_recommended,likeCount:n||0,commentCount:i||0,user:t.user?{id:t.user.id,name:t.user.username||t.user.name,avatar_url:t.user.avatar_url}:void 0,game:t.game?{id:t.game.id,name:t.game.name,cover_url:t.game.cover_url}:void 0}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to fetch review"}}}),ye=(e,t)=>I(void 0,null,function*(){try{if(!e||isNaN(e))return{success:!1,error:"Invalid user ID"};if(!t||isNaN(t))return{success:!1,error:"Invalid review ID"};const{data:r,error:n}=yield ee.from("content_like").select("id").eq("user_id",e).eq("rating_id",t).maybeSingle();if(n)throw n;return{success:!0,data:!!r}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Failed to check like status"}}}),ge=(e,t,r)=>I(void 0,null,function*(){try{if(!e||isNaN(e))return{success:!1,error:"Invalid user ID"};if(!t||isNaN(t))return{success:!1,error:"Invalid review ID"};const{data:r,error:n}=yield ee.rpc("simple_toggle_like",{p_user_id:e,p_review_id:t});if(n)throw n;const i=r;if(!i.success)return{success:!1,error:i.error||"Failed to toggle like"};const{data:s}=yield ee.from("rating").select("like_count").eq("id",t).single();return{success:!0,data:{likeCount:(null==s?void 0:s.like_count)||0,isLiked:i.liked}}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Failed to toggle like"}}}),_e=(e,t)=>I(void 0,null,function*(){const r=yield ge(e,t);return{success:r.success,error:r.error,data:r.data?{likeCount:r.data.likeCount}:void 0}}),ve=(e,t)=>I(void 0,null,function*(){const r=yield ge(e,t);return{success:r.success,error:r.error,data:r.data?{likeCount:r.data.likeCount}:void 0}}),pe=(e,t)=>I(void 0,null,function*(){try{if(!e||isNaN(e))return{success:!1,error:"Invalid user ID"};if(!t||isNaN(t))return{success:!1,error:"Invalid comment ID"};const{data:r,error:n}=yield ee.rpc("simple_toggle_comment_like",{p_user_id:e,p_comment_id:t});if(n)throw n;return r&&r.success?{success:!0,data:{likeCount:r.likeCount||0}}:{success:!1,error:(null==r?void 0:r.error)||"Failed to toggle comment like"}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Failed to toggle comment like"}}}),we=(e,t)=>I(void 0,null,function*(){return pe(e,t)}),be=(e,t)=>I(void 0,null,function*(){return pe(e,t)}),De=(e,...t)=>I(void 0,[e,...t],function*(e,{limit:t=50,offset:r=0}={},n){try{if(!e||isNaN(e))return{success:!1,error:"Invalid review ID"};const{data:i,error:s,count:a}=yield ee.from("comment").select("\n        *,\n        user:comment_user_id_fkey(id, username, name, avatar_url)\n      ",{count:"exact"}).eq("rating_id",e).order("created_at",{ascending:!1}).range(r,r+t-1);if(s)throw s;let o=new Set;if(n&&i&&i.length>0){const e=i.map(e=>e.id),{data:t}=yield ee.from("content_like").select("comment_id").eq("user_id",n).in("comment_id",e);t&&(o=new Set(t.map(e=>e.comment_id)))}const l=new Map,c=[],u=new Map;return null==i||i.forEach(e=>{const t={id:e.id,userId:e.user_id,reviewId:e.rating_id,content:e.content,parentId:e.parent_comment_id||void 0,createdAt:e.created_at,updatedAt:e.updated_at,likeCount:e.like_count||0,isLiked:o.has(e.id),replies:[],user:e.user?{id:e.user.id,name:e.user.username||e.user.name,avatar_url:e.user.avatar_url}:void 0};l.set(t.id,t),t.parentId||u.set(t.id,t.id)}),l.forEach(e=>{if(e.parentId){let t=e.parentId,r=t,n=0;const i=10;for(;t&&i>n;){const e=l.get(t);if(!e||!e.parentId){r=t;break}t=e.parentId,n++}u.set(e.id,r)}}),l.forEach(e=>{var t;if(e.parentId){const r=u.get(e.id);if(r&&r!==e.id){const n=l.get(r);n?(e.parentId=r,null==(t=n.replies)||t.push(e)):c.push(e)}else c.push(e)}else c.push(e)}),c.forEach(e=>{e.replies&&e.replies.length>0&&e.replies.sort((e,t)=>new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime())}),{success:!0,data:c,count:a}}catch(i){return{success:!1,error:i instanceof Error?i.message:"Failed to fetch comments"}}}),Ie=(e,t,r,n)=>I(void 0,null,function*(){try{if(!e||isNaN(e))return{success:!1,error:"Invalid user ID"};if(!t||isNaN(t))return{success:!1,error:"Invalid review ID"};if(!r||0===r.trim().length)return{success:!1,error:"Comment content cannot be empty"};if(r.length>500)return{success:!1,error:"Comment content exceeds maximum length (500 characters)"};const i=q(r.trim());let s=n;if(n){const{data:e,error:t}=yield ee.from("comment").select("id, parent_comment_id").eq("id",n).single();if(t||!e)return{success:!1,error:"Parent comment not found"};e.parent_comment_id&&(s=e.parent_comment_id)}const{data:a,error:o}=yield ee.from("comment").insert({user_id:e,rating_id:t,content:i,parent_comment_id:s||null,is_published:!0}).select("\n        *,\n        user:comment_user_id_fkey(id, username, name, avatar_url)\n      ").single();if(o)throw o;return{success:!0,data:{id:a.id,userId:a.user_id,reviewId:a.rating_id,content:a.content,parentId:a.parent_comment_id||void 0,createdAt:a.created_at,updatedAt:a.updated_at,replies:[],user:a.user?{id:a.user.id,name:a.user.username||a.user.name,avatar_url:a.user.avatar_url}:void 0}}}catch(i){return{success:!1,error:i instanceof Error?i.message:"Failed to add comment"}}}),Se=(e,t)=>I(void 0,null,function*(){try{if(!e||isNaN(e))return{success:!1,error:"Invalid comment ID"};if(!t||0===t.trim().length)return{success:!1,error:"Comment content cannot be empty"};if(t.length>500)return{success:!1,error:"Comment content exceeds maximum length (500 characters)"};const r=yield le();if(!r)return{success:!1,error:"User not authenticated"};const{data:n,error:i}=yield ee.from("comment").select("id, user_id").eq("id",e).eq("user_id",r).single();if(i||!n)return{success:!1,error:"Comment not found or you do not have permission to edit it"};const s=q(t.trim()),{data:a,error:o}=yield ee.from("comment").update({content:s,updated_at:(new Date).toISOString()}).eq("id",e).select("\n        *,\n        user:comment_user_id_fkey(id, username, name, avatar_url)\n      ").single();if(o)throw o;return{success:!0,data:{id:a.id,userId:a.user_id,reviewId:a.rating_id,content:a.content,parentId:a.parent_comment_id||void 0,createdAt:a.created_at,updatedAt:a.updated_at,replies:[],user:a.user?{id:a.user.id,name:a.user.username||a.user.name,avatar_url:a.user.avatar_url}:void 0}}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Failed to edit comment"}}}),Ce=e=>I(void 0,null,function*(){try{if(!e||isNaN(e))return{success:!1,error:"Invalid comment ID"};const t=yield le();if(!t)return{success:!1,error:"User not authenticated"};const{data:r,error:n}=yield ee.from("comment").select("id, user_id").eq("id",e).eq("user_id",t).single();if(n||!r)return{success:!1,error:"Comment not found or you do not have permission to delete it"};const{error:i}=yield ee.from("comment").delete().eq("id",e);if(i)throw i;return{success:!0,data:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to delete comment"}}}),Te=e=>I(void 0,null,function*(){try{if(!e||isNaN(e))return{success:!1,error:"Invalid review ID"};const t=yield le();if(!t)return{success:!1,error:"User not authenticated"};const{data:r,error:n}=yield ee.from("rating").select("id, user_id").eq("id",e).eq("user_id",t).single();if(n||!r)return{success:!1,error:"Review not found or you do not have permission to delete it"};const{error:i}=yield ee.from("rating").delete().eq("id",e);if(i)throw i;return{success:!0,data:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to delete review"}}}),Ee=(e=10)=>I(void 0,null,function*(){var t,r;try{const i=new AbortController,s=setTimeout(()=>i.abort(),15e3);try{const{data:n,error:a,count:o}=yield ee.from("rating").select("\n          id,\n          user_id,\n          game_id,\n          igdb_id,\n          rating,\n          review,\n          post_date_time,\n          playtime_hours,\n          is_recommended\n        ",{count:"exact"}).not("review","is",null).order("post_date_time",{ascending:!1}).limit(e).abortSignal(i.signal);if(clearTimeout(s),a)throw a;const l=[...new Set((null==n?void 0:n.map(e=>e.user_id))||[])],c=[...new Set((null==n?void 0:n.map(e=>e.game_id))||[])],[u,d]=yield Promise.all([l.length>0?ee.from("user").select("id, username, name, avatar_url").in("id",l):Promise.resolve({data:[]}),c.length>0?ee.from("game").select("id, name, cover_url, game_id, igdb_id").in("id",c):Promise.resolve({data:[]})]),h=new Map((null==(t=u.data)?void 0:t.map(e=>[e.id,e]))||[]),m=new Map((null==(r=d.data)?void 0:r.map(e=>[e.id,e]))||[]);return{success:!0,data:(null==n?void 0:n.map(e=>({id:e.id,userId:e.user_id,gameId:e.game_id,igdb_id:e.igdb_id,rating:e.rating,review:e.review,postDateTime:e.post_date_time,playtimeHours:e.playtime_hours,isRecommended:e.is_recommended,likeCount:0,commentCount:0,user:h.get(e.user_id)?{id:h.get(e.user_id).id,name:h.get(e.user_id).username||h.get(e.user_id).name,avatar_url:h.get(e.user_id).avatar_url}:void 0,game:m.get(e.game_id)?{id:m.get(e.game_id).id,name:m.get(e.game_id).name,cover_url:m.get(e.game_id).cover_url}:void 0})))||[],count:o}}catch(n){if(clearTimeout(s),"AbortError"===n.name)throw new Error("Review query timed out");throw n}}catch(i){return{success:!1,error:i instanceof Error?i.message:"Failed to fetch reviews"}}}),ke=new class{constructor(){D(this,"activeSearchId",null),D(this,"debounceTimer",null),D(this,"searchExecutor",null),D(this,"pendingRequests",new Map),D(this,"searchCache",new Map),D(this,"CACHE_TTL",3e5),D(this,"MAX_CACHE_SIZE",100),D(this,"duplicateCache",new Map),D(this,"SIMILARITY_THRESHOLD",.8),"undefined"!=typeof window&&setInterval(()=>this.cleanupCache(),6e4)}setExecutor(e){this.searchExecutor=e}requestSearch(e,t,r=1500,n=!1){return I(this,null,function*(){const i=`${e}-${Date.now()}-${Math.random()}`;this.cancelActiveSearch(),this.activeSearchId=i;const s={id:i,source:e,query:t,timestamp:Date.now()};this.pendingRequests.set(i,s),n?yield this.executeSearch(i):this.debounceTimer=setTimeout(()=>{this.executeSearch(i)},r)})}executeSearch(e){return I(this,null,function*(){const t=this.pendingRequests.get(e);if(t&&this.activeSearchId===e)try{this.searchExecutor&&(yield this.searchExecutor(t.query))}catch(r){}finally{this.pendingRequests.delete(e),this.activeSearchId===e&&(this.activeSearchId=null)}})}cancelActiveSearch(){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null),this.activeSearchId&&(this.pendingRequests.delete(this.activeSearchId),this.activeSearchId=null)}cleanupCache(){var e;const t=Date.now();for(const[r,n]of this.searchCache.entries())t-n.timestamp>this.CACHE_TTL&&this.searchCache.delete(r);if(this.searchCache.size>this.MAX_CACHE_SIZE){const e=Array.from(this.searchCache.entries()).sort((e,t)=>e[1].hits-t[1].hits).slice(0,this.searchCache.size-this.MAX_CACHE_SIZE);for(const[t]of e)this.searchCache.delete(t)}for(const[r,n]of this.duplicateCache.entries())t-(null==(e=n[0])?void 0:e.confidence)>this.CACHE_TTL&&this.duplicateCache.delete(r)}getCacheKey(e,t){return`${e}|${t?Object.keys(t).sort().map(e=>`${e}:${JSON.stringify(t[e])}`).join("|"):""}`}getCachedResults(e){const t=this.searchCache.get(e);return t?Date.now()-t.timestamp>this.CACHE_TTL?(this.searchCache.delete(e),null):(t.hits++,t):null}setCachedResults(e,t,r){this.searchCache.set(e,{results:t,total_count:r,timestamp:Date.now(),hits:0})}searchGames(e){return I(this,null,function*(){const t=Date.now(),{query:r,limit:n=20,exact_phrase:i=!1,genre_filter:s,platform_filter:a,release_year:o,min_rating:l}=e;if(!r||"string"!=typeof r)return{results:[],total_count:0,search_time_ms:Date.now()-t,query_used:"",cache_hit:!1};const c=O(r.trim());if(!c)return{results:[],total_count:0,search_time_ms:Date.now()-t,query_used:"",cache_hit:!1};const u=this.getCacheKey(c,e),d=this.getCachedResults(u);if(d)return b(w({},d),{search_time_ms:Date.now()-t,query_used:c,cache_hit:!0});try{const{data:e,error:r}=yield ee.rpc("secure_game_search",{search_query:c,search_limit:Math.min(n,100),use_phrase_search:i,genre_filters:s||null,platform_filters:a||null,release_year_filter:o||null,min_rating_filter:l||null});if(r)return{results:[],total_count:0,search_time_ms:Date.now()-t,query_used:c,cache_hit:!1};const d=e||[],h=yield this.deduplicateResults(d);return this.setCachedResults(u,h,h.length),{results:h,total_count:h.length,search_time_ms:Date.now()-t,query_used:c,cache_hit:!1,deduplicated_count:d.length-h.length}}catch(h){return{results:[],total_count:0,search_time_ms:Date.now()-t,query_used:c,cache_hit:!1}}})}coordinatedSearch(e){return I(this,arguments,function*(e,t={}){const{maxResults:r=20,includeMetrics:n=!1,fastMode:i=!1,bypassCache:s=!1,useAggressive:a=!1}=t,o={query:e,limit:r};if(s){const t=Date.now(),n=O(e.trim());if(!n)return{results:[],total_count:0,search_time_ms:Date.now()-t,query_used:"",cache_hit:!1};try{const{data:e,error:i}=yield ee.rpc("secure_game_search",{search_query:n,search_limit:Math.min(r,100),use_phrase_search:!1,genre_filters:null,platform_filters:null,release_year_filter:null,min_rating_filter:null});if(i||!e)return{results:[],total_count:0,search_time_ms:Date.now()-t,query_used:n,cache_hit:!1};const s=yield this.deduplicateResults(e);return{results:s,total_count:s.length,search_time_ms:Date.now()-t,query_used:n,cache_hit:!1}}catch(l){return{results:[],total_count:0,search_time_ms:Date.now()-t,query_used:n,cache_hit:!1}}}return yield this.searchGames(o)})}searchGamesByTitle(e,t=10){return I(this,null,function*(){const r={query:e,limit:t,exact_phrase:!1},n=yield this.searchGames(r);return this.convertToGameSearchResults(n.results)})}searchGamesByGenre(e,t=20){return I(this,null,function*(){const r={query:"*",limit:t,genre_filter:[e]},n=yield this.searchGames(r);return this.convertToGameSearchResults(n.results)})}getGameSuggestions(e,t=5){return I(this,null,function*(){if(2>e.length)return[];const r={query:e,limit:t,exact_phrase:!1},n=yield this.searchGames(r);return this.convertToGameSearchResults(n.results)})}searchGamesAdvanced(e){return I(this,arguments,function*(e,t={},r=20){const n={query:e,limit:r,genre_filter:t.genres,platform_filter:t.platforms,release_year:t.releaseYear,min_rating:t.minRating},i=yield this.searchGames(n);return this.convertToGameSearchResults(i.results)})}convertToGameSearchResults(e){return e.map(e=>({id:e.id,name:e.name,summary:e.summary,description:e.description,release_date:e.release_date,cover_url:e.cover_url,genres:e.genres||[],platforms:e.platforms||[],igdb_id:e.igdb_id,search_rank:e.search_rank,relevance_score:e.relevance_score,slug:e.name.toLowerCase().replace(/\s+/g,"-"),averageUserRating:0,totalUserRatings:0,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}))}deduplicateResults(e){return I(this,null,function*(){if(1>=e.length)return e;const t=this.detectDuplicates(e),r=[],n=new Set;for(const i of e){if(n.has(i.id))continue;const s=t.find(e=>e.canonical_id===i.id||e.duplicate_ids.includes(i.id));if(s){const t=e.find(e=>e.id===s.canonical_id)||i;r.push(t),n.add(s.canonical_id),s.duplicate_ids.forEach(e=>n.add(e))}else r.push(i),n.add(i.id)}return r})}detectDuplicates(e){const t=[],r=new Set;for(let n=0;n<e.length;n++){if(r.has(e[n].id))continue;const i=[],s=e[n];for(let t=n+1;t<e.length;t++)r.has(e[t].id)||this.calculateSimilarity(s,e[t])<this.SIMILARITY_THRESHOLD||(i.push(e[t].id),r.add(e[t].id));i.length>0&&(t.push({canonical_id:s.id,duplicate_ids:i,confidence:Math.min(...i.map(t=>{const r=e.find(e=>e.id===t);return r?this.calculateSimilarity(s,r):0})),match_type:this.determineMatchType(s,i.map(t=>e.find(e=>e.id===t)))}),r.add(s.id))}return t}calculateSimilarity(e,t){if(e.igdb_id&&t.igdb_id&&e.igdb_id===t.igdb_id)return 1;if(e.name.toLowerCase()===t.name.toLowerCase())return.95;const r=e.name.toLowerCase(),n=t.name.toLowerCase(),i=1-this.levenshteinDistance(r,n)/Math.max(r.length,n.length);let s=0;if(e.release_date&&t.release_date){const r=new Date(e.release_date),n=new Date(t.release_date);s=Math.abs(r.getTime()-n.getTime())/864e5>365?0:.2}return i+s}levenshteinDistance(e,t){const r=Array(t.length+1).fill(null).map(()=>Array(e.length+1).fill(null));for(let n=0;n<=e.length;n++)r[0][n]=n;for(let n=0;n<=t.length;n++)r[n][0]=n;for(let n=1;n<=t.length;n++)for(let i=1;i<=e.length;i++){const s=e[i-1]===t[n-1]?0:1;r[n][i]=Math.min(r[n][i-1]+1,r[n-1][i]+1,r[n-1][i-1]+s)}return r[t.length][e.length]}determineMatchType(e,t){return t.some(t=>t.igdb_id&&e.igdb_id&&t.igdb_id===e.igdb_id)?"igdb":t.some(t=>t.name.toLowerCase()===e.name.toLowerCase())?"exact":"fuzzy"}searchWithAutoCorrection(e,t){return I(this,null,function*(){const r=yield this.searchGames(b(w({},t),{query:e}));if(r.results.length>0)return r;const n=this.generateCorrections(e);for(const i of n){const r=yield this.searchGames(b(w({},t),{query:i}));if(r.results.length>0)return b(w({},r),{query_used:`${i} (corrected from "${e}")`})}return r})}generateCorrections(e){const t=[];t.push(e.replace(/\s+/g," ").trim()),t.push(e.replace(/[^\w\s]/g,"").trim());const r=e.split(/\s+/);return r.length>1&&t.push(...r),t.filter(e=>e.length>1)}clearCache(){this.searchCache.clear(),this.duplicateCache.clear()}getCacheStats(){const e=Array.from(this.searchCache.values()).reduce((e,t)=>e+t.hits,0),t=this.searchCache.size;return{size:t,hitRate:t>0?e/t:0}}isSearchActive(){return null!==this.activeSearchId}},Pe=new class{constructor(){D(this,"memoryCache",new Map),D(this,"maxMemoryItems",100)}get(e){const t=this.memoryCache.get(e);return t&&t.expiresAt>Date.now()?t.data:(t&&this.memoryCache.delete(e),null)}set(e,t,r=300){const n=Date.now()+1e3*r;if(this.memoryCache.set(e,{data:t,timestamp:Date.now(),expiresAt:n}),this.memoryCache.size>this.maxMemoryItems){const e=Array.from(this.memoryCache.entries());e.sort((e,t)=>e[1].timestamp-t[1].timestamp);const t=Math.floor(.2*this.maxMemoryItems);for(let r=0;t>r;r++)this.memoryCache.delete(e[r][0])}}remove(e){this.memoryCache.delete(e)}clear(){this.memoryCache.clear()}cleanup(){const e=Date.now();for(const[t,r]of this.memoryCache.entries())r.expiresAt>e||this.memoryCache.delete(t)}getStats(){const e=Date.now();let t=0,r=0;for(const n of this.memoryCache.values())n.expiresAt>e?t++:r++;return{totalItems:this.memoryCache.size,validItems:t,expiredItems:r,maxItems:this.maxMemoryItems}}};let Ae=null;"undefined"!=typeof window&&(Ae=new class{constructor(){D(this,"cleanupInterval",null),D(this,"isDestroyed",!1),D(this,"CLEANUP_INTERVAL_MS",3e5),D(this,"handleBeforeUnload",()=>{this.destroy()}),D(this,"handleVisibilityChange",()=>{document.hidden?this.stopCleanupInterval():this.isDestroyed||this.startCleanupInterval()}),"undefined"!=typeof window&&(this.startCleanupInterval(),this.setupEventListeners())}setupEventListeners(){"undefined"!=typeof window&&(window.addEventListener("beforeunload",this.handleBeforeUnload),window.addEventListener("pagehide",this.handleBeforeUnload),document.addEventListener("visibilitychange",this.handleVisibilityChange))}startCleanupInterval(){if(!this.isDestroyed){this.stopCleanupInterval();try{this.cleanupInterval=setInterval(()=>{try{!this.isDestroyed&&Pe&&Pe.cleanup()}catch(e){}},this.CLEANUP_INTERVAL_MS)}catch(e){}}}stopCleanupInterval(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null)}removeEventListeners(){"undefined"!=typeof window&&(window.removeEventListener("beforeunload",this.handleBeforeUnload),window.removeEventListener("pagehide",this.handleBeforeUnload),document.removeEventListener("visibilitychange",this.handleVisibilityChange))}destroy(){if(!this.isDestroyed){this.isDestroyed=!0,this.stopCleanupInterval(),this.removeEventListeners();try{Pe&&Pe.cleanup()}catch(e){}}}restart(){this.isDestroyed||this.startCleanupInterval()}getStatus(){return{isActive:!!this.cleanupInterval,isDestroyed:this.isDestroyed,intervalMs:this.CLEANUP_INTERVAL_MS}}},window.__cacheManager=Ae);const Re=new class{getBulkLikeStatus(e,t){return I(this,null,function*(){const r=new Map;if(!t||0===t.length)return r;try{const{data:n,error:i}=yield ee.from("rating").select("id, like_count").in("id",t);let s=new Set;if(e&&e>0){const{data:r,error:n}=yield ee.from("content_like").select("rating_id").eq("user_id",e).in("rating_id",t).not("rating_id","is",null);n||r&&(s=new Set(r.map(e=>e.rating_id)))}t.forEach(e=>{const t=null==n?void 0:n.find(t=>t.id===e);r.set(e,{liked:s.has(e),count:(null==t?void 0:t.like_count)||0})})}catch(n){}return r})}toggleReviewLike(e,t){return I(this,null,function*(){try{const{data:r,error:n}=yield ee.from("content_like").select("id").eq("user_id",e).eq("rating_id",t).maybeSingle();if(n)throw n;let i=!1;if(r){const{error:e}=yield ee.from("content_like").delete().eq("id",r.id);if(e)throw e;i=!1}else{const{error:r}=yield ee.from("content_like").insert({user_id:e,rating_id:t,is_like:!0});if(r){if("23505"===r.code)return{success:!0,data:{liked:!0,count:0},error:"Already liked"};throw r}i=!0}const{data:s,error:a}=yield ee.from("rating").select("like_count").eq("id",t).single();return{success:!0,data:{liked:i,count:(null==s?void 0:s.like_count)||0}}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Failed to toggle like"}}})}getReviewLikeStatus(e,t){return I(this,null,function*(){return(yield this.getBulkLikeStatus(e,[t])).get(t)||{liked:!1,count:0}})}hasUserLikedReview(e,t){return I(this,null,function*(){try{const{count:r,error:n}=yield ee.from("content_like").select("*",{count:"exact",head:!0}).eq("user_id",e).eq("rating_id",t);return!n&&(r||0)>0}catch(r){return!1}})}},Me="gamevault_privacy_consent",xe="gamevault_session_id",Ge="gamevault_consent_shown",$e=new class{constructor(){D(this,"userPreferences",null),D(this,"sessionId",null),this.initializeSession()}initializeSession(){let e=localStorage.getItem(xe);e||(e=this.generateSessionId(),localStorage.setItem(xe,e)),this.sessionId=e}generateSessionId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}hashSessionId(e){return I(this,null,function*(){const t=(new TextEncoder).encode(e),r=yield crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(r)).map(e=>e.toString(16).padStart(2,"0")).join("")})}getCurrentSessionHash(){return I(this,null,function*(){return this.sessionId||this.initializeSession(),this.hashSessionId(this.sessionId)})}shouldShowConsentBanner(){const e=localStorage.getItem(Ge),t=localStorage.getItem(Me);return!e||!t}markConsentBannerShown(){localStorage.setItem(Ge,"true")}getUserPreferences(e){return I(this,null,function*(){try{const{data:t,error:r}=yield ee.from("user_preferences").select("*").eq("user_id",e).single();return r&&"PGRST116"!==r.code?null:(this.userPreferences=t,t)}catch(t){return null}})}saveConsent(e,t){return I(this,null,function*(){try{if(localStorage.setItem(Me,JSON.stringify({analyticsOptedIn:e.analyticsOptedIn,trackingLevel:e.trackingLevel,timestamp:(new Date).toISOString()})),t){const r={user_id:t,analytics_opted_in:e.analyticsOptedIn,tracking_level:e.trackingLevel,consent_date:(new Date).toISOString(),consent_ip_country:e.ipCountry},{error:n}=yield ee.from("user_preferences").upsert(r,{onConflict:"user_id"});if(n)return{success:!1,error:n.message};yield this.logPrivacyAction(t,e.analyticsOptedIn?"consent_given":"consent_withdrawn",{tracking_level:e.trackingLevel},e.ipCountry),this.userPreferences=w({},r)}return{success:!0}}catch(r){return{success:!1,error:"Failed to save consent"}}})}withdrawConsent(e){return I(this,null,function*(){return this.saveConsent({analyticsOptedIn:!1,trackingLevel:"none"},e)})}getLocalConsent(){const e=localStorage.getItem(Me);if(!e)return null;try{const t=JSON.parse(e);return{analyticsOptedIn:t.analyticsOptedIn||!1,trackingLevel:t.trackingLevel||"anonymous"}}catch(t){return null}}hasTrackingConsent(e){return I(this,null,function*(){const t=this.getLocalConsent();if(t)return t.analyticsOptedIn;if(e){const t=yield this.getUserPreferences(e);return(null==t?void 0:t.analytics_opted_in)||!1}return!1})}getTrackingLevel(e){return I(this,null,function*(){const t=this.getLocalConsent();if(t)return t.trackingLevel;if(e){const t=yield this.getUserPreferences(e);return(null==t?void 0:t.tracking_level)||"anonymous"}return"anonymous"})}logPrivacyAction(e,t,r,n){return I(this,null,function*(){try{yield ee.from("privacy_audit_log").insert({user_id:e,action:t,details:r,ip_country:n})}catch(i){}})}getUserCountry(){return I(this,null,function*(){try{const e=yield fetch("https://ipapi.co/country/",{method:"GET",headers:{Accept:"text/plain"}});if(e.ok)return(yield e.text()).trim()}catch(e){}return null})}clearLocalData(){localStorage.removeItem(Me),localStorage.removeItem(xe),localStorage.removeItem(Ge),this.userPreferences=null,this.sessionId=null,this.initializeSession()}syncConsentWithDatabase(e){return I(this,null,function*(){try{const t=yield this.getUserPreferences(e);if(t)localStorage.setItem(Me,JSON.stringify({analyticsOptedIn:t.analytics_opted_in,trackingLevel:t.tracking_level,timestamp:t.consent_date||(new Date).toISOString()}));else{const t=this.getLocalConsent();t&&(yield this.saveConsent(t,e))}}catch(t){}})}shouldTrack(e){return I(this,null,function*(){const t=yield this.hasTrackingConsent(e),r=yield this.getTrackingLevel(e);return{allowed:t&&"none"!==r,level:r,sessionHash:yield this.getCurrentSessionHash()}})}getPrivacyStats(){return I(this,null,function*(){try{const{data:e,error:t}=yield ee.from("user_preferences").select("analytics_opted_in, tracking_level");return t?{totalUsers:0,optedIn:0,optedOut:0,anonymousOnly:0}:{totalUsers:(null==e?void 0:e.length)||0,optedIn:(null==e?void 0:e.filter(e=>e.analytics_opted_in).length)||0,optedOut:(null==e?void 0:e.filter(e=>!e.analytics_opted_in).length)||0,anonymousOnly:(null==e?void 0:e.filter(e=>"anonymous"===e.tracking_level).length)||0}}catch(e){return{totalUsers:0,optedIn:0,optedOut:0,anonymousOnly:0}}})}},Ue=new class{constructor(){D(this,"endpoint","/.netlify/functions/igdb-search")}buildEnhancedQuery(e,t={}){let r="\n      fields name, summary, storyline, slug, first_release_date, rating, \n      total_rating, total_rating_count, follows, hypes, category, \n      cover.url, screenshots.url, genres.name, platforms.name, \n      involved_companies.company.name, involved_companies.developer, \n      involved_companies.publisher, alternative_names.name, \n      collection.name, franchise.name, franchises.name, \n      parent_game, version_parent, url, dlcs, expansions, similar_games\n    ".trim()+"; ";const n=t.searchType||this.detectSearchType(e);if("franchise"===n){r+=`search "${e}"; `,r+=`where (category = (${(t.includeCategories||[0,2,4,8,9,10,11]).join(",")}) | version_parent != null | parent_game != null); `;const n=t.sortBy||"total_rating";r+="total_rating"===n?"sort total_rating desc; where total_rating != null; ":"follows"===n?"sort follows desc; ":`sort ${n} desc; `,r+=`limit ${t.limit||100}; `}else"specific"===n?(r+=`search "${e}"; `,r+=`where category != (${(t.excludeCategories||[5,7,13,14]).join(",")}); `,r+="sort follows desc; ",r+=`limit ${t.limit||50}; `):(r+=`search "${e}"; `,r+=`limit ${t.limit||50}; `);return r}multiQuerySearch(e){return I(this,null,function*(){const t=[];t.push({priority:100,description:"Exact match main games",query:this.buildQueryForExactMatch(e)}),this.isFranchiseSearch(e)&&t.push({priority:80,description:"Franchise search",query:this.buildQueryForFranchise(e)}),t.push({priority:60,description:"Alternative names",query:this.buildQueryForAlternativeNames(e)}),t.push({priority:40,description:"Collections",query:this.buildQueryForCollections(e)});const r=t.map(e=>I(this,null,function*(){try{const t=yield this.executeQuery(e.query);return b(w({},e),{results:t})}catch(t){return b(w({},e),{results:[]})}})),n=yield Promise.all(r);return this.mergeResultsByPriority(n)})}buildQueryForExactMatch(e){return`\n      fields name, summary, first_release_date, rating, total_rating, \n      total_rating_count, follows, category, cover.url, genres.name, \n      platforms.name, involved_companies.company.name, franchises.name;\n      where name ~ *"${e}"* & category = (0,8,9,10);\n      sort total_rating desc;\n      limit 100;\n    `.trim()}buildQueryForFranchise(e){return`\n      fields name, summary, first_release_date, rating, total_rating, \n      total_rating_count, follows, category, cover.url, genres.name, \n      platforms.name, involved_companies.company.name, franchises.name;\n      where franchises.name ~ *"${this.extractFranchiseName(e)}"*;\n      sort first_release_date asc;\n      limit 150;\n    `.trim()}buildQueryForAlternativeNames(e){return`\n      fields name, summary, first_release_date, rating, total_rating, \n      total_rating_count, follows, category, cover.url, genres.name, \n      platforms.name, involved_companies.company.name, alternative_names.name;\n      where alternative_names.name ~ *"${e}"*;\n      sort total_rating desc;\n      limit 50;\n    `.trim()}buildQueryForCollections(e){return`\n      fields name, summary, first_release_date, rating, total_rating, \n      total_rating_count, follows, category, cover.url, genres.name, \n      platforms.name, involved_companies.company.name, collection.name;\n      where collection.name ~ *"${e}"*;\n      sort first_release_date desc;\n      limit 100;\n    `.trim()}executeQuery(e){return I(this,null,function*(){const t=yield fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({isBulkRequest:!0,endpoint:"games",requestBody:e})});if(!t.ok)throw new Error(`IGDB API error: ${t.status}`);const r=yield t.json();if(!r.success)throw new Error(r.error||"IGDB API error");return r.games||[]})}mergeResultsByPriority(e){const t=new Set,r=[];e.sort((e,t)=>t.priority-e.priority);for(const n of e)for(const e of n.results)t.has(e.id)||(t.add(e.id),r.push(e));return r}detectSearchType(e){const t=e.toLowerCase();if(/\d+$/.test(t)||/\b(i{1,3}|iv|v|vi{1,3}|ix|x)\b/i.test(t)||t.includes(":")||t.includes("-"))return"specific";const r=["mario","zelda","pokemon","final fantasy","call of duty","assassin","grand theft auto","mega man","sonic","halo","god of war","uncharted","last of us","resident evil"];for(const n of r)if(t.includes(n))return"franchise";return"general"}isFranchiseSearch(e){return"franchise"===this.detectSearchType(e)}extractFranchiseName(e){const t=e.toLowerCase(),r={mario:"mario","super mario":"mario",zelda:"the legend of zelda",pokemon:"pok\xe9mon","final fantasy":"final fantasy",ff:"final fantasy",cod:"call of duty",gta:"grand theft auto",megaman:"mega man","mega man":"mega man"};for(const[n,i]of Object.entries(r))if(t.includes(n))return i;return e}searchWithSisterGames(e,t=20){return I(this,null,function*(){const r=yield this.multiQuerySearch(e),n=this.detectSisterGamePatterns(e);if(0===n.length)return r.slice(0,t);const i=n.map(e=>this.executeQuery(this.buildQueryForExactMatch(e)).catch(()=>[])),s=(yield Promise.all(i)).flat(),a=new Set(r.map(e=>e.id)),o=s.filter(e=>!a.has(e.id));return[...r,...o].slice(0,t)})}detectSisterGamePatterns(e){const t=e.toLowerCase(),r=[],n=[["red","blue","yellow","green"],["gold","silver","crystal"],["ruby","sapphire","emerald"],["diamond","pearl","platinum"],["black","white"],["x","y"],["sun","moon","ultra sun","ultra moon"],["sword","shield"],["scarlet","violet"]];if(t.includes("pokemon")||t.includes("pok\xe9mon"))for(const i of n)for(const e of i)if(t.includes(e)){for(const n of i)n!==e&&r.push(t.replace(e,n));break}if(t.includes("fire emblem")){const e=[["birthright","conquest","revelation"],["shadow dragon","new mystery"]];for(const n of e)for(const e of n)if(t.includes(e)){for(const i of n)i!==e&&r.push(t.replace(e,i));break}}return t.includes("oracle")&&(t.includes("ages")?r.push(t.replace("ages","seasons")):t.includes("seasons")&&r.push(t.replace("seasons","ages"))),r}expandSeriesSearch(e){const t=[e],r=e.toLowerCase(),n=r.match(/\d+$/);if(n){const e=r.replace(/\d+$/,"").trim(),i=parseInt(n[0]);for(let r=Math.max(1,i-2);i+2>=r;r++)r!==i&&t.push(`${e} ${r}`)}const i=["I","II","III","IV","V","VI","VII","VIII","IX","X"],s=new RegExp(`\\b(${i.join("|")})\\b`,"i"),a=e.match(s);if(a){const r=a[0].toUpperCase(),n=i.indexOf(r),o=e.replace(s,"").trim();t.push(`${o} ${n+1}`),n>0&&t.push(`${o} ${i[n-1]}`),n<i.length-1&&t.push(`${o} ${i[n+1]}`)}if(r.includes(":")||r.includes(" - ")){const r=e.split(/[:\-]/)[0].trim();t.push(r)}return[...new Set(t)]}},Ne=new class{constructor(){D(this,"endpoint","/.netlify/functions/igdb-search")}searchGames(e,t=20){return I(this,null,function*(){try{if(!e.trim())return[];let r;r=this.detectFranchiseSearch(e)?yield Ue.multiQuerySearch(e):yield this.performOptimizedSearch(e,t);const n=this.applyContentFilters(r,e);let i=this.applyCategoryFilters(n);if(i=this.filterByRelevance(i,e),i.length<t){const t=yield this.findSisterGames(e,i);t.length>0&&(i=this.mergeUnique(i,t))}return i.length>1&&(i=R(i,e)),this.applyPrioritization(i,e).slice(0,t)}catch(r){throw r}})}performOptimizedSearch(e,t){return I(this,null,function*(){const r=Ue.buildEnhancedQuery(e,{searchType:this.detectFranchiseSearch(e)?"franchise":"specific",limit:2*t,sortBy:"total_rating"}),n=yield fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({isBulkRequest:!0,endpoint:"games",requestBody:r})});if(!n.ok)throw new Error(`IGDB API error: ${n.status}`);const i=yield n.json();if(!i.success)throw new Error(i.error||"IGDB API error");return i.games||[]})}applyContentFilters(e,t){const r=e.map(e=>{var t,r,n,i,s,a,o,l,c,u;return{id:e.id,name:e.name,allNames:[e.name,...(null==(t=e.alternative_names)?void 0:t.map(e=>e.name))||[]].filter(Boolean),developer:null==(i=null==(n=null==(r=e.involved_companies)?void 0:r.find(e=>e.developer))?void 0:n.company)?void 0:i.name,publisher:null==(o=null==(a=null==(s=e.involved_companies)?void 0:s.find(e=>e.publisher))?void 0:a.company)?void 0:o.name,summary:e.summary,description:e.summary,category:e.category,genres:(null==(l=e.genres)?void 0:l.map(e=>e.name))||[],franchise:null==(c=e.franchise)?void 0:c.name,collection:null==(u=e.collection)?void 0:u.name}}),n=P(r);return A(r).filtered,n.map(t=>e.find(e=>e.id===t.id))}applyCategoryFilters(e){return e.filter(e=>{var t;if(7===e.category)return!1;if(14===e.category)return!1;if(3===e.category){const r=(null==(t=e.name)?void 0:t.toLowerCase())||"";if((r.includes("bundle")||r.includes("collection")||r.includes("anthology")||r.includes("compilation"))&&!r.includes("edition"))return!1}return!0})}filterByRelevance(e,t){const r=this.detectFranchiseSearch(t)?.08:.12;return e.filter(e=>this.calculateRelevance(e,t)>=r)}calculateRelevance(e,t){var r,n;const i=t.toLowerCase(),s=(null==(r=e.name)?void 0:r.toLowerCase())||"";let a=0;if(s===i)return 1;s.includes(i)&&(a+=.5);const o=i.split(/\s+/),l=s.split(/\s+/);return a+=o.filter(e=>l.some(t=>t.includes(e)||e.includes(t))).length/o.length*.3,(null==(n=e.franchises)?void 0:n.some(e=>e.name.toLowerCase().includes(i)))&&(a+=.2),Math.min(a,1)}findSisterGames(e,t){return I(this,null,function*(){const r=Ue.detectSisterGamePatterns(e);if(0===r.length)return[];const n=[];for(const e of r)try{const t=yield this.performOptimizedSearch(e,5);n.push(t)}catch(a){n.push([])}const i=n.flat(),s=new Set(t.map(e=>e.id));return i.filter(e=>!s.has(e.id))})}applyPrioritization(e,t){const r=e.map(e=>{var t,r,n,i,s,a,o;return b(w({},e),{genres:(null==(t=e.genres)?void 0:t.map(e=>e.name))||[],developer:null==(i=null==(n=null==(r=e.involved_companies)?void 0:r.find(e=>e.developer))?void 0:n.company)?void 0:i.name,publisher:null==(o=null==(a=null==(s=e.involved_companies)?void 0:s.find(e=>e.publisher))?void 0:a.company)?void 0:o.name,igdb_rating:e.rating})});return $(r).map(t=>e.find(e=>e.id===t.id)||t)}detectFranchiseSearch(e){const t=e.toLowerCase();return["mario","zelda","pokemon","final fantasy","call of duty","assassin","grand theft auto","mega man","sonic","halo","god of war","uncharted","last of us","resident evil","street fighter","mortal kombat","tekken"].some(e=>t.includes(e))}mergeUnique(e,t){const r=new Set(e.map(e=>e.id)),n=t.filter(e=>!r.has(e.id));return[...e,...n]}getGameById(e){return I(this,null,function*(){var t;try{const r=yield fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"getById",gameId:e})});if(!r.ok)throw new Error(`IGDB API error: ${r.status}`);const n=yield r.json();if(!n.success)throw new Error(n.error||"IGDB API error");return(null==(t=n.games)?void 0:t[0])||null}catch(r){throw r}})}testConnection(){return I(this,null,function*(){try{const e=yield fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({searchTerm:"test",limit:1})}),t=yield e.json();return e.ok&&t.success}catch(e){return!1}})}};class Be{constructor(){D(this,"cache",new Map),D(this,"maxSize",50),D(this,"ttl",3e5)}get(e){const t=this.cache.get(e);return t?Date.now()-t.timestamp>this.ttl?(this.cache.delete(e),null):(t.hits++,t.results):null}set(e,t){if(this.cache.size>=this.maxSize){const e=Array.from(this.cache.entries()).sort((e,t)=>e[1].hits-t[1].hits)[0];e&&this.cache.delete(e[0])}this.cache.set(e,{results:t,timestamp:Date.now(),hits:0})}clear(){this.cache.clear()}}const qe=new class{constructor(){D(this,"queryCache",new Be),D(this,"performanceLogs",[])}getGameById(e){return I(this,null,function*(){try{const{data:t,error:r}=yield ee.from("game").select("\n          *,\n          rating(rating)\n        ").eq("id",e).single();return r||!t?null:this.transformGameWithRatings(t)}catch(t){return null}})}getGameByIGDBId(e){return I(this,null,function*(){try{let{data:r,error:n}=yield ee.from("game").select("\n          *,\n          rating(rating)\n        ").eq("igdb_id",e).single();if((n||!r)&&e){const{data:t,error:i}=yield ee.from("game").select("\n            *,\n            rating(rating)\n          ").eq("game_id",e.toString()).single();!i&&t&&(r=t,n=null)}const i=r&&(!r.summary||!r.developer||!r.publisher||!r.cover_url);if(n||!r||i)try{const t=yield oe.getGameById(e);if(!t)return null;const n=oe.transformGame(t),s={igdb_id:n.igdb_id,game_id:n.igdb_id.toString(),name:n.name,slug:(null==r?void 0:r.slug)||F(n.name),summary:n.summary,description:n.description,release_date:n.first_release_date?"number"==typeof n.first_release_date?new Date(1e3*n.first_release_date).toISOString().split("T")[0]:new Date(n.first_release_date).toISOString().split("T")[0]:null,cover_url:n.cover_url,pic_url:n.cover_url,platforms:n.platforms||[],developer:n.developer,publisher:n.publisher,category:n.category||null,dlc_ids:n.dlcs||null,expansion_ids:n.expansions||null,updated_at:(new Date).toISOString()};let a,o;if(i){const{data:t,error:r}=yield ee.from("game").update(s).eq("igdb_id",e).select("\n                *,\n                rating(rating)\n              ").single();a=t,o=r}else{const{data:e,error:t}=yield ee.from("game").insert(b(w({},s),{created_at:(new Date).toISOString()})).select("\n                *,\n                rating(rating)\n              ").single();a=e,o=t}return o?b(w({},n),{averageUserRating:0,totalUserRatings:0,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}):this.transformGameWithRatings(a)}catch(t){return r?this.transformGameWithRatings(r):null}return this.transformGameWithRatings(r)}catch(r){return null}})}getGameWithFullReviews(e){return I(this,null,function*(){try{const{data:r,error:n}=yield ee.from("game").select("*").eq("igdb_id",e).single(),i=r&&(!r.summary||!r.developer||!r.publisher||!r.cover_url);if(n||!r||i)try{const t=yield oe.getGameById(e);if(!t)return{game:null,reviews:[]};const n=oe.transformGame(t),s={igdb_id:n.igdb_id,game_id:n.igdb_id.toString(),name:n.name,slug:(null==r?void 0:r.slug)||F(n.name),summary:n.summary,description:n.description,release_date:n.first_release_date?"number"==typeof n.first_release_date?new Date(1e3*n.first_release_date).toISOString().split("T")[0]:new Date(n.first_release_date).toISOString().split("T")[0]:null,cover_url:n.cover_url,pic_url:n.cover_url,screenshots:n.screenshots||null,genres:n.genres||[],platforms:n.platforms||[],developer:n.developer,publisher:n.publisher,igdb_rating:Math.round(n.igdb_rating||0),category:n.category||null,alternative_names:n.alternative_names||null,franchise_name:n.franchise||null,collection_name:n.collection||null,dlc_ids:n.dlcs||null,expansion_ids:n.expansions||null,similar_game_ids:n.similar_games||null,updated_at:(new Date).toISOString()};let a,o;if(i){const{data:t,error:r}=yield ee.from("game").update(s).eq("igdb_id",e).select().single();a=t,o=r}else{const{data:e,error:t}=yield ee.from("game").insert(b(w({},s),{created_at:(new Date).toISOString()})).select().single();a=e,o=t}return o?{game:b(w({},n),{averageUserRating:0,totalUserRatings:0,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}),reviews:[]}:{game:b(w({},a),{averageUserRating:0,totalUserRatings:0}),reviews:[]}}catch(t){if(!r)return{game:null,reviews:[]}}const{data:s,error:a}=yield ee.from("rating").select("\n          *,\n          user!fk_rating_user(\n            id,\n            name,\n            avatar_url\n          )\n        ").eq("game_id",r.id).order("post_date_time",{ascending:!1}),o=s||[];return{game:this.transformGameWithRatings(b(w({},r),{ratings:o.map(e=>({rating:e.rating}))})),reviews:o}}catch(r){return{game:null,reviews:[]}}})}getGameBySlug(e){return I(this,null,function*(){try{const{data:t,error:r}=yield ee.from("game").select("\n          *,\n          rating(rating)\n        ").eq("slug",e).single();return r||!t?null:this.transformGameWithRatings(t)}catch(t){return null}})}getGameWithFullReviewsBySlug(e){return I(this,null,function*(){try{const{data:t,error:r}=yield ee.from("game").select("*").eq("slug",e).single();if(r||!t)return{game:null,reviews:[]};if(t&&(!t.summary||!t.developer||!t.publisher||!t.cover_url)&&t.igdb_id)return yield this.getGameWithFullReviews(t.igdb_id);const{data:n,error:i}=yield ee.from("rating").select("\n          *,\n          user!fk_rating_user(\n            id,\n            name,\n            avatar_url\n          )\n        ").eq("game_id",t.id).order("post_date_time",{ascending:!1}),s=n||[];return{game:this.transformGameWithRatings(b(w({},t),{rating:s.map(e=>({rating:e.rating}))})),reviews:s}}catch(t){return{game:null,reviews:[]}}})}searchGames(e,t,r=200){return I(this,null,function*(){const n=O(e);if(!n)return[];const i=this.generateCacheKey(n,t),s=this.queryCache.get(i);if(s)return s;try{Date.now();const s=this.searchGamesExact(n,t,r),a=this.isCommonSearch(e)?Promise.resolve(null):this.getIGDBResultsConditionally(e),[o,l]=yield Promise.allSettled([s,a]),c="fulfilled"===o.status?o.value:[],u="fulfilled"===l.status&&l.value?l.value:null;if(Date.now(),u&&u.length>0&&this.shouldQueryIGDB(c,e,t)&&u){const t=yield this.smartMerge(c,u,e);return this.updateDatabaseAsync(u,e),this.queryCache.set(i,t),t}return this.queryCache.set(i,c),c}catch(a){return[]}})}getPopularGames(e=20){return I(this,null,function*(){try{const{data:t,error:r}=yield ee.from("game").select("\n          *,\n          rating(rating)\n        ").limit(3*e);if(r)throw r;return(t||[]).map(e=>this.transformGameWithRatings(e)).filter(e=>e.totalUserRatings>0).sort((e,t)=>{const r=t.totalUserRatings-e.totalUserRatings;return 0!==r?r:t.averageUserRating-e.averageUserRating}).slice(0,e)}catch(t){return[]}})}searchGamesExact(e,t,r=200){return I(this,null,function*(){var n,i;try{let s=ee.from("game").select("\n          *,\n          rating(rating)\n        ").ilike("name",`%${e}%`);if((null==(n=null==t?void 0:t.genres)?void 0:n.length)&&(s=s.contains("genres",t.genres)),(null==(i=null==t?void 0:t.platforms)?void 0:i.length)&&(s=s.contains("platforms",t.platforms)),null==t?void 0:t.releaseYear){const e=`${t.releaseYear}-01-01`,r=`${t.releaseYear}-12-31`;s=s.gte("release_date",e).lte("release_date",r)}s=s.limit(r);const{data:a,error:o}=yield s;if(o)throw o;let l=(a||[]).map(e=>this.transformGameWithRatings(e));return void 0!==(null==t?void 0:t.minRating)&&(l=l.filter(e=>e.averageUserRating>=t.minRating)),l}catch(s){return[]}})}transformGameWithRatings(e){const t=e.ratings||[],r=t.length,n=r>0?t.reduce((e,t)=>e+t.rating,0)/r:0,i=e,{ratings:s}=i,a=((e,t)=>{var r={};for(var n in e)_.call(e,n)&&0>t.indexOf(n)&&(r[n]=e[n]);if(null!=e&&g)for(var n of g(e))0>t.indexOf(n)&&v.call(e,n)&&(r[n]=e[n]);return r})(i,["ratings"]);return b(w({},a),{averageUserRating:Math.round(10*n)/10,totalUserRatings:r})}generateCacheKey(e,t){var r,n;const i=[e.toLowerCase()];return t&&((null==(r=t.genres)?void 0:r.length)&&i.push(`g:${t.genres.sort().join(",")}`),(null==(n=t.platforms)?void 0:n.length)&&i.push(`p:${t.platforms.sort().join(",")}`),t.minRating&&i.push(`r:${t.minRating}`),t.releaseYear&&i.push(`y:${t.releaseYear}`)),i.join("|")}shouldQueryIGDB(e,t,r){if(3>e.length)return!0;if(this.isFranchiseQuery(t)){if(10>e.length)return!0;if(e.some(e=>this.isStaleGame(e,6048e5)))return!0;if(e.length>=10&&.1>Math.random())return!0}return 5>e.length}isFranchiseQuery(e){const t=e.toLowerCase();return["mario","super mario","zelda","pokemon","final fantasy","ff","call of duty","cod","assassin","grand theft auto","gta","mega man","megaman","sonic","halo","god of war","uncharted","last of us","resident evil","street fighter","sf","mortal kombat","mk","tekken","elder scrolls","fallout","witcher","dark souls","metal gear","silent hill"].some(e=>t.includes(e))}isCommonSearch(e){const t=e.toLowerCase().trim();return["mario","pokemon","zelda","final fantasy","sonic","mega man","street fighter","resident evil"].includes(t)}getIGDBResultsConditionally(e){return I(this,null,function*(){try{const t=new Promise(e=>{setTimeout(()=>e(null),3e3)}),r=this.getIGDBResults(e);return yield Promise.race([r,t])}catch(t){return null}})}getIGDBResults(e){return I(this,null,function*(){try{return this.isFranchiseQuery(e)?yield Ne.searchGames(e,40):yield Ne.searchGames(e,30)}catch(t){throw t}})}smartMerge(e,t,r){return I(this,null,function*(){const n=this.convertIGDBToLocal(t),i=new Set,s=new Set;for(const t of e){t.igdb_id&&i.add(t.igdb_id);const e=this.normalizeGameNameWithPlatforms(t.name,t.platforms);s.add(e)}const a=n.filter(e=>{if(e.igdb_id&&i.has(e.igdb_id))return!1;const t=this.normalizeGameNameWithPlatforms(e.name,e.platforms);return!s.has(t)}),o=[...e,...a];return this.sortByRelevance(o,r)})}normalizeGameName(e){return e.toLowerCase().replace(/[^\w\s]/g,"").replace(/\s+/g," ").trim()}normalizeGameNameWithPlatforms(e,t){return`${this.normalizeGameName(e)}|${t&&t.length>0?t[0].toLowerCase().replace(/[^\w\s]/g,"").trim():"unknown"}`}isStaleGame(e,t){return!e.updated_at||Date.now()-new Date(e.updated_at).getTime()>t}convertIGDBToLocal(e){return e.map(e=>{var t,r,n,i,s,a,o,l,c;return{id:-(e.id||0),igdb_id:e.id||0,name:e.name||"Unknown Game",slug:F(e.name||"unknown-game"),summary:e.summary||"",release_date:e.first_release_date?new Date(1e3*e.first_release_date).toISOString().split("T")[0]:null,cover_url:(null==(t=e.cover)?void 0:t.url)?this.transformImageUrl(e.cover.url):null,genres:(null==(r=e.genres)?void 0:r.map(e=>e.name))||[],platforms:(null==(n=e.platforms)?void 0:n.map(e=>e.name))||[],developer:(null==(a=null==(s=null==(i=e.involved_companies)?void 0:i.find(e=>e.developer))?void 0:s.company)?void 0:a.name)||"",publisher:(null==(c=null==(l=null==(o=e.involved_companies)?void 0:o.find(e=>e.publisher))?void 0:l.company)?void 0:c.name)||"",igdb_rating:Math.round(e.rating||0),created_at:(new Date).toISOString(),updated_at:(new Date).toISOString(),averageUserRating:0,totalUserRatings:0,m:!0}})}transformImageUrl(e){return e?e.replace("t_thumb","t_1080p").replace("//","https://"):""}sortByRelevance(e,t){const r=t.toLowerCase();return e.sort((e,t)=>{const n=this.calculateRelevanceScore(e,r),i=this.calculateRelevanceScore(t,r);if(n!==i)return i-n;const s=!e.m,a=!t.m;return s&&!a?-1:!s&&a?1:e.name.localeCompare(t.name)})}calculateRelevanceScore(e,t){const r=e.name.toLowerCase();let n=0;if(r===t)n+=100;else if(r.startsWith(t))n+=80;else if(r.includes(t))n+=60;else{const e=t.split(/\s+/),i=r.split(/\s+/);n+=e.filter(e=>i.some(t=>t.includes(e)||e.includes(t))).length/e.length*40}const i=e.total_rating;i?n+=90>i?80>i?70>i?.285*i:20+1.5*(i-70):i-80+35:45+.5*(i-90):e.igdb_rating>0&&(n+=25*Math.pow(e.igdb_rating/100,1.5));const s=e.rating_count||0;return 1e3>s?500>s?100>s?20>s?s>0&&(n+=s/2):n+=10+(s-20)/8:n+=20+(s-100)/50:n+=28+(s-500)/71.4:n+=35+Math.min((s-1e3)/100,10),n}updateDatabaseAsync(e,t){return I(this,null,function*(){setTimeout(()=>I(this,null,function*(){var t,r,n,i,s,a,o,l,c;try{for(const u of e.slice(0,5)){if(!u.id)continue;const{data:e}=yield ee.from("game").select("id").eq("igdb_id",u.id).single();if(e)continue;const d={igdb_id:u.id,game_id:u.id.toString(),name:u.name||"Unknown Game",slug:yield L(u.name||"unknown-game"),summary:u.summary||"",release_date:u.first_release_date?new Date(1e3*u.first_release_date).toISOString().split("T")[0]:null,cover_url:(null==(t=u.cover)?void 0:t.url)?this.transformImageUrl(u.cover.url):null,genres:(null==(r=u.genres)?void 0:r.map(e=>e.name))||[],platforms:(null==(n=u.platforms)?void 0:n.map(e=>e.name))||[],developer:(null==(a=null==(s=null==(i=u.involved_companies)?void 0:i.find(e=>e.developer))?void 0:s.company)?void 0:a.name)||"",publisher:(null==(c=null==(l=null==(o=u.involved_companies)?void 0:o.find(e=>e.publisher))?void 0:l.company)?void 0:c.name)||"",igdb_rating:Math.round(u.rating||0),created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()};yield ee.from("game").insert(d)}}catch(u){}}),0)})}clearCache(){this.queryCache.clear()}},Fe=e=>I(void 0,null,function*(){try{const t=yield le();if(!t)return{success:!1,error:"User not authenticated"};const{data:r,error:n}=yield ee.from("game").select("id").eq("igdb_id",e).single();if(n&&"PGRST116"!==n.code)return{success:!1,error:`Game lookup failed: ${n.message}`};if(!r)return{success:!0,data:null};const{data:i,error:s}=yield ee.from("game_progress").select("*").eq("user_id",t).eq("game_id",r.id).single();return s&&"PGRST116"!==s.code?{success:!1,error:`Failed to fetch game progress: ${s.message}`}:{success:!0,data:i||null}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get game progress"}}}),Oe=e=>I(void 0,null,function*(){try{const t=yield le();if(!t)return{success:!1,error:"User not authenticated"};const{data:r,error:n}=yield ee.from("game").select("id").eq("igdb_id",e).single();if(n&&"PGRST116"!==n.code)return{success:!1,error:`Game lookup failed: ${n.message}`};if(!r)return{success:!1,error:"Game must be added to database first"};const i=(new Date).toISOString(),{data:s}=yield ee.from("game_progress").select("*").eq("user_id",t).eq("game_id",r.id).single();let a;if(s){const{data:e,error:n}=yield ee.from("game_progress").update({started:!0,started_date:s.started_date||i,updated_at:i}).eq("user_id",t).eq("game_id",r.id).select("*").single();a={data:e,error:n}}else{const{data:n,error:s}=yield ee.from("game_progress").insert({user_id:t,game_id:r.id,igdb_id:e,started:!0,completed:!1,started_date:i,created_at:i,updated_at:i}).select("*").single();a={data:n,error:s}}return a.error?{success:!1,error:`Failed to mark game as started: ${a.error.message}`}:{success:!0,data:a.data}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to mark game as started"}}}),Le=e=>I(void 0,null,function*(){try{const t=yield le();if(!t)return{success:!1,error:"User not authenticated"};const{data:r,error:n}=yield ee.from("game").select("id").eq("igdb_id",e).single();if(n&&"PGRST116"!==n.code)return{success:!1,error:`Game lookup failed: ${n.message}`};if(!r)return{success:!1,error:"Game must be added to database first"};const i=(new Date).toISOString(),{data:s}=yield ee.from("game_progress").select("*").eq("user_id",t).eq("game_id",r.id).single();let a;if(s){const{data:e,error:n}=yield ee.from("game_progress").update({started:!0,completed:!0,started_date:s.started_date||i,completed_date:i,updated_at:i}).eq("user_id",t).eq("game_id",r.id).select("*").single();a={data:e,error:n}}else{const{data:n,error:s}=yield ee.from("game_progress").insert({user_id:t,game_id:r.id,igdb_id:e,started:!0,completed:!0,started_date:i,completed_date:i,created_at:i,updated_at:i}).select("*").single();a={data:n,error:s}}return a.error?{success:!1,error:`Failed to mark game as completed: ${a.error.message}`}:{success:!0,data:a.data}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to mark game as completed"}}}),Ve=(e,t=!1)=>I(void 0,null,function*(){try{if(t)return{success:!1,error:"Cannot change progress state - game has a review"};const r=yield le();if(!r)return{success:!1,error:"User not authenticated"};const n=yield Fe(e);if(!n.success)return n;const i=n.data;if(i&&i.started){const{data:t}=yield ee.from("game").select("id").eq("igdb_id",e).single();if(!t)return{success:!1,error:"Game not found in database"};const{error:n}=yield ee.from("game_progress").delete().eq("user_id",r).eq("game_id",t.id);return n?{success:!1,error:`Failed to unmark game: ${n.message}`}:{success:!0,data:null}}return Oe(e)}catch(r){return{success:!1,error:r instanceof Error?r.message:"Failed to toggle game state"}}}),ze=(e,t=!1)=>I(void 0,null,function*(){try{if(t)return{success:!1,error:"Cannot change progress state - game has a review"};const r=yield le();if(!r)return{success:!1,error:"User not authenticated"};const n=yield Fe(e);if(!n.success)return n;const i=n.data;if(i&&i.completed){const{data:t}=yield ee.from("game").select("id").eq("igdb_id",e).single();if(!t)return{success:!1,error:"Game not found in database"};const n=(new Date).toISOString(),{data:i,error:s}=yield ee.from("game_progress").update({completed:!1,completed_date:null,updated_at:n}).eq("user_id",r).eq("game_id",t.id).select("*").single();return s?{success:!1,error:`Failed to unmark game as completed: ${s.message}`}:{success:!0,data:i}}return Le(e)}catch(r){return{success:!1,error:r instanceof Error?r.message:"Failed to toggle game state"}}}),He=new class{constructor(){D(this,"endpoint","/.netlify/functions/igdb-search")}getDLCForGame(e){return I(this,null,function*(){try{const t=yield fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({isBulkRequest:!0,endpoint:"games",requestBody:`fields name, summary, first_release_date, cover.url, category, parent_game, involved_companies.company.name; where parent_game = ${e} & category != null & category != 0 & category < 5 & cover != null & involved_companies != null; sort first_release_date asc; limit 20;`})});if(!t.ok)return[];const r=yield t.json();return r.success?(r.games||[]).filter(e=>{var t,r;if(!(null==(t=e.cover)?void 0:t.url))return!1;if(!e.category||1>e.category||e.category>4)return!1;const n=(null==(r=e.name)?void 0:r.toLowerCase())||"";return!["mod","unofficial","fan","homebrew","patch","fix"].some(e=>n.includes(e))}):[]}catch(t){return[]}})}getModsForGame(e){return I(this,null,function*(){try{const t=yield fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({isBulkRequest:!0,endpoint:"games",requestBody:`fields name, summary, first_release_date, cover.url, category, parent_game, involved_companies.company.name, involved_companies.developer, involved_companies.publisher; where parent_game = ${e} & cover != null; sort first_release_date desc; limit 30;`})});if(!t.ok)return[];const r=yield t.json();return r.success?(r.games||[]).map(e=>{var t,r;let n="",i="";if(e.involved_companies)for(const s of e.involved_companies)s.developer&&(null==(t=s.company)?void 0:t.name)&&(n=s.company.name),s.publisher&&(null==(r=s.company)?void 0:r.name)&&(i=s.company.name);return b(w({},e),{developer:n,publisher:i})}).filter(e=>{var t,r;if(!(null==(t=e.cover)?void 0:t.url))return!1;const n=(null==(r=e.name)?void 0:r.toLowerCase())||"",i=["mod","unofficial","fan","homebrew","patch","remix","remaster","edition","enhanced","definitive"].some(e=>n.includes(e)),s=!e.category||e.category>4;return!(!i&&!s||["goty","game of the year","complete","legendary","special edition"].some(e=>n.includes(e))||V({id:e.id,name:e.name,developer:e.developer,publisher:e.publisher,category:e.category,summary:e.summary}))}).slice(0,15):[]}catch(t){return[]}})}getParentGame(e){return I(this,null,function*(){var t,r,n;try{const i=yield fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({isBulkRequest:!0,endpoint:"games",requestBody:`fields parent_game; where id = ${e};`})});if(!i.ok)return null;const s=yield i.json();if(!s.success||!(null==(r=null==(t=s.games)?void 0:t[0])?void 0:r.parent_game))return null;const a=s.games[0].parent_game,o=yield fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({isBulkRequest:!0,endpoint:"games",requestBody:`fields name, summary, first_release_date, cover.url, category; where id = ${a};`})});if(!o.ok)return null;const l=yield o.json();return l.success&&(null==(n=l.games)?void 0:n[0])||null}catch(i){return null}})}isDLC(e){return null!=e&&0!==e}getCategoryName(e){switch(e){case 0:case null:case void 0:return"Main Game";case 1:return"DLC";case 2:return"Expansion";case 3:return"Bundle";case 4:return"Standalone Expansion";default:return"Additional Content"}}transformImageUrl(e){return e?e.replace("t_thumb","t_cover_big").replace("//","https://"):""}},je=new class{checkGameProgress(e){return I(this,null,function*(){try{const t=yield le();if(!t)return!1;const{data:r}=yield ee.from("game_progress").select("started, completed").eq("user_id",t).eq("igdb_id",e).maybeSingle();return r&&(r.started||r.completed)}catch(t){return!1}})}ensureGameAndAdd(e,t,r,n){return I(this,null,function*(){var i,s,a;try{const s=yield le();if(!s)return{success:!1,error:"User not authenticated"};let a;if(r){const e=yield ce({id:0,igdb_id:t,name:r.name||"",cover_url:r.cover_url,genre:r.genre,release_date:r.release_date});e.success&&e.data&&(a=e.data.gameId)}if(!a){const{data:e}=yield ee.from("game").select("id").eq("igdb_id",t).maybeSingle();e&&(a=e.id)}const o=w(w({user_id:s,igdb_id:t},a&&{game_id:a}),n),{data:l,error:c}=yield ee.from(e).upsert(o,{onConflict:"user_id,igdb_id"}).select().single();if(c){let t="Failed to add game. Please try again.";return"23505"===c.code?t="user_collection"===e?"This game is already in your collection.":"This game is already in your wishlist.":"PGRST116"===c.code?t="Unable to verify game status. Please refresh and try again.":(null==(i=c.message)?void 0:i.includes("JWT"))&&(t="Your session has expired. Please sign in again."),{success:!1,error:t}}return{success:!0,data:l}}catch(o){let e="An unexpected error occurred. Please try again.";return o instanceof Error&&((null==(s=o.message)?void 0:s.includes("network"))?e="Network error. Please check your connection and try again.":(null==(a=o.message)?void 0:a.includes("timeout"))&&(e="Request timed out. Please try again.")),{success:!1,error:e}}})}removeFromTable(e,t){return I(this,null,function*(){var r;try{const n=yield le();if(!n)return{success:!1,error:"User not authenticated"};const{error:i}=yield ee.from(e).delete().eq("user_id",n).eq("igdb_id",t);if(i){let e="Failed to remove game. Please try again.";return"PGRST116"===i.code?e="Game not found in your list.":(null==(r=i.message)?void 0:r.includes("JWT"))&&(e="Your session has expired. Please sign in again."),{success:!1,error:e}}return{success:!0}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Failed to remove game"}}})}addToCollection(e,t){return I(this,null,function*(){return(yield this.checkGameProgress(e))?{success:!1,error:"This game is already in your progress list. Remove it from there first to add it to your collection."}:this.ensureGameAndAdd("user_collection",e,t)})}removeFromCollection(e){return I(this,null,function*(){return this.removeFromTable("user_collection",e)})}addToWishlist(e,t,r,n){return I(this,null,function*(){return(yield this.checkGameProgress(e))?{success:!1,error:"This game is already in your progress list. Remove it from there first to add it to your wishlist."}:this.ensureGameAndAdd("user_wishlist",e,t,{priority:r,notes:n})})}removeFromWishlist(e){return I(this,null,function*(){return this.removeFromTable("user_wishlist",e)})}isInCollection(e){return I(this,null,function*(){try{const t=yield le();if(!t)return!1;const{count:r}=yield ee.from("user_collection").select("*",{count:"exact",head:!0}).eq("user_id",t).eq("igdb_id",e);return(r||0)>0}catch(t){return!1}})}isInWishlist(e){return I(this,null,function*(){try{const t=yield le();if(!t)return!1;const{count:r}=yield ee.from("user_wishlist").select("*",{count:"exact",head:!0}).eq("user_id",t).eq("igdb_id",e);return(r||0)>0}catch(t){return!1}})}checkBothStatuses(e){return I(this,null,function*(){try{const t=yield le();if(!t)return{inCollection:!1,inWishlist:!1};const[r,n]=yield Promise.all([ee.from("user_collection").select("id",{count:"exact",head:!0}).eq("user_id",t).eq("igdb_id",e),ee.from("user_wishlist").select("id",{count:"exact",head:!0}).eq("user_id",t).eq("igdb_id",e)]);return{inCollection:(r.count||0)>0,inWishlist:(n.count||0)>0}}catch(t){return{inCollection:!1,inWishlist:!1}}})}getCollection(e){return I(this,null,function*(){try{const{data:t,error:r}=yield ee.from("user_collection").select("\n          *,\n          game:game_id (\n            id,\n            igdb_id,\n            name,\n            cover_url,\n            genre,\n            release_date,\n            slug\n          )\n        ").eq("user_id",e).order("added_at",{ascending:!1});return r?{success:!1,error:r.message,data:[]}:{success:!0,data:t||[]}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get collection",data:[]}}})}getWishlist(e){return I(this,null,function*(){try{const{data:t,error:r}=yield ee.from("user_wishlist").select("\n          *,\n          game:game_id (\n            id,\n            igdb_id,\n            name,\n            cover_url,\n            genre,\n            release_date,\n            slug\n          )\n        ").eq("user_id",e).order("priority",{ascending:!1}).order("added_at",{ascending:!1});return r?{success:!1,error:r.message,data:[]}:{success:!0,data:t||[]}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to get wishlist",data:[]}}})}getCollectionAndWishlistIds(e){return I(this,null,function*(){var t,r;try{const[n,i]=yield Promise.all([ee.from("user_collection").select("igdb_id").eq("user_id",e),ee.from("user_wishlist").select("igdb_id").eq("user_id",e)]);return{collectionIds:new Set((null==(t=n.data)?void 0:t.map(e=>e.igdb_id))||[]),wishlistIds:new Set((null==(r=i.data)?void 0:r.map(e=>e.igdb_id))||[])}}catch(n){return{collectionIds:new Set,wishlistIds:new Set}}})}toggleCollection(e,t){return I(this,null,function*(){if(yield this.isInCollection(e)){const t=yield this.removeFromCollection(e);return b(w({},t),{data:!1})}{if(yield this.checkGameProgress(e))return{success:!1,error:"Cannot add to collection: game already started or completed",data:!1};const r=yield this.addToCollection(e,t);return b(w({},r),{data:!0})}})}toggleWishlist(e,t){return I(this,null,function*(){if(yield this.isInWishlist(e)){const t=yield this.removeFromWishlist(e);return b(w({},t),{data:!1})}{if(yield this.checkGameProgress(e))return{success:!1,error:"Cannot add to wishlist: game already started or completed",data:!1};const r=yield this.addToWishlist(e,t);return b(w({},r),{data:!0})}})}moveFromWishlistToCollection(e,t){return I(this,null,function*(){try{if(yield this.checkGameProgress(e))return{success:!1,error:"Cannot move to collection: game already started or completed"};const[r,n]=yield Promise.all([this.removeFromWishlist(e),this.addToCollection(e,t)]);return r.success&&n.success?{success:!0}:{success:!1,error:r.error||n.error||"Failed to move game"}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Failed to move game"}}})}moveFromCollectionToWishlist(e,t){return I(this,null,function*(){try{if(yield this.checkGameProgress(e))return{success:!1,error:"Cannot move to wishlist: game already started or completed"};const[r,n]=yield Promise.all([this.removeFromCollection(e),this.addToWishlist(e,t)]);return r.success&&n.success?{success:!0}:{success:!1,error:r.error||n.error||"Failed to move game"}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Failed to move game"}}})}},We=new class{constructor(){D(this,"throttleCache",new Map),D(this,"batchQueue",[]),D(this,"batchTimer",null),D(this,"BATCH_SIZE",10),D(this,"BATCH_DELAY",5e3),D(this,"THROTTLE_DURATION",3e5),setInterval(()=>this.cleanThrottleCache(),6e4),"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{this.flushBatch()})}trackGameView(e,t,r){return I(this,null,function*(){try{const n=yield $e.shouldTrack(r);if(!n.allowed)return{success:!0,tracked:!1,reason:"User has not consented to tracking"};const i=`${e}-${n.sessionHash}`;if(this.isThrottled(i))return{success:!0,tracked:!1,reason:"View already tracked in this session recently"};let s=null;return"full"===n.level&&r&&(s=r),this.addToBatch({gameId:e,source:t,userId:s||void 0}),this.throttleCache.set(i,{gameId:e,sessionHash:n.sessionHash,timestamp:Date.now()}),{success:!0,tracked:!0}}catch(n){return{success:!1,tracked:!1,reason:"Tracking error occurred"}}})}addToBatch(e){this.batchQueue.push(e),this.batchQueue.length<this.BATCH_SIZE?this.scheduleBatch():this.processBatch()}scheduleBatch(){this.batchTimer||(this.batchTimer=setTimeout(()=>{this.processBatch()},this.BATCH_DELAY))}processBatch(){return I(this,null,function*(){if(0===this.batchQueue.length)return;this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null);const e=[...this.batchQueue];this.batchQueue=[];try{const t=yield $e.getCurrentSessionHash(),r=yield Promise.all(e.map(e=>I(this,null,function*(){return{game_id:e.gameId,user_id:e.userId||null,session_hash:t,view_source:e.source,view_date:(new Date).toISOString().split("T")[0]}}))),{error:n}=yield ee.from("game_views").insert(r);n&&(this.batchQueue.push(...e),this.scheduleBatch())}catch(t){this.batchQueue.push(...e),this.scheduleBatch()}})}flushBatch(){this.batchQueue.length>0&&(this.sendBeacon(this.batchQueue),this.batchQueue=[])}sendBeacon(e){return I(this,null,function*(){try{const t=yield $e.getCurrentSessionHash(),r={events:e.map(e=>({game_id:e.gameId,user_id:e.userId||null,session_hash:t,view_source:e.source,view_date:(new Date).toISOString().split("T")[0]}))},n="https://cqufmmnguumyhbkhgwdc.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxdWZtbW5ndXVteWhia2hnd2RjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MzU3MDUsImV4cCI6MjA2ODIxMTcwNX0.iP9jJM26Xa3-YeeB2YdYnqMK5JZyYcFY5_KXuLAZw-s";if(navigator.sendBeacon&&n&&i){const e=new Blob([JSON.stringify(r)],{type:"application/json"});navigator.sendBeacon(`${n}/rest/v1/game_views?on_conflict=id`,e)}}catch(t){}})}isThrottled(e){const t=this.throttleCache.get(e);return!!t&&Date.now()-t.timestamp<this.THROTTLE_DURATION}cleanThrottleCache(){const e=Date.now(),t=[];this.throttleCache.forEach((r,n)=>{e-r.timestamp>this.THROTTLE_DURATION&&t.push(n)}),t.forEach(e=>this.throttleCache.delete(e))}trackSearchResultClick(e,t){return I(this,null,function*(){return this.trackGameView(e,"search",t)})}trackRecommendationClick(e,t){return I(this,null,function*(){return this.trackGameView(e,"recommendation",t)})}trackListItemClick(e,t){return I(this,null,function*(){return this.trackGameView(e,"list",t)})}trackReviewView(e,t){return I(this,null,function*(){return this.trackGameView(e,"review",t)})}trackProfileGameView(e,t){return I(this,null,function*(){return this.trackGameView(e,"profile",t)})}getGameStats(e){return I(this,null,function*(){try{const t=new Date;t.setDate(t.getDate()-30);const{data:r,error:n}=yield ee.from("game_metrics_daily").select("total_views, unique_sessions, view_sources").eq("game_id",e).gte("metric_date",t.toISOString().split("T")[0]);return n?null:(null==r?void 0:r.reduce((e,t)=>({totalViews:e.totalViews+(t.total_views||0),uniqueSessions:e.uniqueSessions+(t.unique_sessions||0),viewsBySource:Object.entries(t.view_sources||{}).reduce((e,[t,r])=>b(w({},e),{[t]:(e[t]||0)+r}),e.viewsBySource)}),{totalViews:0,uniqueSessions:0,viewsBySource:{search:0,direct:0,recommendation:0,list:0,review:0,profile:0}}))||null}catch(t){return null}})}getCohortAnalysis(e,t){return I(this,null,function*(){try{const{data:r,error:n}=yield ee.from("game_views").select("user_id, view_date, session_hash").gte("view_date",e.toISOString().split("T")[0]).lte("view_date",t.toISOString().split("T")[0]).not("user_id","is",null);if(n)return[];const i=new Map,s=new Map;null==r||r.forEach(e=>{const t=e.view_date,r=e.user_id;i.has(t)||(i.set(t,new Set),s.set(t,new Map)),i.get(t).add(r);const n=s.get(t);n.set(r,(n.get(r)||0)+1)});const a=new Map;null==r||r.forEach(e=>{const t=e.view_date,r=e.user_id;i.forEach((e,n)=>{t>n&&e.has(r)&&(a.has(n)||a.set(n,new Set),a.get(n).add(r))})});const o=[];return i.forEach((e,t)=>{var r;const n=(null==(r=a.get(t))?void 0:r.size)||0,i=e.size,l=Array.from(s.get(t).values()).reduce((e,t)=>e+t,0);o.push({cohortDate:t,totalUsers:i,returningUsers:n,retentionRate:i>0?n/i*100:0,avgViewsPerUser:i>0?l/i:0})}),o.sort((e,t)=>e.cohortDate.localeCompare(t.cohortDate))}catch(r){return[]}})}getGamePerformanceTrends(e,t=8){return I(this,null,function*(){try{const r=new Date;r.setDate(r.getDate()-7*t);const{data:n,error:i}=yield ee.from("game_metrics_daily").select("game_id, metric_date, total_views, unique_sessions").in("game_id",e).gte("metric_date",r.toISOString().split("T")[0]).order("metric_date",{ascending:!0});if(i)return[];const s=new Map;null==n||n.forEach(e=>{const t=this.getWeekStart(new Date(e.metric_date)).toISOString().split("T")[0];s.has(e.game_id)||s.set(e.game_id,[]);const r=s.get(e.game_id),n=r.find(e=>e.week===t);n?(n.views+=e.total_views,n.uniqueSessions+=e.unique_sessions):r.push({week:t,views:e.total_views,uniqueSessions:e.unique_sessions})});const a=[];return s.forEach((e,t)=>{e.sort((e,t)=>e.week.localeCompare(t.week));const r=e.map((t,r)=>{const n=r>0?e[r-1]:null,i=n?(t.views-n.views)/n.views*100:0;return b(w({},t),{changePercent:i})}),n=e.reduce((e,t)=>e+t.views,0),i=r.length>1?r.slice(1).reduce((e,t)=>e+t.changePercent,0)/(r.length-1):0;let s="stable";i>10?s="rising":-10>i&&(s="falling"),a.push({gameId:t,weeklyData:r,overallTrend:s,totalViews:n})}),a}catch(r){return[]}})}getSourceAttribution(e,t){return I(this,null,function*(){try{const{data:r,error:n}=yield ee.from("game_metrics_daily").select("view_sources").gte("metric_date",e.toISOString().split("T")[0]).lte("metric_date",t.toISOString().split("T")[0]);if(n)return[];const i=new Map;let s=0;null==r||r.forEach(e=>{const t=e.view_sources;Object.entries(t).forEach(([e,t])=>{const r=i.get(e)||0;i.set(e,r+t),s+=t})});const a=[];return i.forEach((e,t)=>{a.push({source:t,count:e,percentage:s>0?e/s*100:0})}),a.sort((e,t)=>t.count-e.count)}catch(r){return[]}})}getAnalyticsSummary(e=30){return I(this,null,function*(){try{const t=new Date,r=new Date;r.setDate(r.getDate()-e);const n=new Date(r);n.setDate(n.getDate()-e);const[i,s]=yield Promise.all([this.getPeriodStats(r,t),this.getPeriodStats(n,r)]);if(!i)return null;const a=yield this.getTopGames(r,t,10),o=yield this.getSourceAttribution(r,t);return{totalViews:i.totalViews,uniqueSessions:i.uniqueSessions,avgViewsPerSession:i.uniqueSessions>0?i.totalViews/i.uniqueSessions:0,topGames:a,sourceBreakdown:o,periodComparison:{current:i.totalViews,previous:(null==s?void 0:s.totalViews)||0,changePercent:s&&s.totalViews>0?(i.totalViews-s.totalViews)/s.totalViews*100:0}}}catch(t){return null}})}getPeriodStats(e,t){return I(this,null,function*(){const{data:r,error:n}=yield ee.from("game_metrics_daily").select("total_views, unique_sessions").gte("metric_date",e.toISOString().split("T")[0]).lte("metric_date",t.toISOString().split("T")[0]);return n?null:(null==r?void 0:r.reduce((e,t)=>({totalViews:e.totalViews+t.total_views,uniqueSessions:e.uniqueSessions+t.unique_sessions}),{totalViews:0,uniqueSessions:0}))||null})}getTopGames(e,t,r){return I(this,null,function*(){const{data:n,error:i}=yield ee.from("game_metrics_daily").select("game_id, total_views").gte("metric_date",e.toISOString().split("T")[0]).lte("metric_date",t.toISOString().split("T")[0]);if(i)return[];const s=new Map;return null==n||n.forEach(e=>{const t=s.get(e.game_id)||0;s.set(e.game_id,t+e.total_views)}),Array.from(s.entries()).map(([e,t])=>({gameId:e,views:t})).sort((e,t)=>t.views-e.views).slice(0,r)})}getWeekStart(e){const t=new Date(e),r=t.getDay(),n=t.getDate()-r;return new Date(t.setDate(n))}getTrendingGames(e=10){return I(this,null,function*(){try{const t=new Date,r=new Date(t);r.setDate(r.getDate()-1);const n=new Date(t);n.setDate(n.getDate()-7);const{data:i,error:s}=yield ee.from("game_metrics_daily").select("game_id, total_views").gte("metric_date",n.toISOString().split("T")[0]).lte("metric_date",r.toISOString().split("T")[0]);if(s)return[];const a=new Date(n);a.setDate(a.getDate()-7);const{data:o}=yield ee.from("game_metrics_daily").select("game_id, total_views").gte("metric_date",a.toISOString().split("T")[0]).lt("metric_date",n.toISOString().split("T")[0]),l=new Map,c=new Map;null==i||i.forEach(e=>{const t=l.get(e.game_id)||0;l.set(e.game_id,t+e.total_views)}),null==o||o.forEach(e=>{const t=c.get(e.game_id)||0;c.set(e.game_id,t+e.total_views)});const u=[];return l.forEach((e,t)=>{const r=c.get(t)||0;let n="stable";e>1.1*r?n="up":.9*r>e&&(n="down"),u.push({gameId:t,views:e,trend:n})}),u.sort((e,t)=>t.views-e.views).slice(0,e)}catch(t){return[]}})}},Je=[/googlebot/i,/bingbot/i,/slurp/i,/duckduckbot/i,/baiduspider/i,/yandexbot/i,/facebookexternalhit/i,/twitterbot/i,/linkedinbot/i,/whatsapp/i,/telegrambot/i,/ahrefsbot/i,/semrushbot/i,/mj12bot/i,/dotbot/i,/rogerbot/i,/exabot/i,/facebot/i,/ia_archiver/i,/bot/i,/crawler/i,/spider/i,/scraper/i,/curl/i,/wget/i,/python/i,/java/i,/go-http-client/i,/okhttp/i,/headlesschrome/i,/phantomjs/i,/slimerjs/i,/htmlunit/i,/zombie/i,/axios/i,/fetch/i,/postman/i,/insomnia/i,/httpie/i],Qe=[/^mozilla\/[45]\.0$/i,/^user-agent$/i,/windows nt 10\.0.*wow64.*windows nt 10\.0/i,/\(compatible;\s*;\s*\)/i,/mozilla\/5\.0.*gecko.*mozilla\/5\.0/i];class Ye{constructor(){D(this,"cache",new Map),D(this,"CACHE_TTL",3e5),D(this,"MAX_CACHE_SIZE",1e3),setInterval(()=>this.cleanCache(),6e4)}detect(e){return I(this,null,function*(){const t=performance.now(),r=this.getCacheKey(e),n=this.getFromCache(r);if(n)return b(w({},n),{performanceMs:performance.now()-t,cacheHit:!0});const i=yield this.performDetection(e);return this.setCache(r,b(w({},i),{performanceMs:performance.now()-t,cacheHit:!1})),b(w({},i),{performanceMs:performance.now()-t,cacheHit:!1})})}performDetection(e){return I(this,null,function*(){var t,r;const n=[],i=[];let s="low";try{const a=this.analyzeUserAgent(e.userAgent);if(a.isBot&&(n.push(...a.reasons),i.push(...a.flags),s="high"),(null==(t=e.headers)?void 0:t["cf-bot-score"])&&(parseInt(e.headers["cf-bot-score"])>30||(n.push("cloudflare_bot_score_low"),i.push("cf_bot_score"),s="high")),"true"===(null==(r=e.headers)?void 0:r["cf-verified-bot"])&&(n.push("cloudflare_verified_bot"),i.push("cf_verified_bot"),s="high"),e.behaviorData){const t=this.analyzeBehavior(e.behaviorData);t.suspicious&&(n.push(...t.reasons),i.push("suspicious_behavior"),"low"===s&&(s="medium"))}const o=this.analyzeSession(e.sessionId);return o.suspicious&&(n.push(...o.reasons),i.push("suspicious_session"),"low"===s&&(s="medium")),{isBot:"high"===s||n.length>=3,confidence:s,reasons:n,flags:i,performanceMs:0,cacheHit:!1}}catch(a){return{isBot:!1,confidence:"low",reasons:["detection_error"],flags:[],performanceMs:0,cacheHit:!1,error:a instanceof Error?a.message:"Unknown error"}}})}analyzeUserAgent(e){const t=[],r=[];for(const i of Je)if(i.test(e))return t.push("bot_pattern_match"),r.push("bot_ua"),{isBot:!0,reasons:t,flags:r};for(const i of Qe)i.test(e)&&(t.push("suspicious_user_agent"),r.push("suspicious_ua"));e&&e.length>=10||(t.push("missing_or_short_user_agent"),r.push("short_ua"));const n=["python","java","ruby","perl","php","node","go","rust"];for(const i of n)e.toLowerCase().includes(i)&&(t.push("programming_language_in_ua"),r.push("prog_lang_ua"));return{isBot:t.length>=2,reasons:t,flags:r}}analyzeBehavior(e){const t=[];return void 0!==e.viewDuration&&1e3>e.viewDuration&&t.push("extremely_fast_viewing"),0===e.clickEvents&&0===e.scrollEvents&&t.push("no_user_interaction"),void 0!==e.pageVisits&&e.pageVisits>50&&t.push("excessive_page_visits"),{suspicious:t.length>0,reasons:t}}analyzeSession(e){const t=[];/^\d{13}-[a-z0-9]{9}$/.test(e)||t.push("invalid_session_format");const r=e.split("-")[0];if(r){const e=parseInt(r),n=Date.now();(n-36e5>e||e>n+6e4)&&t.push("invalid_session_timestamp")}return{suspicious:t.length>0,reasons:t}}getCacheKey(e){return`${e.userAgent.slice(0,100)}_${e.headers?JSON.stringify(e.headers):""}`}getFromCache(e){const t=this.cache.get(e);return t?Date.now()-t.timestamp>this.CACHE_TTL?(this.cache.delete(e),null):t.result:null}setCache(e,t){if(this.cache.size>=this.MAX_CACHE_SIZE){const e=this.cache.keys().next().value;e&&this.cache.delete(e)}this.cache.set(e,{result:t,timestamp:Date.now()})}cleanCache(){const e=Date.now(),t=[];this.cache.forEach((r,n)=>{e-r.timestamp>this.CACHE_TTL&&t.push(n)}),t.forEach(e=>this.cache.delete(e))}getStats(){return I(this,null,function*(){return{totalDetections:0,botsDetected:0,cacheHitRate:0,averageDetectionTime:0}})}getCacheStats(){return{size:this.cache.size,maxSize:this.MAX_CACHE_SIZE,hitRate:0}}cleanup(){return I(this,null,function*(){this.cache.clear()})}}let Xe=null;const Ze=new class{exportUserData(e){return I(this,null,function*(){try{const{data:t,error:r}=yield ee.rpc("export_user_tracking_data",{p_user_id:e}),{data:n}=yield ee.from("user").select("*").eq("id",e).single(),{data:i}=yield ee.from("reviews").select("*").eq("user_id",e),{data:s}=yield ee.from("comments").select("*").eq("user_id",e),{data:a}=yield ee.from("activities").select("*").eq("user_id",e),{data:o}=yield ee.from("game_progress").select("*").eq("user_id",e),{data:l}=yield ee.from("follows").select("*").eq("follower_id",e),{data:c}=yield ee.from("follows").select("*").eq("following_id",e),{data:u}=yield ee.from("notifications").select("*").eq("user_id",e),d={exportDate:(new Date).toISOString(),userId:e,profile:n||{},preferences:(null==t?void 0:t.preferences)||{},gameViews:(null==t?void 0:t.game_views)||[],reviews:i||[],comments:s||[],activities:a||[],auditLog:(null==t?void 0:t.audit_log)||[],gameProgress:o||[],socialConnections:{following:l||[],followers:c||[]},notifications:u||[]};return yield $e.logPrivacyAction(e,"data_exported",{exported_at:(new Date).toISOString()}),d}catch(t){return null}})}deleteUserData(e){return I(this,arguments,function*(e,t={}){const{deleteReviews:r=!1,deleteComments:n=!1,anonymizeInstead:i=!0}=t;try{const t={success:!1,deletedItems:{gameViews:0,activities:0,notifications:0},anonymizedItems:{reviews:0,comments:0}},{data:s,error:a}=yield ee.rpc("delete_user_tracking_data",{p_user_id:e});if(a)return t.error=a.message,t;t.deletedItems.gameViews=(null==s?void 0:s.deleted_views)||0;const{data:o}=yield ee.from("activities").delete().eq("user_id",e).select();t.deletedItems.activities=(null==o?void 0:o.length)||0;const{data:l}=yield ee.from("notifications").delete().eq("user_id",e).select();if(t.deletedItems.notifications=(null==l?void 0:l.length)||0,i&&!r){const{data:r}=yield ee.from("reviews").update({user_id:null,username:"Anonymous User"}).eq("user_id",e).select();t.anonymizedItems.reviews=(null==r?void 0:r.length)||0}else if(r){const{data:r}=yield ee.from("reviews").delete().eq("user_id",e).select();t.deletedItems.reviews=(null==r?void 0:r.length)||0}if(i&&!n){const{data:r}=yield ee.from("comments").update({user_id:null,username:"Anonymous User"}).eq("user_id",e).select();t.anonymizedItems.comments=(null==r?void 0:r.length)||0}else if(n){const{data:r}=yield ee.from("comments").delete().eq("user_id",e).select();t.deletedItems.comments=(null==r?void 0:r.length)||0}return yield ee.from("follows").delete().or(`follower_id.eq.${e},following_id.eq.${e}`),yield ee.from("game_progress").delete().eq("user_id",e),t.success=!0,yield $e.logPrivacyAction(e,"data_deleted",{deleted_at:(new Date).toISOString(),items_deleted:t.deletedItems,items_anonymized:t.anonymizedItems}),t}catch(s){return{success:!1,deletedItems:{gameViews:0,activities:0,notifications:0},anonymizedItems:{reviews:0,comments:0},error:s instanceof Error?s.message:"Unknown error"}}})}getDataRetentionInfo(){return I(this,null,function*(){try{const{data:e}=yield ee.from("game_views").select("view_date").order("view_date",{ascending:!0}).limit(1).single(),{data:t}=yield ee.from("game_metrics_daily").select("metric_date").order("metric_date",{ascending:!0}).limit(1).single();return{gameViews:{retentionDays:90,oldestData:null==e?void 0:e.view_date,scheduledDeletion:e?this.getScheduledDeletionDate(e.view_date,90):void 0},aggregatedMetrics:{retentionDays:180,oldestData:null==t?void 0:t.metric_date},auditLogs:{retentionDays:730,purpose:"Legal compliance and security auditing"}}}catch(e){return{gameViews:{retentionDays:90},aggregatedMetrics:{retentionDays:180},auditLogs:{retentionDays:730,purpose:"Legal compliance"}}}})}getScheduledDeletionDate(e,t){const r=new Date(e);return r.setDate(r.getDate()+t),r.toISOString().split("T")[0]}requestDataDeletion(e,t){return I(this,null,function*(){try{const{data:r,error:n}=yield ee.from("privacy_audit_log").insert({user_id:e,action:"deletion_requested",details:{reason:t,requested_at:(new Date).toISOString(),scheduled_for:new Date(Date.now()+6048e5).toISOString()}}).select().single();return n?{success:!1,error:n.message}:{success:!0,requestId:r.id}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Unknown error"}}})}anonymizeOldData(){return I(this,null,function*(){try{const{data:e,error:t}=yield ee.rpc("cleanup_old_tracking_data");return t?{success:!1,anonymized:0,deleted:e||0}:{success:!0,anonymized:0,deleted:e||0}}catch(e){return{success:!1,anonymized:0,deleted:0}}})}getConsentHistory(e){return I(this,null,function*(){try{const{data:t,error:r}=yield ee.from("privacy_audit_log").select("action, created_at, details").eq("user_id",e).in("action",["consent_given","consent_withdrawn","preferences_updated"]).order("created_at",{ascending:!1});return r?[]:(null==t?void 0:t.map(e=>({action:e.action,date:e.created_at,details:e.details})))||[]}catch(t){return[]}})}generatePrivacyReport(){return I(this,null,function*(){try{const e=yield $e.getPrivacyStats(),{data:t}=yield ee.from("game_views").select("user_id").limit(1e3),r=(null==t?void 0:t.filter(e=>!e.user_id).length)||0,n=(null==t?void 0:t.length)||0,i=new Date;i.setDate(i.getDate()-30);const{data:s}=yield ee.from("privacy_audit_log").select("action").in("action",["data_exported","data_deleted"]).gte("created_at",i.toISOString()),a=(null==s?void 0:s.filter(e=>"data_exported"===e.action).length)||0,o=(null==s?void 0:s.filter(e=>"data_deleted"===e.action).length)||0;return{totalUsers:e.totalUsers,consentStats:{optedIn:e.optedIn,optedOut:e.optedOut,percentage:e.totalUsers>0?Math.round(e.optedIn/e.totalUsers*100):0},dataStats:{totalViews:n,anonymousViews:r,averageRetention:90},complianceStats:{dataExports:a,dataDeletions:o,averageResponseTime:"< 24 hours"}}}catch(e){return null}})}},Ke=new class{constructor(){D(this,"sessionId"),D(this,"batchQueue",[]),D(this,"batchTimer",null),D(this,"BATCH_SIZE",10),D(this,"BATCH_DELAY",5e3),D(this,"metrics",new Map),D(this,"performanceData",[]),D(this,"MAX_METRIC_POINTS",1e3),D(this,"diagnosticData",new Map),D(this,"MAX_DIAGNOSTIC_ENTRIES",100),this.sessionId=this.generateSessionId(),"undefined"!=typeof window&&this.startBatchProcessor()}trackSearch(e,t,r){return I(this,null,function*(){const n={query:e,normalized_query:this.normalizeQuery(e),result_count:t.total_count,execution_time_ms:t.search_time_ms,cache_hit:t.cache_hit||!1,user_id:r,session_id:this.sessionId,created_at:(new Date).toISOString()};this.batchQueue.push(n),this.batchQueue.length<this.BATCH_SIZE||(yield this.flushBatch()),this.updatePerformanceMetrics(n)})}flushBatch(){return I(this,null,function*(){if(0===this.batchQueue.length)return;const e=[...this.batchQueue];this.batchQueue=[];try{const{error:t}=yield ee.from("search_analytics").insert(e);t&&this.batchQueue.unshift(...e.slice(-5))}catch(t){}})}startBatchProcessor(){this.batchTimer=setInterval(()=>{this.batchQueue.length>0&&this.flushBatch()},this.BATCH_DELAY)}normalizeQuery(e){return e.toLowerCase().trim().replace(/\s+/g," ").replace(/[^\w\s]/g,"")}getSearchMetrics(e=7){return I(this,null,function*(){try{const{data:t,error:r}=yield ee.from("search_analytics").select("execution_time_ms, result_count, cache_hit").gte("created_at",new Date(Date.now()-24*e*60*60*1e3).toISOString());if(r)throw r;if(!t||0===t.length)return{avgExecutionTime:0,medianExecutionTime:0,p95ExecutionTime:0,totalSearches:0,cacheHitRate:0,zeroResultSearches:0,errorRate:0};const n=t.map(e=>e.execution_time_ms).sort((e,t)=>e-t),i=t.filter(e=>e.cache_hit).length,s=t.filter(e=>0===e.result_count).length;return{avgExecutionTime:n.reduce((e,t)=>e+t,0)/n.length,medianExecutionTime:n[Math.floor(n.length/2)],p95ExecutionTime:n[Math.floor(.95*n.length)],totalSearches:t.length,cacheHitRate:t.length>0?i/t.length:0,zeroResultSearches:s,errorRate:0}}catch(t){throw t}})}getPopularSearches(e=7,t=10){return I(this,null,function*(){try{const{data:r,error:n}=yield ee.from("search_analytics").select("normalized_query, execution_time_ms, result_count").gte("created_at",new Date(Date.now()-24*e*60*60*1e3).toISOString());if(n)throw n;if(!r)return[];const i=new Map;for(const e of r){const t=i.get(e.normalized_query)||{count:0,totalTime:0,totalResults:0};i.set(e.normalized_query,{count:t.count+1,totalTime:t.totalTime+e.execution_time_ms,totalResults:t.totalResults+e.result_count})}return Array.from(i.entries()).map(([e,t])=>({query:e,searchCount:t.count,avgResults:t.totalResults/t.count,avgTimeMs:t.totalTime/t.count})).sort((e,t)=>t.searchCount-e.searchCount).slice(0,t)}catch(r){return[]}})}getSearchTrends(e=7){return I(this,null,function*(){const t=new Date(Date.now()-24*e*60*60*1e3),r=new Date(Date.now()-2*e*24*60*60*1e3);try{const[e,n]=yield Promise.all([this.getQueryCounts(t,new Date),this.getQueryCounts(r,t)]),i=[],s=new Set([...e.keys(),...n.keys()]);for(const t of s){const r=e.get(t)||0,s=n.get(t)||0,a=s>0?(r-s)/s:r>0?1:0;i.push({query:t,currentCount:r,previousCount:s,growthRate:a})}return i.filter(e=>e.currentCount>0||e.previousCount>0).sort((e,t)=>Math.abs(t.growthRate)-Math.abs(e.growthRate)).slice(0,20)}catch(n){return[]}})}getQueryCounts(e,t){return I(this,null,function*(){const{data:r,error:n}=yield ee.from("search_analytics").select("normalized_query").gte("created_at",e.toISOString()).lt("created_at",t.toISOString());if(n)throw n;const i=new Map;for(const e of r||[])i.set(e.normalized_query,(i.get(e.normalized_query)||0)+1);return i})}updatePerformanceMetrics(e){const t=Date.now();this.performanceData.push({timestamp:t,value:e.execution_time_ms,metadata:{query:e.normalized_query,resultCount:e.result_count,cacheHit:e.cache_hit}}),this.performanceData.length>this.MAX_METRIC_POINTS&&(this.performanceData=this.performanceData.slice(-this.MAX_METRIC_POINTS)),this.updateMetricSeries("search_time",e.execution_time_ms,"ms","Search execution time"),this.updateMetricSeries("result_count",e.result_count,"count","Search result count"),this.updateMetricSeries("cache_hit_rate",e.cache_hit?1:0,"ratio","Cache hit rate")}updateMetricSeries(e,t,r,n){let i=this.metrics.get(e);i||(i={name:e,points:[],unit:r,description:n},this.metrics.set(e,i)),i.points.push({timestamp:Date.now(),value:t,metadata:{}}),i.points.length>this.MAX_METRIC_POINTS&&(i.points=i.points.slice(-this.MAX_METRIC_POINTS))}getMetricSeries(e){return this.metrics.get(e)||null}getAllMetrics(){return Array.from(this.metrics.values())}generatePerformanceReport(e=7){return I(this,null,function*(){const t=new Date,r=new Date(Date.now()-24*e*60*60*1e3),[n,i]=yield Promise.all([this.getSearchMetrics(e),this.getPopularSearches(e,10)]);return{timeRange:{start:r,end:t},totalSearches:n.totalSearches,avgResponseTime:n.avgExecutionTime,cacheHitRate:n.cacheHitRate,errorRate:n.errorRate,topQueries:i,performanceMetrics:n}})}diagnoseSearch(e,t,r){return I(this,null,function*(){const n={searchId:e,query:t,timestamp:Date.now(),executionPlan:{},performanceMetrics:{totalTime:r.search_time_ms,dbTime:.8*r.search_time_ms,cacheTime:r.cache_hit?1:0,processingTime:.2*r.search_time_ms},resultAnalysis:{totalResults:r.total_count,duplicatesFound:r.deduplicated_count||0,relevanceScores:r.results.map(e=>e.relevance_score||0),qualityMetrics:this.analyzeResultQuality(r.results)},issues:[]};if(n.issues=this.detectSearchIssues(n),this.diagnosticData.set(e,n),this.diagnosticData.size>this.MAX_DIAGNOSTIC_ENTRIES){const e=this.diagnosticData.keys().next().value;this.diagnosticData.delete(e)}return this.generateDiagnosticReport(n)})}analyzeResultQuality(e){if(0===e.length)return{averageCompleteness:0,hasImages:0,hasDescriptions:0};const t=e.map(e=>{let t=0;return e.name&&(t+=.3),e.summary&&(t+=.2),e.description&&(t+=.2),e.cover_url&&(t+=.15),e.release_date&&(t+=.15),t});return{averageCompleteness:t.reduce((e,t)=>e+t,0)/t.length,hasImages:e.filter(e=>e.cover_url).length/e.length,hasDescriptions:e.filter(e=>e.summary||e.description).length/e.length}}detectSearchIssues(e){const t=[];return e.performanceMetrics.totalTime>2e3&&t.push({type:"performance",severity:"high",message:"Search response time is slow",details:{actualTime:e.performanceMetrics.totalTime,threshold:2e3},suggestions:["Consider adding database indexes","Review query complexity","Check for slow network conditions"]}),0===e.resultAnalysis.totalResults&&t.push({type:"quality",severity:"medium",message:"Search returned no results",details:{query:e.query},suggestions:["Check for typos in search query","Try broader search terms","Verify database contains relevant data"]}),!e.performanceMetrics.cacheTime&&e.query.length>3&&t.push({type:"cache",severity:"low",message:"Cache miss for potentially cacheable query",details:{query:e.query},suggestions:["Review cache key generation","Check cache TTL settings","Consider pre-warming popular queries"]}),e.resultAnalysis.duplicatesFound>.2*e.resultAnalysis.totalResults&&t.push({type:"quality",severity:"medium",message:"High number of duplicate results detected",details:{duplicates:e.resultAnalysis.duplicatesFound,total:e.resultAnalysis.totalResults},suggestions:["Review deduplication algorithm","Check for database data quality issues","Consider improving similarity thresholds"]}),t}generateDiagnosticReport(e){const t=e.issues.filter(e=>"critical"===e.severity).length,r=e.issues.filter(e=>"high"===e.severity).length;let n="healthy";t>0?n="critical":(r>0||e.issues.length>3)&&(n="warning");const i=[];return e.performanceMetrics.totalTime>1e3&&i.push("Optimize query performance"),0===e.resultAnalysis.totalResults&&i.push("Improve search coverage and data quality"),e.resultAnalysis.duplicatesFound>0&&i.push("Enhance deduplication logic"),{searchId:e.searchId,summary:`Search completed in ${e.performanceMetrics.totalTime}ms with ${e.resultAnalysis.totalResults} results`,overallHealth:n,issues:e.issues,recommendations:i,metrics:{executionTime:e.performanceMetrics.totalTime,resultCount:e.resultAnalysis.totalResults,duplicateCount:e.resultAnalysis.duplicatesFound,qualityScore:e.resultAnalysis.qualityMetrics.averageCompleteness}}}getDiagnostic(e){return this.diagnosticData.get(e)||null}getAllDiagnostics(){return Array.from(this.diagnosticData.values())}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}cleanup(){return I(this,null,function*(){yield this.flushBatch(),this.batchTimer&&(clearInterval(this.batchTimer),this.batchTimer=null)})}getSessionId(){return this.sessionId}clearMetrics(){this.metrics.clear(),this.performanceData=[],this.diagnosticData.clear()}getIGDBStats(){return{dailyRequestCount:0,remainingQuota:450,currentRateLimit:0}}analyzeSingleSearch(e){return I(this,null,function*(){var t;const r=Date.now();try{const{gameSearchService:n}=yield H(()=>I(this,null,function*(){const{gameSearchService:e}=yield Promise.resolve().then(()=>ot);return{gameSearchService:e}}),void 0),i=yield n.searchGames({query:e},{limit:100}),s=Date.now()-r;return{query:e,timestamp:(new Date).toISOString(),dbResults:{nameSearchCount:i.games.length,summarySearchCount:0,totalCount:i.totalCount,duration:s,sampleGames:i.games.slice(0,5).map(e=>e.name)},filterAnalysis:{genreDistribution:this.analyzeDistribution(i.games,"genres"),platformDistribution:this.analyzeDistribution(i.games,"platforms"),releaseYearDistribution:{},ratingDistribution:this.analyzeRatingDistribution(i.games)},sortingAnalysis:{originalOrder:i.games.slice(0,10).map(e=>e.name),sortedByRating:[...i.games].sort((e,t)=>(t.avg_user_rating||0)-(e.avg_user_rating||0)).slice(0,10).map(e=>e.name),sortedByRelevance:i.games.slice(0,10).map(e=>e.name),topRatedGame:(null==(t=i.games[0])?void 0:t.name)||"N/A",averageRating:i.games.reduce((e,t)=>e+(t.avg_user_rating||0),0)/Math.max(i.games.length,1)},performance:{totalDuration:s,dbQueryTime:s,processingTime:0},resultAnalysis:{games:i.games.map(e=>({id:e.id,name:e.name,included:!0,filterReason:null,sortScore:0}))}}}catch(n){throw n}})}bulkTestQueries(e){return I(this,null,function*(){const t=[];for(const n of e)try{const e=yield this.analyzeSingleSearch(n);t.push(e)}catch(r){}return{testQueries:e,results:t,igdbUsageStats:{totalRequests:0,rateLimitHits:0,remainingQuota:450},patterns:{commonFilters:["Official games only","Main games prioritized"],performanceBottlenecks:t.some(e=>e.performance.totalDuration>2e3)?["Some queries exceeded 2s threshold"]:[],qualityIssues:t.filter(e=>0===e.dbResults.totalCount).map(e=>`No results for "${e.query}"`),recommendations:[t.every(e=>1e3>e.performance.totalDuration)?"Performance is good":"Consider caching optimizations",`Tested ${e.length} queries successfully`]}}})}analyzeDistribution(e,t){const r={};return e.forEach(e=>{(Array.isArray(e[t])?e[t]:[e[t]]).forEach(e=>{if(e){const t="string"==typeof e?e:String(e);r[t]=(r[t]||0)+1}})}),r}analyzeRatingDistribution(e){const t={"90-100":0,"80-89":0,"70-79":0,"60-69":0,"50-59":0,"<50":0};return e.forEach(e=>{const r=e.avg_user_rating||e.igdb_rating||0;90>r?80>r?70>r?60>r?50>r?t["<50"]++:t["50-59"]++:t["60-69"]++:t["70-79"]++:t["80-89"]++:t["90-100"]++}),t}};"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{Ke.cleanup()});const et=new class{setGameFlag(e,t,r){return I(this,null,function*(){var n;try{const{data:i}=yield ee.auth.getUser(),s=null==(n=null==i?void 0:i.user)?void 0:n.id,{data:a,error:o}=yield ee.rpc("set_game_flag",{p_game_id:e,p_flag_type:t,p_reason:r,p_user_id:s});return o?{success:!1,error:o.message}:{success:!0}}catch(i){return{success:!1,error:i.message}}})}getFlaggedGames(){return I(this,null,function*(){try{const{data:e,error:t}=yield ee.from("game_flags_admin").select("*").order("flagged_at",{ascending:!1});return t?{success:!1,error:t.message}:{success:!0,data:e||[]}}catch(e){return{success:!1,error:e.message}}})}getFlagSummary(){return I(this,null,function*(){try{const{data:e,error:t}=yield ee.rpc("get_flagged_games_summary");if(t)return{success:!1,error:t.message};const r=null==e?void 0:e[0];return r?{success:!0,data:{total_flagged:r.total_flagged,greenlight_count:r.greenlight_count,redlight_count:r.redlight_count,recent_flags_24h:r.recent_flags_24h,most_recent_flag:r.most_recent_flag}}:{success:!1,error:"No summary data returned"}}catch(e){return{success:!1,error:e.message}}})}searchGamesForFlagging(e,t=20){return I(this,null,function*(){try{const{data:r,error:n}=yield ee.from("game").select("\n          id,\n          name,\n          developer,\n          publisher,\n          category,\n          greenlight_flag,\n          redlight_flag,\n          flag_reason,\n          flagged_at,\n          total_rating,\n          rating_count,\n          follows,\n          popularity_score\n        ").ilike("name",`%${e}%`).order("total_rating",{ascending:!1,nullsLast:!0}).limit(t);return n?{success:!1,error:n.message}:{success:!0,data:r||[]}}catch(r){return{success:!1,error:r.message}}})}getConflictingFlags(){return I(this,null,function*(){try{const{data:e,error:t}=yield ee.from("game_flags_admin").select("*").eq("conflict_status","potential_conflict").order("flagged_at",{ascending:!1});return t?{success:!1,error:t.message}:{success:!0,data:e||[]}}catch(e){return{success:!1,error:e.message}}})}},tt=new class{analyzeGame(e,t){const r=[];let n=!0,i=!1;const s=this.checkAdminOverrides(e,r);if(s)return{wouldBeFiltered:"redlight"===s,wouldPass:"greenlight"===s,reasons:r,summary:"greenlight"===s?"Game manually approved by admin":"Game manually blocked by admin",adminOverride:s};i=this.checkQualityExemptions(e,r),this.checkCopyrightFiltering(e,t,r),this.checkCategoryFiltering(e,r),this.checkContentFiltering(e,r),this.checkNameFiltering(e,r),this.checkPublisherAuthorization(e,t,r);const a=r.filter(e=>"blocked"===e.severity||"filtered"===e.severity),o=i&&0===e.category;return n=0===a.length||o,{wouldBeFiltered:!n,wouldPass:n,reasons:r,summary:this.generateSummary(e,r,i,n),qualityExemption:i,adminOverride:null}}checkAdminOverrides(e,t){return e.greenlight_flag?(t.push({type:"publisher",severity:"passed",title:"\u2705 Admin Greenlight",description:"Game has been manually approved by an administrator",recommendation:"This game will always appear in search results"}),"greenlight"):e.redlight_flag?(t.push({type:"publisher",severity:"blocked",title:"\ud83d\udeab Admin Redlight",description:`Game has been manually blocked by an administrator: ${e.flag_reason||"No reason provided"}`,recommendation:"This game will never appear in search results"}),"redlight"):null}checkQualityExemptions(e,t){var r;const n=e.total_rating&&e.total_rating>70,i=e.rating_count&&e.rating_count>50,s=e.follows&&e.follows>1e3,a=n&&i;return!(!a&&!s||(t.push({type:"quality",severity:"passed",title:"\u2b50 Quality Exemption",description:`High-quality game: ${a?`${e.total_rating}\u2605 (${e.rating_count} reviews)`:""} ${s?`${null==(r=e.follows)?void 0:r.toLocaleString()} followers`:""}`,recommendation:"Quality games bypass most filtering rules"}),0))}checkCopyrightFiltering(e,t="",r){const n=[e.developer,e.publisher].filter(Boolean),i=this.detectFranchiseOwnership(e.name,t,"Nintendo"),s=this.detectFranchiseOwnership(e.name,t,"Capcom"),a=this.detectFranchiseOwnership(e.name,t,"Square Enix");i&&!n.some(e=>null==e?void 0:e.toLowerCase().includes("nintendo"))&&r.push({type:"copyright",severity:"warning",title:"\u26a0\ufe0f Nintendo Franchise Detected",description:"Game appears to be related to Nintendo franchises but not published by Nintendo",recommendation:"Verify if this is an official Nintendo release or authorized content"}),s&&!n.some(e=>null==e?void 0:e.toLowerCase().includes("capcom"))&&r.push({type:"copyright",severity:"warning",title:"\u26a0\ufe0f Capcom Franchise Detected",description:"Game appears to be related to Capcom franchises but not published by Capcom",recommendation:"Check if this is an official Capcom release"}),a&&!n.some(e=>null==e?void 0:e.toLowerCase().includes("square"))&&r.push({type:"copyright",severity:"warning",title:"\u26a0\ufe0f Square Enix Franchise Detected",description:"Game appears to be related to Square Enix franchises but not published by Square Enix",recommendation:"Verify official Square Enix release status"})}checkCategoryFiltering(e,t){const r={5:{title:"\ud83d\udeab Mod Content",description:"Game is categorized as a mod (IGDB Category 5)",severity:"blocked"},1:{title:"\ud83d\udce6 DLC Content",description:"Game is categorized as DLC/Add-on content",severity:"filtered"},3:{title:"\ud83d\udcda Bundle/Collection",description:"Game is categorized as a bundle or collection",severity:"filtered"},9:{title:"\u2728 Remaster",description:"Game is categorized as a remaster",severity:"filtered"},11:{title:"\ud83d\udd04 Port",description:"Game is categorized as a port",severity:"filtered"},13:{title:"\ud83d\udce6 Pack/Collection",description:"Game is categorized as a pack or collection",severity:"filtered"}};if(e.category&&r[e.category]){const n=r[e.category];t.push({type:"category",severity:n.severity,title:n.title,description:n.description,recommendation:"blocked"===n.severity?"Mods are completely blocked from search results":"This type of content is filtered to reduce clutter in search results"})}}checkContentFiltering(e,t){const r=P([e]).length>0,n=z([e]).length>0;r||t.push({type:"content",severity:"filtered",title:"\ud83d\udee1\ufe0f Content Protection Filter",description:"Game filtered by content protection rules (category, bundle, or port filtering)",recommendation:"Review game category and content type"}),n||t.push({type:"content",severity:"filtered",title:"\ud83c\udfae Fan Game Filter",description:"Game filtered by fan game and E-Reader content detection",recommendation:"Check if this is official content or fan-made"})}checkNameFiltering(e,t){const r=e.name.toLowerCase(),n=["mod","hack","rom hack","romhack","fan game","fangame","homebrew","unofficial"].filter(e=>r.includes(e)),i=["collection","compilation","anthology","bundle","trilogy"].filter(e=>r.includes(e));n.length>0&&t.push({type:"name",severity:"blocked",title:"\ud83d\udeab Mod Indicators in Name",description:`Game name contains mod indicators: ${n.join(", ")}`,recommendation:"Names with mod indicators are blocked to prevent unofficial content"}),i.length>0&&t.push({type:"name",severity:"filtered",title:"\ud83d\udcda Collection Indicators in Name",description:`Game name suggests it's a collection: ${i.join(", ")}`,recommendation:"Collections are filtered to reduce duplicate entries"})}checkPublisherAuthorization(e,t="",r){const n=this.getExpectedPublisher(e.name,t);n&&e.publisher&&!e.publisher.toLowerCase().includes(n.toLowerCase())&&r.push({type:"publisher",severity:"warning",title:"\u26a0\ufe0f Publisher Mismatch",description:`Expected publisher "${n}" but found "${e.publisher}"`,recommendation:"Verify this is an authorized release or licensing deal"})}detectFranchiseOwnership(e,t,r){const n=`${e} ${t}`.toLowerCase();return({Nintendo:["mario","zelda","pokemon","metroid","donkey kong","star fox","kirby"],Capcom:["resident evil","mega man","street fighter","monster hunter","devil may cry"],"Square Enix":["final fantasy","dragon quest","kingdom hearts","chrono trigger"]}[r]||[]).some(e=>n.includes(e))}getExpectedPublisher(e,t){const r=`${e} ${t}`.toLowerCase();return r.includes("mario")||r.includes("zelda")||r.includes("pokemon")?"Nintendo":r.includes("resident evil")||r.includes("mega man")?"Capcom":r.includes("final fantasy")||r.includes("kingdom hearts")?"Square Enix":null}generateSummary(e,t,r,n){if(n)return r?"\u2705 Game passes (quality exemption) - High-quality game bypasses filtering rules":"\u2705 Game passes all filters - Will appear in search results";const i=t.filter(e=>"blocked"===e.severity||"filtered"===e.severity);return 1===i.length?`\u274c Game filtered: ${i[0].title}`:`\u274c Game filtered by ${i.length} rules: ${i.map(e=>e.title).join(", ")}`}},rt=new class{getCompanyAnalysis(){return I(this,null,function*(){try{const{data:e,error:t}=yield ee.from("game").select("id, name, publisher, developer").not("publisher","is",null).not("developer","is",null);if(t)return{success:!1,error:t.message};if(!e)return{success:!1,error:"No games found"};const r=new Map,n=new Map;return e.forEach(e=>{if(e.publisher&&e.publisher.trim()&&"Unknown"!==e.publisher){const t=e.publisher.trim();r.has(t)||r.set(t,[]),r.get(t).push({id:e.id,name:e.name})}if(e.developer&&e.developer.trim()&&"Unknown"!==e.developer){const t=e.developer.trim();n.has(t)||n.set(t,[]),n.get(t).push({id:e.id,name:e.name})}}),{success:!0,data:{publishers:Array.from(r.entries()).map(([e,t])=>({company:e,gameCount:t.length,sampleGames:t.slice(0,5).map(e=>e.name),isPublisher:!0,isDeveloper:!1})).sort((e,t)=>t.gameCount-e.gameCount),developers:Array.from(n.entries()).map(([e,t])=>({company:e,gameCount:t.length,sampleGames:t.slice(0,5).map(e=>e.name),isPublisher:!1,isDeveloper:!0})).sort((e,t)=>t.gameCount-e.gameCount),totalCompanies:r.size+n.size,totalGames:e.length}}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}})}getCompanyGames(e,t,r=1e3){return I(this,null,function*(){try{const n="publisher"===t?"publisher":"developer",i=new Promise((e,t)=>{setTimeout(()=>t(new Error("Query timeout after 10 seconds")),1e4)}),s=ee.from("game").select("id, name, category, publisher, developer, greenlight_flag, redlight_flag").ilike(n,`%${e}%`).limit(r).order("id"),{data:a,error:o}=yield Promise.race([s,i]);return o?{success:!1,error:o.message}:{success:!0,data:a||[]}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Unknown error"}}})}getModGames(){return I(this,null,function*(){try{const{data:e,error:t}=yield ee.from("game").select("id, name, developer, publisher, greenlight_flag, redlight_flag").eq("category",5);return t?{success:!1,error:t.message}:{success:!0,data:e||[]}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}})}bulkFlag(e){return I(this,null,function*(){try{let r=[];if("company"===e.type){const t=e.target.match(/^(.+?)\s*\((Publisher|Developer)\)$/);if(!t)return{success:!1,processedCount:0,skippedCount:0,errorCount:0,affectedGames:[],error:'Invalid company format. Expected: "Company Name (Publisher)" or "Company Name (Developer)"'};const[,n,i]=t,s=yield this.getCompanyGames(n,i.toLowerCase());if(!s.success)return{success:!1,processedCount:0,skippedCount:0,errorCount:0,affectedGames:[],error:s.error};r=s.data||[]}else{if("mods"!==e.type)return{success:!1,processedCount:0,skippedCount:0,errorCount:0,affectedGames:[],error:"Unsupported request type"};{const e=yield this.getModGames();if(!e.success)return{success:!1,processedCount:0,skippedCount:0,errorCount:0,affectedGames:[],error:e.error};r=e.data||[]}}if(e.dryRun){const t=Math.min(20,r.length),n=r.slice(0,t).map(t=>({id:t.id,name:t.name,action:"clear"===e.flagType?"cleared":"flagged",reason:`[DRY RUN] Would ${e.flagType} - ${e.reason}`}));return r.length>t&&n.push({id:0,name:`... and ${r.length-t} more games`,action:"flagged",reason:`Total games that would be affected: ${r.length}`}),{success:!0,processedCount:0,skippedCount:0,errorCount:0,affectedGames:n}}const n=[];let i=0,s=0,a=0;const o=100,l=[];for(let e=0;e<r.length;e+=o)l.push(r.slice(e,e+o));for(let c=0;c<l.length;c++){const r=l[c];for(const s of r){try{const t="clear"===e.flagType?"clear":"redlight",r=yield et.setGameFlag(s.id,t,e.reason);r.success?(n.push({id:s.id,name:s.name,action:"clear"===e.flagType?"cleared":"flagged",reason:e.reason}),i++):(n.push({id:s.id,name:s.name,action:"error",reason:r.error}),a++)}catch(t){n.push({id:s.id,name:s.name,action:"error",reason:t instanceof Error?t.message:"Unknown error"}),a++}yield new Promise(e=>setTimeout(e,25))}c<l.length-1&&(yield new Promise(e=>setTimeout(e,2e3)))}return{success:!0,processedCount:i,skippedCount:s,errorCount:a,affectedGames:n}}catch(t){return{success:!1,processedCount:0,skippedCount:0,errorCount:0,affectedGames:[],error:t instanceof Error?t.message:"Unknown error"}}})}getFlagStatistics(){return I(this,null,function*(){try{const{data:e,error:t}=yield ee.from("game").select("id, category, greenlight_flag, redlight_flag");if(t)return{success:!1,error:t.message};if(!e)return{success:!1,error:"No games found"};let r=0,n=0,i=0,s=0,a=0;return e.forEach(e=>{e.greenlight_flag?n++:e.redlight_flag?r++:i++,5===e.category&&(s++,e.redlight_flag&&a++)}),{success:!0,data:{totalGames:e.length,redlightCount:r,greenlightCount:n,unflaggedCount:i,modGamesCount:s,redlightedModsCount:a}}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}})}},nt=new class{constructor(){D(this,"MAX_CONCURRENT_EXPERIMENTS",5),D(this,"MIN_SAMPLE_SIZE",100),D(this,"CONFIDENCE_LEVEL",.95),D(this,"cache",new Map)}initializeSession(e,t){return I(this,null,function*(){try{if(t&&!(yield $e.hasTrackingConsent(t)))return;const r=yield this.getActiveExperiments();for(const n of r)yield this.assignToExperiment(e,n,t)}catch(r){}})}getVariant(e,t){return I(this,null,function*(){try{const r=`${e}-${t}`,n=this.cache.get(r);if(n&&n.isActive){const e=yield this.getExperiment(t);return(null==e?void 0:e.variants.find(e=>e.id===n.variantId))||null}const{data:i}=yield ee.from("ab_test_assignments").select("variant_id, is_active").eq("session_id",e).eq("experiment_id",t).eq("is_active",!0).single();if(!i)return null;const s=yield this.getExperiment(t),a=null==s?void 0:s.variants.find(e=>e.id===i.variant_id);return a&&this.cache.set(r,{userId:null,sessionId:e,experimentId:t,variantId:i.variant_id,assignedAt:(new Date).toISOString(),isActive:i.is_active}),a||null}catch(r){return null}})}trackConversion(e,t,r,n){return I(this,null,function*(){try{const i=yield this.getAssignment(e,t);if(!i)return;yield ee.from("ab_test_conversions").insert({session_id:e,experiment_id:t,variant_id:i.variantId,event_type:r,event_value:n,recorded_at:(new Date).toISOString()}),yield We.trackEvent("ab_test_conversion",{experimentId:t,variantId:i.variantId,eventType:r,value:n})}catch(i){}})}createExperiment(e){return I(this,null,function*(){try{if(this.validateExperiment(e),(yield this.getActiveExperimentCount())>=this.MAX_CONCURRENT_EXPERIMENTS)throw new Error("Maximum concurrent experiments reached");const t=`exp_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return yield ee.from("ab_test_experiments").insert({id:t,name:e.name,description:e.description,status:e.status,start_date:e.startDate,end_date:e.endDate,target_percentage:e.targetPercentage,variants:e.variants,metadata:e.metadata,created_at:(new Date).toISOString()}),t}catch(t){throw t}})}getExperimentAnalytics(e){return I(this,null,function*(){try{const t=yield this.getExperiment(e);if(!t)return null;const{data:r}=yield ee.from("ab_test_assignments").select("variant_id, session_id").eq("experiment_id",e).eq("is_active",!0).limit(1e4),{data:n}=yield ee.from("ab_test_conversions").select("variant_id, event_type, event_value, session_id").eq("experiment_id",e).limit(5e4);if(!r||!n)return null;const i=[],s=r.length;for(const l of t.variants){const t=r.filter(e=>e.variant_id===l.id),s=n.filter(e=>e.variant_id===l.id),a=t.length,o=new Set(s.map(e=>e.session_id)).size,c=a>0?o/a:0,u=1.96*Math.sqrt(c*(1-c)/a);i.push({experimentId:e,variantId:l.id,metrics:{participants:a,conversions:o,conversionRate:c,averageSessionTime:0,bounceRate:0},significanceLevel:this.CONFIDENCE_LEVEL,confidenceInterval:{lower:Math.max(0,c-u),upper:Math.min(1,c+u)}})}const{status:a,winningVariant:o}=this.calculateSignificance(i);return{experimentId:e,totalParticipants:s,variantResults:i,status:a,winningVariant:o,statisticalPower:this.calculateStatisticalPower(i),duration:this.calculateExperimentDuration(t)}}catch(t){return null}})}getActiveExperiments(){return I(this,null,function*(){const{data:e}=yield ee.from("ab_test_experiments").select("*").eq("status","active").lte("start_date",(new Date).toISOString()).or("end_date.is.null,end_date.gte."+(new Date).toISOString()).limit(10);return e||[]})}getExperiment(e){return I(this,null,function*(){const{data:t}=yield ee.from("ab_test_experiments").select("*").eq("id",e).single();return t||null})}assignToExperiment(e,t,r){return I(this,null,function*(){if((yield ee.from("ab_test_assignments").select("id").eq("session_id",e).eq("experiment_id",t.id).single()).data)return;if(100*Math.random()>t.targetPercentage)return;const n=this.selectVariant(t.variants);yield ee.from("ab_test_assignments").insert({user_id:r||null,session_id:e,experiment_id:t.id,variant_id:n.id,assigned_at:(new Date).toISOString(),is_active:!0})})}selectVariant(e){const t=e.reduce((e,t)=>e+t.weight,0),r=Math.random()*t;let n=0;for(const i of e)if(n+=i.weight,n>=r)return i;return e[0]}getAssignment(e,t){return I(this,null,function*(){const{data:r}=yield ee.from("ab_test_assignments").select("*").eq("session_id",e).eq("experiment_id",t).eq("is_active",!0).single();return r?{userId:r.user_id,sessionId:r.session_id,experimentId:r.experiment_id,variantId:r.variant_id,assignedAt:r.assigned_at,isActive:r.is_active}:null})}validateExperiment(e){if(!e.name||!e.description)throw new Error("Experiment name and description are required");if(2>e.variants.length)throw new Error("At least 2 variants required");const t=e.variants.reduce((e,t)=>e+t.weight,0);if(Math.abs(t-100)>.01)throw new Error("Variant weights must sum to 100");if(1!==e.variants.filter(e=>e.isControl).length)throw new Error("Exactly one control variant required")}getActiveExperimentCount(){return I(this,null,function*(){const{count:e}=yield ee.from("ab_test_experiments").select("*",{count:"exact",head:!0}).eq("status","active");return e||0})}calculateSignificance(e){const t=e.find(e=>e.variantId.includes("control"));if(!t||2>e.length)return{status:"insufficient_data"};if(t.metrics.participants<this.MIN_SAMPLE_SIZE)return{status:"insufficient_data"};const r=e.filter(e=>!e.variantId.includes("control"));let n=t,i=!1;for(const s of r)s.metrics.participants<this.MIN_SAMPLE_SIZE||(s.confidenceInterval.lower>t.confidenceInterval.upper||t.confidenceInterval.lower>s.confidenceInterval.upper)&&s.metrics.conversionRate>n.metrics.conversionRate&&(n=s,i=!0);return{status:i?"significant_winner":"no_significant_difference",winningVariant:i?n.variantId:void 0}}calculateStatisticalPower(e){const t=e.find(e=>e.variantId.includes("control"));if(!t)return 0;const r=t.metrics.participants;return t.metrics.conversionRate,Math.min(1,r/(2*this.MIN_SAMPLE_SIZE))}calculateExperimentDuration(e){const t=new Date(e.startDate),r=e.endDate?new Date(e.endDate):new Date;return Math.ceil((r.getTime()-t.getTime())/864e5)}},it=class e{constructor(){D(this,"RETENTION_DAYS",90),D(this,"ANONYMIZATION_DAYS",30),D(this,"realTimeSubscription",null)}getPrivacyMetrics(t="7d"){return I(this,null,function*(){try{const r=e.TIME_RANGES.find(e=>e.value===t)||e.TIME_RANGES[0],n=yield this.getConsentMetrics(),i=yield this.getTrackingMetrics(r.days),s=yield this.getHistoricalData(r.days),a=yield this.getDataRetentionMetrics(),o=yield this.getEnhancedTopTrackedGames(10,r.days),l=yield this.getRecentPrivacyActions(5),c=yield this.getSystemHealthMetrics(),u=yield this.getABTestingMetrics(r.days);return{totalUsers:n.totalUsers,consentedUsers:n.consentedUsers,nonConsentedUsers:n.nonConsentedUsers,consentRate:n.consentRate,trackingLevels:n.trackingLevels,totalEvents:i.totalEvents,uniqueSessions:i.uniqueSessions,eventsToday:i.eventsToday,eventsThisWeek:i.eventsThisWeek,eventsThisMonth:i.eventsThisMonth,eventsBySource:i.eventsBySource,historicalData:s,timeRange:r.value,oldestDataPoint:a.oldestDataPoint,dataPointsOverRetention:a.dataPointsOverRetention,scheduledDeletions:a.scheduledDeletions,averageDataAge:a.averageDataAge,topGames:o,recentConsentChanges:l,apiRateLimit:c.apiRateLimit,storageUsage:c.storageUsage,errorRate:c.errorRate,abTestingMetrics:u}}catch(r){throw r}})}getConsentMetrics(){return I(this,null,function*(){const{data:e,error:t}=yield ee.from("user_preferences").select("analytics_opted_in, tracking_level");if(t)return{totalUsers:0,consentedUsers:0,nonConsentedUsers:0,consentRate:0,trackingLevels:{none:0,anonymous:0,full:0}};const r=(null==e?void 0:e.length)||0,n=(null==e?void 0:e.filter(e=>e.analytics_opted_in).length)||0;return{totalUsers:r,consentedUsers:n,nonConsentedUsers:r-n,consentRate:r>0?n/r*100:0,trackingLevels:{none:(null==e?void 0:e.filter(e=>"none"===e.tracking_level).length)||0,anonymous:(null==e?void 0:e.filter(e=>"anonymous"===e.tracking_level).length)||0,full:(null==e?void 0:e.filter(e=>"full"===e.tracking_level).length)||0}}})}getTrackingMetrics(e=30){return I(this,null,function*(){const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate()),r=new Date(t);r.setDate(r.getDate()-7);const n=new Date(t);n.setMonth(n.getMonth()-1);const{data:i}=yield ee.from("game_views").select("id, session_hash",{count:"exact"}),s=(null==i?void 0:i.length)||0,a=new Set(null==i?void 0:i.map(e=>e.session_hash)).size,{data:o}=yield ee.from("game_views").select("id").gte("created_at",t.toISOString()),{data:l}=yield ee.from("game_views").select("id").gte("created_at",r.toISOString()),{data:c}=yield ee.from("game_views").select("id").gte("created_at",n.toISOString()),{data:u}=yield ee.from("game_views").select("view_source"),d={search:0,direct:0,recommendation:0,list:0,review:0,profile:0};return null==u||u.forEach(e=>{e.view_source&&d.hasOwnProperty(e.view_source)&&d[e.view_source]++}),{totalEvents:s,uniqueSessions:a,eventsToday:(null==o?void 0:o.length)||0,eventsThisWeek:(null==l?void 0:l.length)||0,eventsThisMonth:(null==c?void 0:c.length)||0,eventsBySource:d}})}getDataRetentionMetrics(){return I(this,null,function*(){const e=new Date;e.setDate(e.getDate()-this.RETENTION_DAYS);const{data:t}=yield ee.from("game_views").select("created_at").order("created_at",{ascending:!0}).limit(1).single(),{data:r,count:n}=yield ee.from("game_views").select("id",{count:"exact",head:!0}).lt("created_at",e.toISOString()),{data:i}=yield ee.from("game_views").select("created_at");let s=0;if(i&&i.length>0){const e=Date.now(),t=i.reduce((t,r)=>t+(e-new Date(r.created_at).getTime()),0);s=Math.floor(t/i.length/864e5)}return{oldestDataPoint:(null==t?void 0:t.created_at)||null,dataPointsOverRetention:n||0,scheduledDeletions:n||0,averageDataAge:s}})}getTopTrackedGames(e=10){return I(this,null,function*(){const t=new Date,r=new Date(t.getFullYear(),t.getMonth(),t.getDate()),n=new Date(r);n.setDate(n.getDate()-7);const{data:i,error:s}=yield ee.from("game_views").select("game_id, session_hash, user_id, created_at").order("created_at",{ascending:!1}).limit(5e3);if(s)return[];const a=new Map;null==i||i.forEach(e=>{const t=a.get(e.game_id)||{views:0,sessions:new Set,users:new Set,viewsToday:0,viewsThisWeek:0,dailyViews:new Map};t.views++,e.session_hash&&t.sessions.add(e.session_hash),e.user_id&&t.users.add(e.user_id);const i=new Date(e.created_at),s=i.toISOString().split("T")[0];t.dailyViews.set(s,(t.dailyViews.get(s)||0)+1),r>i||t.viewsToday++,n>i||t.viewsThisWeek++,a.set(e.game_id,t)});const o=Array.from(a.entries()).sort((e,t)=>t[1].views-e[1].views).slice(0,e).map(([e])=>e),{data:l}=yield ee.from("game").select("id, name, slug, cover_url").in("id",o);return o.map(e=>{const t=a.get(e),r=null==l?void 0:l.find(t=>t.id===e),n=t.dailyViews.size>0?t.sessions.size/t.dailyViews.size:0;return{gameId:e,gameName:null==r?void 0:r.name,gameSlug:null==r?void 0:r.slug,gameCover:null==r?void 0:r.cover_url,views:t.views,uniqueSessions:t.sessions.size,rankingFactors:{totalViews:t.views,uniqueUsers:t.users.size,viewsToday:t.viewsToday,viewsThisWeek:t.viewsThisWeek,avgSessionsPerDay:Math.round(100*n)/100}}})})}getHistoricalData(e){return I(this,null,function*(){const t=new Date;t.setDate(t.getDate()-e);try{const{data:r}=yield ee.from("game_views").select("user_id, session_hash, created_at").gte("created_at",t.toISOString()).limit(1e4),{data:n}=yield ee.from("rating").select("user_id, created_at").gte("created_at",t.toISOString()).limit(5e3),i=new Map;null==r||r.forEach(e=>{const t=new Date(e.created_at).toISOString().split("T")[0],r=i.get(t)||{views:0,sessions:new Set,users:new Set,ratings:0};r.views++,e.session_hash&&r.sessions.add(e.session_hash),e.user_id&&r.users.add(e.user_id),i.set(t,r)}),null==n||n.forEach(e=>{const t=new Date(e.created_at).toISOString().split("T")[0],r=i.get(t)||{views:0,sessions:new Set,users:new Set,ratings:0};r.ratings++,i.set(t,r)});const s=[];for(let t=0;e>t;t++){const e=new Date;e.setDate(e.getDate()-t);const r=e.toISOString().split("T")[0],n=i.get(r);s.unshift({date:r,views:(null==n?void 0:n.views)||0,uniqueSessions:(null==n?void 0:n.sessions.size)||0,uniqueUsers:(null==n?void 0:n.users.size)||0,ratings:(null==n?void 0:n.ratings)||0,newReviews:(null==n?void 0:n.ratings)||0})}return s}catch(r){return[]}})}getEnhancedTopTrackedGames(e=10,t=7){return I(this,null,function*(){const r=new Date;r.setDate(r.getDate()-t);const n=new Date;n.setHours(0,0,0,0);const i=new Date(n);i.setDate(i.getDate()-7);try{const{data:t}=yield ee.from("game_views").select("game_id, session_hash, user_id, created_at").gte("created_at",r.toISOString()).order("created_at",{ascending:!1}).limit(8e3);if(!t)return[];const s=new Map;t.forEach(e=>{const t=s.get(e.game_id)||{views:0,sessions:new Set,users:new Set,viewsToday:0,viewsThisWeek:0,dailyViews:new Map};t.views++,e.session_hash&&t.sessions.add(e.session_hash),e.user_id&&t.users.add(e.user_id);const r=new Date(e.created_at),a=r.toISOString().split("T")[0];t.dailyViews.set(a,(t.dailyViews.get(a)||0)+1),n>r||t.viewsToday++,i>r||t.viewsThisWeek++,s.set(e.game_id,t)});const a=Array.from(s.entries()).sort((e,t)=>t[1].views-e[1].views).slice(0,e).map(([e])=>e);if(0===a.length)return[];const{data:o}=yield ee.from("game").select("id, name, slug, cover_url").in("id",a),{data:l}=yield ee.from("rating").select("game_id, score, created_at").in("game_id",a).gte("created_at",r.toISOString()).limit(2e3),c=new Map;return null==l||l.forEach(e=>{const t=c.get(e.game_id)||{total:0,count:0,recent:0};t.total+=e.score,t.count++;const r=new Date(e.created_at);i>r||t.recent++,c.set(e.game_id,t)}),a.map(e=>{const t=s.get(e),r=null==o?void 0:o.find(t=>t.id===e),n=c.get(e),i=t.dailyViews.size>0?t.sessions.size/t.dailyViews.size:0,a=n&&n.count>0?n.total/n.count:void 0,l=a?a/10*100:0,u=5*t.viewsToday+2*t.viewsThisWeek+t.views;return{gameId:e,gameName:null==r?void 0:r.name,gameSlug:null==r?void 0:r.slug,gameCover:null==r?void 0:r.cover_url,views:t.views,uniqueSessions:t.sessions.size,avgRating:a?Math.round(10*a)/10:void 0,totalRatings:(null==n?void 0:n.count)||0,recentRatings:(null==n?void 0:n.recent)||0,rankingFactors:{totalViews:t.views,uniqueUsers:t.users.size,viewsToday:t.viewsToday,viewsThisWeek:t.viewsThisWeek,avgSessionsPerDay:Math.round(100*i)/100,ratingScore:Math.round(10*l)/10,engagementScore:Math.round(10*u)/10}}})}catch(s){return[]}})}getRecentPrivacyActions(e=5){return I(this,null,function*(){const{data:t,error:r}=yield ee.from("privacy_audit_log").select("user_id, action, details, created_at").order("created_at",{ascending:!1}).limit(e);return r?[]:(null==t?void 0:t.map(e=>({userId:e.user_id,action:e.action,timestamp:e.created_at,details:e.details})))||[]})}getSystemHealthMetrics(){return I(this,null,function*(){const{data:e}=yield ee.from("game_views").select("id",{count:"exact",head:!0}),{data:t}=yield ee.from("user_preferences").select("user_id",{count:"exact",head:!0}),{data:r}=yield ee.from("privacy_audit_log").select("id",{count:"exact",head:!0}),n={gameViews:.1*(e||0),userPreferences:.05*(t||0),auditLogs:.2*(r||0),totalMB:0};n.totalMB=(n.gameViews+n.userPreferences+n.auditLogs)/1024;const i={current:Math.floor(800*Math.random())+200,limit:1e3,percentage:0};return i.percentage=i.current/i.limit*100,{apiRateLimit:i,storageUsage:n,errorRate:{last24h:0,last7d:0,failedEvents:0}}})}subscribeToRealTimeActivity(e){return I(this,null,function*(){const t=ee.channel("privacy-dashboard-views").on("postgres_changes",{event:"INSERT",schema:"public",table:"game_views"},t=>{e({timestamp:(new Date).toISOString(),type:"view",userId:t.new.user_id,sessionHash:t.new.session_hash,details:{gameId:t.new.game_id,source:t.new.view_source}})}).subscribe(),r=ee.channel("privacy-dashboard-prefs").on("postgres_changes",{event:"*",schema:"public",table:"user_preferences"},t=>{var r,n,i,s;e({timestamp:(new Date).toISOString(),type:"INSERT"===t.eventType?"consent":"preference_change",userId:(null==(r=t.new)?void 0:r.user_id)||(null==(n=t.old)?void 0:n.user_id),details:{trackingLevel:null==(i=t.new)?void 0:i.tracking_level,analyticsOptedIn:null==(s=t.new)?void 0:s.analytics_opted_in}})}).subscribe();return()=>{t.unsubscribe(),r.unsubscribe()}})}getDataRetentionPolicy(){return I(this,null,function*(){const e=new Date;return e.setDate(e.getDate()+1),{retentionDays:this.RETENTION_DAYS,anonymizationDays:this.ANONYMIZATION_DAYS,cleanupSchedule:"Daily at 2:00 AM UTC",lastCleanup:null,nextCleanup:e.toISOString()}})}getUserPrivacyData(e){return I(this,null,function*(){const[t,r,n]=yield Promise.all([ee.from("user_preferences").select("*").eq("user_id",e).single(),ee.from("game_views").select("id",{count:"exact",head:!0}).eq("user_id",e),ee.from("privacy_audit_log").select("*").eq("user_id",e).order("created_at",{ascending:!1}).limit(10)]);return{preferences:t.data,totalDataPoints:r.count||0,recentActions:n.data||[]}})}performDataCleanup(){return I(this,null,function*(){const e=[];let t=0,r=0;try{const n=new Date;n.setDate(n.getDate()-this.RETENTION_DAYS);const{count:i,error:s}=yield ee.from("game_views").delete({count:"exact"}).lt("created_at",n.toISOString());s?e.push(`Delete error: ${s.message}`):t=i||0;const a=new Date;a.setDate(a.getDate()-this.ANONYMIZATION_DAYS);const{count:o,error:l}=yield ee.from("game_views").update({user_id:null},{count:"exact"}).lt("created_at",a.toISOString()).not("user_id","is",null);l?e.push(`Anonymize error: ${l.message}`):r=o||0}catch(n){e.push(`Cleanup error: ${n}`)}return{deleted:t,anonymized:r,errors:e}})}exportPrivacyReport(){return I(this,null,function*(){return{metrics:yield this.getPrivacyMetrics(),policy:yield this.getDataRetentionPolicy(),timestamp:(new Date).toISOString()}})}getABTestingMetrics(e){return I(this,null,function*(){try{const r={experiments:10,assignments:1e3,conversions:2e3,activities:20},n=new Date;n.setDate(n.getDate()-e);const{data:i,error:s}=yield ee.from("ab_test_experiments").select("id, name, status, created_at, variants").eq("status","active").limit(r.experiments);if(s)return null;const a=(null==i?void 0:i.length)||0,{data:o,error:l}=yield ee.from("ab_test_assignments").select("experiment_id, session_id, user_id, assigned_at").gte("assigned_at",n.toISOString()).limit(r.assignments);if(l)return null;const c=(null==o?void 0:o.length)||0,u=(null==o?void 0:o.filter(e=>!e.user_id).length)||0,{data:d,error:h}=yield ee.from("ab_test_conversions").select("experiment_id, session_id, event_type, recorded_at").gte("recorded_at",n.toISOString()).limit(r.conversions);if(h)return null;const m=(null==d?void 0:d.length)||0,f=c>0?m/c*100:0,y=new Date;y.setDate(y.getDate()-7);const{data:g,error:_}=yield ee.from("ab_test_experiments").select("id").gte("created_at",y.toISOString()).limit(r.experiments),v=(null==g?void 0:g.length)||0,p=[];if(i)for(const e of i.slice(0,5))try{const t=yield nt.getExperimentAnalytics(e.id);t&&p.push({id:e.id,name:e.name,participants:t.totalParticipants,conversionRate:t.variantResults.length>0?t.variantResults.reduce((e,t)=>e+t.metrics.conversionRate,0)/t.variantResults.length:0,status:e.status,significanceLevel:t.statisticalPower})}catch(t){}const w=[];if(o){const e=o.slice(0,r.activities/2).map(e=>{var t;return{timestamp:e.assigned_at,type:"assignment",experimentId:e.experiment_id,experimentName:null==(t=null==i?void 0:i.find(t=>t.id===e.experiment_id))?void 0:t.name}});w.push(...e)}if(d){const e=d.slice(0,r.activities/2).map(e=>{var t;return{timestamp:e.recorded_at,type:"conversion",experimentId:e.experiment_id,experimentName:null==(t=null==i?void 0:i.find(t=>t.id===e.experiment_id))?void 0:t.name}});w.push(...e)}return w.sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime()),w.splice(r.activities),{activeExperiments:a,totalParticipants:c,totalConversions:m,experimentsThisWeek:v,averageConversionRate:Math.round(100*f)/100,topPerformingExperiments:p,recentActivity:w,privacyCompliance:{consentRespected:!0,anonymousParticipants:u,dataRetentionCompliant:!0}}}catch(r){return null}})}};D(it,"TIME_RANGES",[{label:"Last 7 Days",days:7,value:"7d"},{label:"Last 14 Days",days:14,value:"14d"},{label:"Last 30 Days",days:30,value:"30d"},{label:"Last 60 Days",days:60,value:"60d"},{label:"Last 90 Days",days:90,value:"90d"}]);const st=new it,at=new class{searchGames(){return I(this,arguments,function*(e={},t={}){const{query:r,releaseDateStart:n,releaseDateEnd:i,platformIds:s,minRating:a,maxRating:o,minRatingCount:l,genres:c,orderBy:u="relevance",orderDirection:d="desc"}=e,{limit:m=200,offset:f=0}=t;try{let e=[],t=0;if(r&&r.trim()){const n=Date.now();let i=[],s=!1;const a=ke.getCachedSearch(r.trim());a?(i=a,s=!0):(i=yield h(r.trim()),i&&i.length>0&&ke.setCachedSearch(r.trim(),i));const o=Date.now()-n;if(Ke.trackSearch(r.trim(),i,o,s).catch(e=>{}),!i||0>=i.length)return Ke.trackSearch(r.trim(),[],o,s),{games:[],totalCount:0,hasMore:!1};e=i,t=i.length}else{let r=ee.from("game").select("*",{count:"exact"});if(n&&(r=r.gte("release_date",n.toISOString().split("T")[0])),i&&(r=r.lte("release_date",i.toISOString().split("T")[0])),c&&c.length>0){const e=new Set;for(const t of c){const{data:r,error:n}=yield ee.rpc("search_games_by_genre",{genre_name:t,limit_count:1e3});n||r&&r.forEach(t=>e.add(t.id))}if(0>=e.size)return{games:[],totalCount:0,hasMore:!1};r=r.in("id",Array.from(e))}const{data:s,error:a,count:o}=yield r.range(f,f+m-1);if(a)return{games:[],totalCount:0,hasMore:!1};e=s||[],t=o||0}let s=e||[];return r&&r.trim()?"relevance"!==u&&(s=this.sortGames(s,u,d,r)):s=this.sortGames(s,u,d,r),{games:s.map(e=>({id:e.id,igdb_id:e.igdb_id,name:e.name,description:e.description,summary:e.summary,release_date:e.release_date,cover_url:e.cover_url,developer:e.developer||e.dev,publisher:e.publisher,genre:e.genre,genres:e.genres||(e.genre?[e.genre]:[]),platforms:e.platforms||[],igdb_rating:e.igdb_rating,metacritic_score:e.metacritic_score,avg_user_rating:e.avg_user_rating,user_rating_count:e.user_rating_count,screenshots:e.screenshots,total_rating:e.total_rating,total_rating_count:e.total_rating_count,rating_count:e.rating_count,follows:e.follows,hypes:e.hypes})).slice(f,f+m),totalCount:t,hasMore:t>f+m}}catch(y){return{games:[],totalCount:0,hasMore:!1}}})}sortGames(e,t,r,n){const i=[...e];switch(t){case"relevance":if(n){const e=n.toLowerCase();i.sort((t,n)=>{const i=t.name.toLowerCase()===e?1e3:0,s=n.name.toLowerCase()===e?1e3:0,a=t.name.toLowerCase().includes(e)?100:0,o=n.name.toLowerCase().includes(e)?100:0,l=t.summary&&t.summary.trim().length>0?50:0,c=n.summary&&n.summary.trim().length>0?50:0,u=i+a+l+(t.user_rating_count||0),d=s+o+c+(n.user_rating_count||0);return"desc"===r?d-u:u-d})}else i.sort((e,t)=>{const n=e.summary&&e.summary.trim().length>0?1e3:0,i=t.summary&&t.summary.trim().length>0?1e3:0,s=n+(e.user_rating_count||0),a=i+(t.user_rating_count||0)-s;return"desc"===r?a:-a});break;case"rating":i.sort((e,t)=>{const n=e.avg_user_rating||0,i=(t.avg_user_rating||0)-n;return"desc"===r?i:-i});break;case"rating_count":i.sort((e,t)=>{const n=(t.user_rating_count||0)-(e.user_rating_count||0);return"desc"===r?n:-n});break;case"release_date":i.sort((e,t)=>{const n=e.release_date?new Date(e.release_date).getTime():0,i=(t.release_date?new Date(t.release_date).getTime():0)-n;return"desc"===r?i:-i});break;case"name":i.sort((e,t)=>{const n=e.name.localeCompare(t.name);return"desc"===r?-n:n})}return i}sortGamesByTitleSimilarityAndPriority(e,t){return t&&t.trim()?[...e].sort((e,r)=>{const n=d(e.name,t),i=d(r.name,t),s=U(e),a=U(r);if(n>800&&i>800){if(s.categoryPriority!==a.categoryPriority)return a.categoryPriority-s.categoryPriority;if(n!==i)return i-n}else{if(n!==i)return i-n;if(s.categoryPriority!==a.categoryPriority)return a.categoryPriority-s.categoryPriority}if(s.score!==a.score)return a.score-s.score;const o=e.igdb_rating||e.rating||0,l=r.igdb_rating||r.rating||0;if(o!==l)return l-o;const c=(e.user_rating_count||0)+(e.follows||0)+(e.hypes||0),u=(r.user_rating_count||0)+(r.follows||0)+(r.hypes||0);return c!==u?u-c:e.name.localeCompare(r.name)}):$(e)}getPopularGames(e=20){return I(this,null,function*(){return(yield this.searchGames({orderBy:"rating_count",minRatingCount:1},{limit:e})).games})}getTopRatedGames(e=20,t=5){return I(this,null,function*(){return(yield this.searchGames({orderBy:"rating",minRatingCount:t},{limit:e})).games})}getRecentGames(e=20){return I(this,null,function*(){return(yield this.searchGames({orderBy:"release_date"},{limit:e})).games})}getGamesByPlatform(e,t=20){return I(this,null,function*(){return(yield this.searchGames({platformIds:[e]},{limit:t})).games})}getGamesByGenre(e,t=20){return I(this,null,function*(){return(yield this.searchGames({genres:[e]},{limit:t})).games})}warmCache(){return I(this,null,function*(){const e=["mario","zelda","pokemon","call of duty","minecraft"];try{for(const r of e)try{yield h(r),yield new Promise(e=>setTimeout(e,100))}catch(t){}}catch(t){}})}getCacheStats(){return ke.getCacheStats()}getPopularSearches(e=10){return ke.getPopularSearches(e)}clearCache(){ke.clearAllCache()}getPerformanceMetrics(e="day"){return I(this,null,function*(){return yield Ke.getSearchPerformanceMetrics(e)})}getTrendingSearches(e=10){return I(this,null,function*(){return yield Ke.getTrendingSearches(e)})}};"undefined"!=typeof window&&(ke.clearCache(),setTimeout(()=>{at.warmCache().catch(e=>{})},5e3));const ot=Object.freeze(Object.defineProperty({__proto__:null,gameSearchService:at},Symbol.toStringTag,{value:"Module"}));export{we as A,be as B,fe as C,ye as D,o as E,We as F,Re as G,qe as H,Fe as I,de as J,ze as K,Ve as L,c as M,me as N,Le as O,Oe as P,ue as Q,Te as R,oe as S,te as T,ee as a,Pe as b,ae as c,He as d,ce as e,je as f,Ee as g,ie as h,Ze as i,se as j,et as k,tt as l,rt as m,st as n,Ke as o,$e as p,at as q,le as r,ke as s,_e as t,ne as u,ve as v,De as w,Ie as x,Se as y,Ce as z};
